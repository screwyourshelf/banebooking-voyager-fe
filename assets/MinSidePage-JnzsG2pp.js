import{r,j as e}from"./shadcn-CWEYZx5G.js";import{t as g,f as y,u as U,B as N,d as G,S as I,L as C}from"./index-BDeAeLEl.js";import{b as P}from"./booking-B8XyZ5Vy.js";import{f as A,T as _,a as z,b as L,c as D,d as J,e as w}from"./index-Dv6swHcW.js";import{T as W,a as X,b as V,c as B}from"./tabs-Dqp_WbTP.js";import{C as M,a as $}from"./card-CTFWEFxK.js";import{F as q}from"./FormField-Byr9fnzX.js";import{F as v}from"./FieldWrapper-DYoaUJQI.js";import{A as Q,a as Y,b as Z,c as ee,d as te,e as se,f as ne,g as ae,h as re}from"./alert-dialog-Dog8a905.js";import"./react-D5d5vywP.js";import"./lucide-BJMfYTUr.js";function ie(s,n=!1){const[i,c]=r.useState([]),[t,d]=r.useState(!0),[k,x]=r.useState(null),h=r.useCallback(async()=>{if(s)try{d(!0),x(null);const u=await P(s,n);c(u)}catch(u){const m=u instanceof Error?u.message:"Ukjent feil ved henting";x(m),g.error(m)}finally{d(!1)}},[s,n]);return r.useEffect(()=>{h()},[h]),{bookinger:i,laster:t,error:k,refetch:h}}async function le(s){const n=await y(`/api/klubb/${s}/bruker/meg/egen-data`,{method:"GET"},!0);if(!n.ok){const d=await n.text();throw new Error(d||"Kunne ikke hente egen data")}const i=await n.blob(),c=window.URL.createObjectURL(i),t=document.createElement("a");t.href=c,t.download=`banebooking-data-${new Date().toISOString().slice(0,10)}.json`,document.body.appendChild(t),t.click(),t.remove(),window.URL.revokeObjectURL(c)}async function oe(s){const n=await y(`/api/klubb/${s}/bruker/meg`,{method:"GET"},!0);if(!n.ok){const i=await n.text();throw new Error(i||"Kunne ikke hente meg")}return await n.json()}async function ce(s,n){const i=await y(`/api/klubb/${s}/bruker/meg`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)},!0);if(!i.ok){const c=await i.text();throw new Error(c||"Kunne ikke oppdatere visningsnavn")}}async function de(s){const n=await y(`/api/klubb/${s}/bruker/meg`,{method:"DELETE"},!0);if(!n.ok){const i=await n.text();throw new Error(i||"Kunne ikke slette brukeren")}}function ue(s){const[n,i]=r.useState(null),[c,t]=r.useState(!0),[d,k]=r.useState(null),x=r.useCallback(async()=>{if(s)try{await le(s),g.success("Dataen din lastes nå ned")}catch(o){const l=o instanceof Error?o.message:"Kunne ikke laste ned data";g.error(l)}},[s]),h=r.useCallback(async()=>{if(s){t(!0);try{const o=await oe(s);i(o),k(null)}catch(o){const l=o instanceof Error?o.message:"Ukjent feil ved henting";k(l),g.error(l),i(null)}finally{t(!1)}}},[s]),u=r.useCallback(async o=>{if(!(!n||!s))try{await ce(s,{visningsnavn:o}),i({...n,visningsnavn:o}),g.success("Visningsnavn lagret")}catch(l){const p=l instanceof Error?l.message:"Kunne ikke lagre visningsnavn";g.error(p)}},[s,n]),m=r.useCallback(async()=>{if(s)try{await de(s),i(null),g.success("Brukeren er slettet")}catch(o){const l=o instanceof Error?o.message:"Kunne ikke slette bruker";g.error(l)}},[s]);return r.useEffect(()=>{h()},[h]),{bruker:n,laster:c,feil:d,oppdaterVisningsnavn:u,refetch:h,slettMeg:m,lastNedEgenData:x}}function ge({slettMeg:s}){const{signOut:n}=U(),[i,c]=r.useState(!1),[t,d]=r.useState(!1),k=async()=>{d(!0);try{await s(),g.success("Brukeren er slettet"),c(!1),await n()}catch{g.error("Noe gikk galt ved sletting")}finally{d(!1)}};return e.jsxs(Q,{open:i,onOpenChange:c,children:[e.jsx(Y,{asChild:!0,children:e.jsx(N,{variant:"destructive",children:"Slett min bruker"})}),e.jsxs(Z,{children:[e.jsxs(ee,{children:[e.jsx(te,{children:"Er du sikker?"}),e.jsx(se,{children:"Dette vil slette din bruker og all tilknytning permanent. Denne handlingen kan ikke angres."})]}),e.jsxs(ne,{children:[e.jsx(ae,{disabled:t,children:"Avbryt"}),e.jsx(re,{className:"bg-red-600 hover:bg-red-700 focus:ring-red-600",onClick:k,disabled:t,children:t?"Sletter...":"Slett bruker"})]})]})]})}const E=50,ke=/^[\p{L}\d\s.@'_%+-]{2,}$/u;function Ee(){const{slug:s}=G(),n=r.useContext(I)??s,[i,c]=r.useState("profil"),{bruker:t,laster:d,oppdaterVisningsnavn:k,slettMeg:x,lastNedEgenData:h}=ue(n),[u,m]=r.useState(""),[o,l]=r.useState(null),[p,F]=r.useState(!1),{bookinger:T,laster:O}=ie(n,p),[f,j]=r.useState(!1);r.useEffect(()=>{var a;if(t){const b=(a=t.visningsnavn)==null?void 0:a.trim();!b||b===t.epost?(j(!0),m("")):(m(b),j(!1))}},[t]);const K=()=>{if(!t)return;if(f){l(null),k(t.epost);return}const a=u.trim();if(a.length===0){l("Visningsnavn kan ikke være tomt.");return}if(a.length<3){l("Visningsnavn må være minst 3 tegn.");return}if(!ke.test(a)){l("Visningsnavn inneholder ugyldige tegn.");return}if(a.length>E){l(`Visningsnavn kan ikke være lengre enn ${E} tegn.`);return}l(null),k(a)},R=t?f?t.visningsnavn!==t.epost:u.trim()!==t.visningsnavn:!1,H=new Date,S=p?T:T.filter(a=>new Date(a.dato)>=H);return e.jsx("div",{className:"max-w-screen-md mx-auto px-2 py-4",children:e.jsxs(W,{value:i,onValueChange:c,children:[e.jsxs(X,{className:"mb-4",children:[e.jsx(V,{value:"profil",children:"Min profil"}),e.jsx(V,{value:"bookinger",children:"Mine bookinger"})]}),e.jsx(B,{value:"profil",children:e.jsx(M,{children:e.jsx($,{className:"p-4 space-y-6",children:d||!t?e.jsx(C,{}):e.jsxs(e.Fragment,{children:[e.jsxs("form",{className:"space-y-4",onSubmit:a=>{a.preventDefault(),K()},children:[e.jsx(q,{id:"visningsnavn",label:"Visningsnavn",value:f?"":u,maxLength:E,placeholder:(t==null?void 0:t.epost)||"f.eks. Ola Nordmann",onChange:a=>{m(a.target.value),j(!1)},disabled:f,error:o,helpText:"Navnet vises i grensesnittet, og settes automatisk til e-post ved første innlogging. Du kan endre det her. Eller velg å bruke e-post i stedet."}),e.jsxs("label",{className:"flex items-center space-x-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:f,onChange:a=>{j(a.target.checked),a.target.checked&&m("")}}),e.jsx("span",{children:"Bruk e-post som visningsnavn"})]}),e.jsx(N,{type:"submit",size:"sm",disabled:!R,children:"Lagre"})]}),e.jsxs("div",{className:"pt-4 border-t mt-4 space-y-4",children:[e.jsx(v,{id:"epost",label:"Brukernavn / ID",children:e.jsx("p",{className:"text-sm text-foreground",children:t.epost})}),e.jsx(v,{id:"rolle",label:"Rolle (i klubben)",helpText:"Roller tildeles av klubbens administrator og kan ikke endres manuelt.",children:e.jsx("p",{className:"text-sm text-foreground",children:t.roller.join(", ")})})]}),e.jsxs("div",{className:"pt-4 border-t mt-4 space-y-4",children:[e.jsxs(v,{id:"vilkaar",label:"Vilkår for bruk",helpText:"Du aksepterer vilkårene automatisk ved første innlogging.",children:[t.vilkaarAkseptertDato?e.jsxs("p",{className:"text-sm text-foreground",children:["Akseptert ",A(t.vilkaarAkseptertDato)," ",t.vilkaarVersjon&&`(versjon ${t.vilkaarVersjon})`]}):e.jsx("p",{className:"text-sm text-muted-foreground italic",children:"Ikke registrert"}),e.jsx("p",{className:"text-sm mt-1",children:e.jsx("a",{href:`/banebooking-voyager-fe/${n}/vilkaar`,className:"underline text-primary hover:text-primary/80",children:"Les vilkårene"})})]}),e.jsx(v,{id:"last-ned-data",label:"Last ned dine data",helpText:"Du kan laste ned alle registrerte opplysninger og bookinger i JSON-format.",children:e.jsx(N,{onClick:h,size:"sm",variant:"outline",children:"Last ned data"})}),e.jsx(v,{id:"slett-bruker",label:"Slett bruker",helpText:"Dette sletter brukeren din og all tilknyttet data permanent. Dette kan ikke angres.",children:e.jsx(ge,{slettMeg:x})})]})]})})})}),e.jsx(B,{value:"bookinger",children:e.jsx(M,{children:e.jsx($,{className:"p-4 space-y-4",children:O?e.jsx(C,{}):e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"flex items-center space-x-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:p,onChange:a=>{F(a.target.checked)}}),e.jsx("span",{children:"Vis også tidligere bookinger"})]}),S.length===0?e.jsx("p",{className:"text-sm text-muted-foreground italic",children:p?"Du har ingen registrerte bookinger.":"Du har ingen kommende bookinger."}):e.jsx("div",{className:"overflow-auto max-h-[60vh] border-b border-x rounded-b-md",children:e.jsxs(_,{className:"text-sm",children:[e.jsx(z,{children:e.jsxs(L,{children:[e.jsx(D,{children:"Dato"}),e.jsx(D,{children:"Tid"}),e.jsx(D,{children:"Bane"})]})}),e.jsx(J,{children:S.map((a,b)=>e.jsxs(L,{children:[e.jsx(w,{children:A(a.dato)}),e.jsxs(w,{children:[a.startTid,"–",a.sluttTid]}),e.jsx(w,{children:a.baneNavn})]},b))})]})})]})})})})]})})}export{Ee as default};
