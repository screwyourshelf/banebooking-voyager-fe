import{j as t,r as f}from"./shadcn-mOdBhBu9.js";import{f as j,D as S}from"./DatoVelger-C0u8nsI9.js";import{B}from"./BookingSlotItem-Bql7-nYg.js";import{L as T,u as Q,a as M,t as b,b as y,c as A,d as E,B as $}from"./index-DACapAhf.js";import{u as L}from"./useBaner-DgsCLYux.js";import{u as D}from"./useSlug-DMGJr7eH.js";import{P as I}from"./Page-pTszYvfk.js";import{S as C}from"./SimpleTabsLazy-Cmj-F3Ld.js";import{D as N,a as K,b as w,c as O,d as R,e as V}from"./dialog-B_iTf-mM.js";import{a as q}from"./lucide-ByENZzyU.js";import"./react-RGnvvjkK.js";import"./checkbox-CS2usIo5.js";import"./index-Bb2dXpgu.js";import"./index-BRMy6Ggk.js";function P({slots:i,currentUser:o,onBook:u,onCancel:s,onDelete:c,apenSlotTid:l,setApenSlotTid:a,isLoading:d=!1}){return d?t.jsx(T,{}):i.length===0?t.jsx("div",{className:"text-muted text-sm italic py-4 text-center",children:"Ingen bookinger eller slots � vise."}):t.jsx("div",{className:"space-y-2",children:i.map(m=>{const k=`${m.dato}-${m.startTid}-${m.baneId}`;return t.jsx(B,{slot:m,currentUser:o,onBook:u,onCancel:s,onDelete:c,isOpen:l===k,onToggle:()=>a?.(l===k?null:k)},k)})})}function _(i,o,u){const s=Q(),[c,l]=f.useState(null),a=["bookinger",i??"",u??"",o??""],d=M(a,`/klubb/${i}/bookinger?baneId=${u}&dato=${o}`,{requireAuth:!0,enabled:!!i&&!!u&&!!o,staleTime:0,refetchInterval:3e4,refetchOnWindowFocus:!0,refetchIntervalInBackground:!1,placeholderData:[]}),m=f.useRef(!1);f.useEffect(()=>{if(!d.error){m.current=!1;return}m.current||(b.error(d.error.message??"Kunne ikke hente bookinger"),m.current=!0)},[d.error]);const k=()=>{s.invalidateQueries({queryKey:a}),s.invalidateQueries({queryKey:["mineBookinger",i]})},v=(e,n)=>e.startTid===n.startTid&&e.sluttTid===n.sluttTid,p=y("post",`/klubb/${i}/bookinger`,{onMutate:async e=>{await s.cancelQueries({queryKey:a});const n=s.getQueryData(a);return s.setQueryData(a,(r=[])=>r.map(g=>v(g,e)?{...g,booketAv:"Du",erEier:!0,kanBookes:!1,kanAvbestille:!0}:g)),{previous:n}},onError:(e,n,r)=>{r?.previous&&s.setQueryData(a,r.previous),b.error(e.message??"Kunne ikke booke.")},onSuccess:(e,n)=>{const r=`${n.startTid.slice(0,2)}-${n.sluttTid.slice(0,2)}`;b.success(`Booket ${r}`)},onSettled:()=>{k()}}),h=y("delete",`/klubb/${i}/bookinger`,{onMutate:async e=>{await s.cancelQueries({queryKey:a});const n=s.getQueryData(a);return s.setQueryData(a,(r=[])=>r.map(g=>v(g,e)?{...g,booketAv:null,erEier:!1,kanBookes:!0,kanAvbestille:!1,kanSlette:!1}:g)),{previous:n}},onError:(e,n,r)=>{r?.previous&&s.setQueryData(a,r.previous),b.error(e.message??"Kunne ikke avbestille.")},onSuccess:()=>{b.info("Bookingen er avbestilt.")},onSettled:()=>{k()}}),x=y("delete",`/klubb/${i}/bookinger/admin`,{onMutate:async e=>{await s.cancelQueries({queryKey:a});const n=s.getQueryData(a);return s.setQueryData(a,(r=[])=>r.map(g=>v(g,e)?{...g,booketAv:null,erEier:!1,kanBookes:!0,kanAvbestille:!1,kanSlette:!1}:g)),{previous:n}},onError:(e,n,r)=>{r?.previous&&s.setQueryData(a,r.previous),b.error(e.message??"Kunne ikke slette booking.")},onSuccess:()=>{b.success("Booking slettet"),l(null)},onSettled:()=>{k()}});return{slots:d.data??[],isLoading:d.isLoading,apenSlotTid:c,setApenSlotTid:l,onBook:e=>p.mutate({baneId:u,dato:o,startTid:e.startTid,sluttTid:e.sluttTid}),onCancel:e=>h.mutate({baneId:u,dato:o,startTid:e.startTid,sluttTid:e.sluttTid}),onDelete:e=>x.mutate({baneId:e.baneId??u,dato:e.dato??o,startTid:e.startTid,sluttTid:e.sluttTid}),hentBookinger:d.refetch}}function z({children:i}){const o=D(),{data:u,isLoading:s}=A(o);if(s||!u)return null;const{bookingRegel:c}=u;return t.jsxs(N,{children:[t.jsx(K,{asChild:!0,children:i}),t.jsxs(w,{children:[t.jsxs(O,{children:[t.jsx(R,{children:"Bookingregler"}),t.jsx(V,{className:"sr-only",children:"Oversikt over bookingreglene i klubben"})]}),t.jsx("div",{className:"space-y-4",children:t.jsxs("ul",{className:"list-disc list-inside text-sm",children:[t.jsxs("li",{children:["Maks ",c.maksPerDag," bookinger per dag"]}),t.jsxs("li",{children:["Maks ",c.maksTotalt," aktive bookinger totalt"]}),t.jsxs("li",{children:["Opptil ",c.dagerFremITid," dager frem i tid"]}),t.jsxs("li",{children:[c.slotLengdeMinutter," minutter per booking"]}),t.jsxs("li",{children:["Tillatt mellom ",c.aapningstid,"–",c.stengetid]})]})})]})]})}function ne(){const i=D(),{baner:o,isLoading:u}=L(i,!1),[s,c]=f.useState(""),[l,a]=f.useState(new Date),{currentUser:d}=E(),m=f.useMemo(()=>l?j(l,"yyyy-MM-dd"):"",[l]),{slots:k,apenSlotTid:v,setApenSlotTid:p,onBook:h,onCancel:x,onDelete:e,isLoading:n}=_(i,m,s);return f.useEffect(()=>{!s&&o.length>0&&c(o[0].id)},[o,s]),f.useEffect(()=>{p(null)},[l,s,p]),f.useEffect(()=>{d||p(null)},[d,p]),f.useEffect(()=>{l&&localStorage.setItem("valgtDato",l.toISOString())},[l]),u||!s?t.jsx(T,{}):t.jsxs(I,{children:[t.jsxs("div",{className:"flex justify-between items-center mb-2",children:[t.jsx(z,{children:t.jsx($,{variant:"ghost",size:"icon",className:"rounded-full",title:"Vis banereglement",children:t.jsx(q,{className:"w-5 h-5"})})}),t.jsx(S,{value:l,onChange:r=>a(r??null),visNavigering:!0})]}),t.jsx(C,{items:o.map(r=>({value:r.id,label:r.navn,content:t.jsx(P,{slots:k,currentUser:d?{epost:d.email??""}:null,apenSlotTid:v,setApenSlotTid:p,onBook:h,onCancel:x,onDelete:e,isLoading:n})})),value:s,onValueChange:c})]})}export{ne as default};
