import{r as m,j as e}from"./shadcn-DDUjAgUv.js";import{u as V}from"./useSlug-DpUlJmZk.js";import{P as C}from"./Page-Cq3gZojq.js";import{S as P}from"./SimpleTabsLazy-BzupnWrf.js";import{h as p,u as B,d as w,e as y,t as g,L as v,B as j,g as K,i as F}from"./index-C5bRu15K.js";import{F as M,a as h}from"./FormField-CSCBCces.js";import{P as T}from"./PageSection-CrgFjiMc.js";import{A as O,a as R,b as $,c as q,d as H,e as U,f as G,g as Q,h as _}from"./alert-dialog-BB1lr-_s.js";import{f as E}from"./datoUtils-Bzity_GL.js";import{T as z,a as I,b as D,c as x,d as J,e as b}from"./table-Cf8nNQMp.js";import{b as W}from"./booking--lc3vE4_.js";import"./react-RGnvvjkK.js";import"./lucide-Bc72fHhV.js";import"./index-CZuuFr9-.js";async function X(t){const n=await p(`/api/klubb/${t}/bruker/meg`,{method:"GET"},!0);if(!n.ok)throw new Error(await n.text()||"Kunne ikke hente meg");return await n.json()}async function Y(t,n){const r=await p(`/api/klubb/${t}/bruker/meg`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)},!0);if(!r.ok)throw new Error(await r.text()||"Kunne ikke oppdatere visningsnavn")}async function Z(t){const n=await p(`/api/klubb/${t}/bruker/meg/egen-data`,{method:"GET"},!0);if(!n.ok)throw new Error(await n.text()||"Kunne ikke hente egen data");const r=await n.blob(),l=window.URL.createObjectURL(r),s=document.createElement("a");s.href=l,s.download=`banebooking-data-${new Date().toISOString().slice(0,10)}.json`,document.body.appendChild(s),s.click(),s.remove(),window.URL.revokeObjectURL(l)}async function ee(t){const n=await p(`/api/klubb/${t}/bruker/meg`,{method:"DELETE"},!0);if(!n.ok)throw new Error(await n.text()||"Kunne ikke slette brukeren")}function S(t){const n=B(),{data:r,isLoading:l,error:s,refetch:c}=w({queryKey:["meg",t],queryFn:()=>X(t),enabled:!!t,staleTime:6e4,onError:a=>{g.error(a.message??"Kunne ikke hente brukerinfo")}}),o=y({mutationFn:a=>Y(t,{visningsnavn:a}),onSuccess:()=>{g.success("Visningsnavn oppdatert"),n.invalidateQueries({queryKey:["meg",t]})},onError:a=>{g.error(a instanceof Error?a.message:"Kunne ikke oppdatere visningsnavn")}}),d=async()=>{try{await Z(t),g.success("Data lastet ned")}catch(a){g.error(a instanceof Error?a.message:"Kunne ikke laste ned data")}},u=y({mutationFn:()=>ee(t),onSuccess:()=>{g.success("Brukeren er slettet"),n.removeQueries({queryKey:["meg",t]})},onError:a=>{g.error(a instanceof Error?a.message:"Kunne ikke slette bruker")}});return{bruker:r,laster:l,error:s,refetch:c,oppdaterVisningsnavn:o,lastNedEgenData:d,slettMeg:u.mutate}}const f=50,ne=/^[\p{L}\d\s.@'_%+-]{2,}$/u;function te({slug:t}){const{bruker:n,laster:r,oppdaterVisningsnavn:l}=S(t),{mutateAsync:s,isPending:c}=l,[o,d]=m.useState(""),[u,a]=m.useState(!1),[N,k]=m.useState(null);m.useEffect(()=>{if(n){const i=n.visningsnavn?.trim();!i||i===n.epost?(a(!0),d("")):(d(i),a(!1))}},[n]);const A=async()=>{if(!n)return;if(u){k(null),await s(n.epost);return}const i=o.trim();if(i.length===0){k("Visningsnavn kan ikke være tomt.");return}if(i.length<3){k("Visningsnavn må være minst 3 tegn.");return}if(!ne.test(i)){k("Visningsnavn inneholder ugyldige tegn.");return}if(i.length>f){k(`Visningsnavn kan ikke være lengre enn ${f} tegn.`);return}k(null),await s(i)},L=n?u?n.visningsnavn!==n.epost:o.trim()!==n.visningsnavn:!1;return r||!n?e.jsx(v,{}):e.jsxs(e.Fragment,{children:[e.jsxs("form",{className:"space-y-4",onSubmit:i=>{i.preventDefault(),A()},children:[e.jsx(M,{id:"visningsnavn",label:"Visningsnavn",value:u?"":o,maxLength:f,placeholder:n?.epost||"f.eks. Ola Nordmann",onChange:i=>{d(i.target.value),a(!1)},disabled:u,error:N,helpText:"Navnet vises i grensesnittet, og settes automatisk til e-post ved første innlogging."}),e.jsxs("label",{className:"flex items-center space-x-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:u,onChange:i=>{a(i.target.checked),i.target.checked&&d("")}}),e.jsx("span",{children:"Bruk e-post som visningsnavn"})]}),e.jsx(j,{type:"submit",size:"sm",disabled:!L||c,children:c?"Lagrer...":"Lagre"})]}),e.jsxs(T,{bordered:!0,className:"space-y-4",children:[e.jsx(h,{id:"epost",label:"Brukernavn / ID",children:e.jsx("p",{className:"text-sm text-foreground",children:n.epost})}),e.jsx(h,{id:"rolle",label:"Rolle (i klubben)",helpText:"Roller tildeles av klubbens administrator og kan ikke endres manuelt.",children:e.jsx("p",{className:"text-sm text-foreground",children:n.roller.join(", ")})})]})]})}function re({slettMeg:t}){const{signOut:n}=K(),[r,l]=m.useState(!1),s=async()=>{try{await t.mutateAsync(),l(!1),await n()}catch{}};return e.jsxs(O,{open:r,onOpenChange:l,children:[e.jsx(R,{asChild:!0,children:e.jsx(j,{variant:"destructive",disabled:t.isPending,children:t.isPending?"Sletter...":"Slett min bruker"})}),e.jsxs($,{children:[e.jsxs(q,{children:[e.jsx(H,{children:"Er du sikker?"}),e.jsx(U,{children:"Dette vil slette din bruker og all tilknytning permanent. Denne handlingen kan ikke angres."})]}),e.jsxs(G,{children:[e.jsx(Q,{disabled:t.isPending,children:"Avbryt"}),e.jsx(_,{variant:"destructive",onClick:s,disabled:t.isPending,children:t.isPending?"Sletter...":"Slett bruker"})]})]})]})}function se({slug:t}){const{bruker:n,laster:r,lastNedEgenData:l,slettMeg:s}=S(t),{isPending:c}=s;return r||!n?e.jsx(v,{}):e.jsxs(T,{bordered:!0,className:"space-y-4",children:[e.jsxs(h,{id:"vilkaar",label:"Vilkår for bruk",helpText:"Du aksepterer vilkårene automatisk ved første innlogging.",children:[n.vilkaarAkseptertDato?e.jsxs("p",{className:"text-sm text-foreground",children:["Akseptert ",E(n.vilkaarAkseptertDato)," ",n.vilkaarVersjon&&`(versjon ${n.vilkaarVersjon})`]}):e.jsx("p",{className:"text-sm text-muted-foreground italic",children:"Ikke registrert"}),e.jsx("p",{className:"text-sm mt-1",children:e.jsx(F,{to:`/${t}/vilkaar`,className:"underline text-primary hover:text-primary/80",target:"_blank",rel:"noopener noreferrer",children:"Les vilkårene"})})]}),e.jsx(h,{id:"last-ned-data",label:"Last ned dine data",helpText:"Du kan laste ned alle registrerte opplysninger og bookinger i JSON-format.",children:e.jsx(j,{onClick:l,size:"sm",variant:"outline",disabled:c,children:c?"Laster ned...":"Last ned data"})}),e.jsx(h,{id:"slett-bruker",label:"Slett bruker",helpText:"Dette sletter brukeren din og all tilknyttet data permanent.",children:e.jsx(re,{slettMeg:s})})]})}function ae(t,n=!1){return w({queryKey:["mineBookinger",t,n],queryFn:async()=>t?await W(t,n):[],enabled:!!t,staleTime:6e4,onError:r=>g.error(r.message??"Ukjent feil ved henting av bookinger")})}function ie({slug:t}){const[n,r]=m.useState(!1),{data:l=[],isLoading:s}=ae(t,n),c=[...l].sort((o,d)=>{const u=new Date(d.dato).getTime()-new Date(o.dato).getTime();return u!==0?u:d.startTid.localeCompare(o.startTid)});return s?e.jsx(v,{}):e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"flex items-center space-x-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:n,onChange:o=>r(o.target.checked)}),e.jsx("span",{children:"Vis også tidligere bookinger"})]}),c.length===0?e.jsx("p",{className:"text-sm text-muted-foreground italic",children:n?"Du har ingen registrerte bookinger.":"Du har ingen kommende bookinger."}):e.jsx("div",{className:"overflow-auto max-h-[60vh] border rounded-md",children:e.jsxs(z,{className:"text-sm",children:[e.jsx(I,{children:e.jsxs(D,{children:[e.jsx(x,{children:"Dato"}),e.jsx(x,{children:"Tid"}),e.jsx(x,{children:"Bane"})]})}),e.jsx(J,{children:c.map((o,d)=>e.jsxs(D,{children:[e.jsx(b,{children:E(o.dato)}),e.jsxs(b,{children:[o.startTid,"–",o.sluttTid]}),e.jsx(b,{children:o.baneNavn})]},d))})]})})]})}function je(){const[t,n]=m.useState("bookinger"),r=V();return e.jsx(C,{children:e.jsx(P,{items:[{value:"bookinger",label:"Mine bookinger",content:e.jsx(ie,{slug:r})},{value:"profil",label:"Min profil",content:e.jsx(te,{slug:r})},{value:"persondata",label:"Persondata",content:e.jsx(se,{slug:r})}],value:t,onValueChange:n})})}export{je as default};
