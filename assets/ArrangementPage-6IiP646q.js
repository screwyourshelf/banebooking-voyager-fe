import{r as g,j as e}from"./shadcn-CGWS6Fka.js";import{P as ee}from"./Page-BqGewD4P.js";import{s as te,h as ne,u as se,a as ae,d as re,c as ie,t as Q,f as oe,B as L,F as le,i as z,I as de,l as ge,m as ce,L as ue}from"./index-puGzu8-1.js";import{u as he}from"./useBaner-Cdz-fTbb.js";import{P as R,a as P,b as M,R as S}from"./RowList-CBSK04iI.js";import{T as pe,a as ke,b as G,c as K,d as me,e as N,f as fe,L as xe,S as q,h as ve,i as je,j as be,k as Te,t as H}from"./table-DItrXKKI.js";import{S as ye,a as Se,b as Ce,c as De,d as Fe}from"./select-BL2cVPoN.js";import{D as J}from"./DatoVelger-CP-wrfAa.js";import{D as we,b as Ae,c as Be,d as Ke,f as Ne}from"./dialog-DlX4eupv.js";import"./react-RGnvvjkK.js";import"./lucide-C5rSQBgG.js";import"./switch-CjtXT-wj.js";import"./index-DnnwNeRP.js";import"./index-2r_zrsQA.js";function Le(t){if(!t)return;const n={...t};return delete n.requireAuth,delete n.axiosConfig,delete n.enabled,n}function Oe(t,n,s,i){const r=(i?.enabled??!0)&&s!=null,l=i?.requireAuth??!0,o=Le(i);return te({queryKey:t,enabled:r,retry:!1,...o,queryFn:async({signal:h})=>(await ne.post(n,s,{requireAuth:l,signal:h,timeout:2e4,...i?.axiosConfig??{}})).data})}function _(t){const[n,s]=t.split(":").map(Number);return n*60+s}function Ue(t){const n=String(Math.floor(t/60)).padStart(2,"0"),s=String(t%60).padStart(2,"0");return`${n}:${s}`}function Ve(t,n,s){const i=_(t),r=_(n),l=[];for(let o=i;o+s<=r;o+=s)l.push(Ue(o));return l}const Ie={ledige:[],konflikter:[]};function Ee(t){const n={...t,ukedager:[...t.ukedager].sort(),tidspunkter:[...t.tidspunkter].sort(),baneIder:[...t.baneIder].sort()};return JSON.stringify(n)}function Re(){const t=se(),n=ae(),{data:s,isLoading:i}=re(),{baner:r,isLoading:l}=he(!1),o=g.useMemo(()=>{const c=s?.bookingRegel;if(!c)return[];const m=c.aapningstid||"08:00",D=c.stengetid||"22:00",T=c.slotLengdeMinutter||60;return Ve(m,D,T)},[s?.bookingRegel]),[h,u]=g.useState(null),f=h?["arrangement-forhandsvis",t,Ee(h)]:["arrangement-forhandsvis",t,"empty"],p=Oe(f,`/klubb/${t}/arrangement/forhandsvis`,h,{requireAuth:!0,enabled:!!h,staleTime:6e4,retry:!1}),x=p.data??Ie,v=p.isFetching,j=async c=>(u(c),{success:!0}),k=()=>{u(null),n.cancelQueries({queryKey:["arrangement-forhandsvis",t]}),n.removeQueries({queryKey:["arrangement-forhandsvis",t]})},b=ie("post",`/klubb/${t}/arrangement`,{onSuccess:async c=>{k(),Q.success(`${c.antallOpprettet} bookinger opprettet`)},onError:c=>Q.error(c.message??"Feil ved oppretting"),retry:!1});return{klubb:s,baner:r,tilgjengeligeTidspunkter:o,forhandsvisning:x,forhandsvis:j,clearForhandsvisning:k,opprett:async c=>({success:!0,result:await b.mutateAsync(c)}),isLoading:i||l,isLoadingForhandsvisning:v}}function $(t){return`${t.dato}|${t.baneId}|${t.startTid}|${t.sluttTid}`}function Pe({beskrivelse:t,forhandsvisning:n}){const s=g.useMemo(()=>new Set(n.konflikter.map($)),[n.konflikter]),i=g.useMemo(()=>{const r=[...n.ledige,...n.konflikter];return r.sort((l,o)=>l.dato.localeCompare(o.dato)||l.startTid.localeCompare(o.startTid)||l.baneId.localeCompare(o.baneId)),r},[n.ledige,n.konflikter]);return e.jsx("div",{className:"max-h-[60vh] overflow-auto rounded-md border",children:e.jsxs(pe,{children:[e.jsx(ke,{children:e.jsxs(G,{children:[e.jsx(K,{children:"Dato"}),e.jsx(K,{children:"Klokkeslett"}),e.jsx(K,{children:"Bane"}),e.jsx(K,{children:"Beskrivelse"})]})}),e.jsx(me,{children:i.map(r=>{const l=s.has($(r)),o=r.baneNavn?.trim()||"(ukjent bane)";return e.jsxs(G,{className:oe("hover:bg-muted/50",l&&"bg-muted/40"),children:[e.jsx(N,{className:"align-top whitespace-nowrap",children:fe(r.dato)}),e.jsxs(N,{className:"align-top whitespace-nowrap",children:[r.startTid," – ",r.sluttTid]}),e.jsx(N,{className:"align-top whitespace-nowrap",children:o}),e.jsxs(N,{className:"align-top",children:[t,l&&e.jsx("span",{className:"ml-2 text-xs text-muted-foreground",children:"(Konflikt)"})]})]},$(r))})})]})})}function Me({open:t,onOpenChange:n,beskrivelse:s,forhandsvisning:i,isLoading:r,onCreate:l}){const o=i.ledige.length,h=i.konflikter.length,u=o+h>0;return e.jsx(we,{open:t,onOpenChange:n,children:e.jsxs(Ae,{className:"max-w-3xl",children:[e.jsx(Be,{children:e.jsx(Ke,{children:"Forhåndsvis bookingene"})}),r?e.jsx("p",{className:"text-muted-foreground italic",children:"Laster forhåndsvisning…"}):u?e.jsxs(e.Fragment,{children:[e.jsx(Pe,{beskrivelse:s,forhandsvisning:i}),e.jsx(Ne,{className:"mt-3",children:e.jsxs(L,{type:"button",onClick:l,children:["Opprett ",o," bookinger"]})})]}):e.jsx("p",{className:"text-muted-foreground italic",children:"Ingen bookinger å vise."})]})})}const qe=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];function $e(t){const{kategorier:n,kategori:s,beskrivelse:i,datoFra:r,datoTil:l,baner:o,tilgjengeligeUkedager:h,tilgjengeligeTidspunkter:u,valgteBaner:f,valgteUkedager:p,valgteTidspunkter:x,alleBaner:v,alleUkedager:j,alleTidspunkter:k,dialogOpen:b,forhandsvisning:C,isLoadingForhandsvisning:c,onChangeKategori:m,onChangeBeskrivelse:D,onChangeDatoFra:T,onChangeDatoTil:O,onToggleAlleBaner:F,onToggleAlleUkedager:U,onToggleAlleTidspunkter:A,onToggleBane:V,onToggleUkedag:B,onToggleTidspunkt:I,onOpenPreview:E,onCreate:w,onDialogOpenChange:y}=t;return e.jsxs(e.Fragment,{children:[e.jsxs(le,{onSubmit:a=>{a.preventDefault(),E()},children:[e.jsx(R,{title:"Type",description:"Kategori og beskrivelse for arrangementet.",children:e.jsx(P,{children:e.jsxs(M,{children:[e.jsx(S,{title:"Kategori",description:"Velg type arrangement.",children:e.jsxs(z,{children:[e.jsx(xe,{htmlFor:"kategori",className:"sr-only",children:"Kategori"}),e.jsxs(ye,{value:s,onValueChange:m,children:[e.jsx(Se,{id:"kategori",children:e.jsx(Ce,{placeholder:"Velg kategori..."})}),e.jsx(De,{children:n.map(a=>e.jsx(Fe,{value:a,children:a},a))})]})]})}),e.jsx(S,{title:"Beskrivelse",description:"Vises på bookingene.",children:e.jsx(z,{children:e.jsx(de,{id:"beskrivelse",value:i,onChange:a=>D(a.target.value)})})})]})})}),e.jsx(R,{title:"Periode",description:"Velg dato-intervallet og hvilke ukedager som gjelder.",children:e.jsx(P,{children:e.jsxs(M,{children:[e.jsx(S,{title:"Fra",description:"Startdato.",children:e.jsx(J,{value:r,onChange:T,visNavigering:!0})}),e.jsx(S,{title:"Til",description:"Sluttdato.",children:e.jsx(J,{value:l,onChange:O,visNavigering:!0})}),e.jsx(q,{title:"Alle gyldige dager",description:"Velger automatisk alle dager som finnes i perioden.",checked:j,onCheckedChange:U}),e.jsx(S,{title:"Ukedager",description:"Bare dager som finnes i perioden er aktive.",children:e.jsx("div",{className:"flex flex-wrap gap-2",children:qe.map(a=>e.jsx(L,{type:"button",variant:p.includes(a)?"default":"outline",size:"sm",onClick:()=>B(a),disabled:j||!h.includes(a),children:ve(a)},a))})})]})})}),e.jsx(R,{title:"Baner og tid",description:"Velg hvilke baner og tidspunkter som skal reserveres.",children:e.jsx(P,{children:e.jsxs(M,{children:[e.jsx(q,{title:"Velg alle baner",checked:v,onCheckedChange:F}),e.jsx(S,{title:"Baner",description:"Velg hvilke baner arrangementet gjelder.",children:e.jsx("div",{className:"flex flex-wrap gap-2",children:o.map(a=>e.jsx(L,{type:"button",variant:f.includes(a.id)?"default":"outline",size:"sm",onClick:()=>V(a.id),disabled:v,children:a.navn},a.id))})}),e.jsx(q,{title:"Velg alle tidspunkter",checked:k,onCheckedChange:A}),e.jsx(S,{title:"Tidspunkter",description:"Velg start-tidspunkt for bookingene.",children:e.jsx("div",{className:"flex flex-wrap gap-2",children:u.map(a=>e.jsx(L,{type:"button",variant:x.includes(a)?"default":"outline",size:"sm",onClick:()=>I(a),disabled:k,children:a},a))})})]})})}),e.jsx(ge,{variant:"sticky",children:e.jsx(ce,{isLoading:c,loadingText:"Forhåndsviser…",fullWidth:!0,children:"Forhåndsvis bookinger"})})]}),e.jsx(Me,{open:b,onOpenChange:y,beskrivelse:i,forhandsvisning:C,isLoading:c,onCreate:w})]})}function We(t,n){return je(t,n)}function Qe(t){const{datoFra:n,datoTil:s,valgteBaner:i,valgteUkedager:r,valgteTidspunkter:l,kategori:o,beskrivelse:h,onWarning:u}=t;if(i.length===0)return u("Du må velge minst én bane"),null;if(l.length===0)return u("Du må velge minst ett tidspunkt"),null;if(r.length===0)return u("Du må velge minst én ukedag"),null;const f=be(n,s),p=r.filter(x=>f.has(Te(x)));return p.length===0?(u("Ingen av de valgte ukedagene finnes i datointervallet"),null):{tittel:o,beskrivelse:h?.trim()?h:void 0,kategori:o,startDato:H(n),sluttDato:H(s),ukedager:p,tidspunkter:l,baneIder:i}}const ze=["Trening","Turnering","Klubbmersterskap","Kurs","Lagkamp","Stigespill","Dugnad","Vedlikehold","Sosialt","Annet"];function W(t,n){n(s=>s.includes(t)?s.filter(i=>i!==t):[...s,t])}function Ge(){const{baner:t,tilgjengeligeTidspunkter:n,forhandsvisning:s,forhandsvis:i,clearForhandsvisning:r,opprett:l,isLoading:o,isLoadingForhandsvisning:h}=Re(),[u,f]=g.useState(new Date),[p,x]=g.useState(new Date),[v,j]=g.useState([]),[k,b]=g.useState([]),[C,c]=g.useState([]),[m,D]=g.useState(!1),[T,O]=g.useState(!1),[F,U]=g.useState(!1),[A,V]=g.useState("Annet"),[B,I]=g.useState(""),[E,w]=g.useState(!1),y=g.useMemo(()=>We(u,p),[u,p]);g.useEffect(()=>{m&&j(t.map(d=>d.id))},[m,t]),g.useEffect(()=>{T&&b(y)},[T,y]),g.useEffect(()=>{F&&c(n)},[F,n]),g.useEffect(()=>{b(d=>d.filter(Z=>y.includes(Z)))},[y]);const a=()=>Qe({datoFra:u,datoTil:p,valgteBaner:v,valgteUkedager:k,valgteTidspunkter:C,kategori:A,beskrivelse:B,onWarning:d=>Q.warning(d)}),X=async()=>{const d=a();d&&(w(!0),await i(d))},Y=async()=>{const d=a();d&&(await l(d),r(),w(!1))};return o?e.jsx(ue,{}):e.jsx($e,{kategorier:ze,kategori:A,beskrivelse:B,datoFra:u,datoTil:p,baner:t,tilgjengeligeUkedager:y,tilgjengeligeTidspunkter:n,valgteBaner:v,valgteUkedager:k,valgteTidspunkter:C,alleBaner:m,alleUkedager:T,alleTidspunkter:F,dialogOpen:E,forhandsvisning:s,isLoadingForhandsvisning:h,onChangeKategori:V,onChangeBeskrivelse:I,onChangeDatoFra:f,onChangeDatoTil:x,onToggleAlleBaner:D,onToggleAlleUkedager:O,onToggleAlleTidspunkter:U,onToggleBane:d=>W(d,j),onToggleUkedag:d=>W(d,b),onToggleTidspunkt:d=>W(d,c),onOpenPreview:X,onCreate:Y,onDialogOpenChange:d=>{w(d),d||r()}})}function lt(){return e.jsx(ee,{children:e.jsx(Ge,{})})}export{lt as default};
