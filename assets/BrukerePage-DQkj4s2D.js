import{r as n,j as l}from"./shadcn-C7L97JSy.js";import{f as D,g as $,i as P,L as W,B as L,t as M}from"./index-3TgM-pJG.js";import{C as q,a as O}from"./FieldWrapper-C86oTohC.js";import{F as z}from"./FormField-C7sfSCIZ.js";import{S as I}from"./SelectField-rKsER-wy.js";import"./react-D5d5vywP.js";import"./lucide-CAh2A4Ey.js";import"./index-BswtpnY1.js";async function Q(t,e){const s=await D(`/api/klubb/${t}/bruker/sok?query=${encodeURIComponent(e.trim())}`,{method:"GET"},!0);if(!s.ok){const i=await s.text();throw new Error(i||"Kunne ikke hente brukere")}return await s.json()}async function G(t,e,s){const i=await D(`/api/klubb/${t}/bruker/${e}/rolle`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)},!0);if(!i.ok){const g=await i.text();throw new Error(g||"Kunne ikke oppdatere rolle")}}function J(t,e,s,i){var g=this,c=n.useRef(null),d=n.useRef(0),p=n.useRef(0),a=n.useRef(null),o=n.useRef([]),x=n.useRef(),k=n.useRef(),R=n.useRef(t),b=n.useRef(!0);R.current=t;var w=typeof window<"u",y=!e&&e!==0&&w;if(typeof t!="function")throw new TypeError("Expected a function");e=+e||0;var r=!!(s=s||{}).leading,m=!("trailing"in s)||!!s.trailing,u="maxWait"in s,v="debounceOnServer"in s&&!!s.debounceOnServer,j=u?Math.max(+s.maxWait||0,e):null;n.useEffect(function(){return b.current=!0,function(){b.current=!1}},[]);var C=n.useMemo(function(){var N=function(f){var h=o.current,A=x.current;return o.current=x.current=null,d.current=f,p.current=p.current||f,k.current=R.current.apply(A,h)},E=function(f,h){y&&cancelAnimationFrame(a.current),a.current=y?requestAnimationFrame(f):setTimeout(f,h)},T=function(f){if(!b.current)return!1;var h=f-c.current;return!c.current||h>=e||h<0||u&&f-d.current>=j},B=function(f){return a.current=null,m&&o.current?N(f):(o.current=x.current=null,k.current)},F=function f(){var h=Date.now();if(r&&p.current===d.current&&K(),T(h))return B(h);if(b.current){var A=e-(h-c.current),U=u?Math.min(A,j-(h-d.current)):A;E(f,U)}},K=function(){i&&i({})},S=function(){if(w||v){var f=Date.now(),h=T(f);if(o.current=[].slice.call(arguments),x.current=g,c.current=f,h){if(!a.current&&b.current)return d.current=c.current,E(F,e),r?N(c.current):k.current;if(u)return E(F,e),N(c.current)}return a.current||E(F,e),k.current}};return S.cancel=function(){a.current&&(y?cancelAnimationFrame(a.current):clearTimeout(a.current)),d.current=0,o.current=c.current=x.current=a.current=null},S.isPending=function(){return!!a.current},S.flush=function(){return a.current?B(Date.now()):k.current},S},[r,u,e,j,m,y,w,v,i]);return C}function H(t,e){return t===e}function V(t,e,s){var i=H,g=n.useRef(t),c=n.useState({})[1],d=J(n.useCallback(function(a){g.current=a,c({})},[c]),e,s,c),p=n.useRef(t);return i(p.current,t)||(d(t),p.current=t),[g.current,d]}function X(t,e=""){const[s,i]=n.useState([]),[g,c]=n.useState(!1),[d,p]=n.useState(null),[a]=V(e.trim(),300);return n.useEffect(()=>{if(!t||a.length<2)return;const o=new AbortController;return c(!0),Q(t,a).then(x=>{o.signal.aborted||(i(x),p(null))}).catch(x=>{o.signal.aborted||(p(x.message),i([]))}).finally(()=>{o.signal.aborted||c(!1)}),()=>o.abort()},[t,a]),{brukere:s,laster:g,feil:d}}function se(){const{slug:t}=$(),{bruker:e,laster:s}=P(t),[i,g]=n.useState(""),{brukere:c,laster:d,feil:p}=X(t,i),[a,o]=n.useState({}),[x,k]=n.useState({}),R=e==null?void 0:e.roller.includes("KlubbAdmin"),b=(r,m)=>{o(u=>({...u,[r]:m}))},w=r=>{o(m=>{const u={...m};return delete u[r],u})},y=async r=>{if(!t)return;const m=a[r];if(m)try{await G(t,r,m),M.success("Rolle oppdatert"),k(u=>({...u,[r]:m})),o(u=>{const v={...u};return delete v[r],v})}catch(u){M.error(u instanceof Error?u.message:"Ukjent feil ved oppdatering")}};return n.useEffect(()=>{o({})},[i]),s?l.jsx(W,{}):R?l.jsx("div",{className:"max-w-screen-sm mx-auto px-2 py-2 space-y-4",children:l.jsx(q,{children:l.jsxs(O,{className:"p-4 space-y-4",children:[l.jsx(z,{id:"sok",label:"Søk etter bruker",value:i,onChange:r=>g(r.target.value),helpText:"F.eks. navn eller e-post"}),d&&l.jsx("p",{children:"Laster brukere..."}),!d&&p&&l.jsx("p",{className:"text-red-600",children:p}),!d&&c.length===0&&!p&&l.jsx("p",{className:"text-muted-foreground",children:"Ingen brukere funnet"}),c.map(r=>{const m=r.id===(e==null?void 0:e.id),u=x[r.id]??r.roller[0]??"Medlem",v=a[r.id]??u,j=v!==u;return l.jsxs("div",{className:"border rounded p-3 space-y-2",children:[l.jsx("div",{className:"font-medium",children:r.epost}),l.jsxs("div",{className:"text-sm text-muted-foreground",children:["Nåværende rolle: ",l.jsx("strong",{children:u})]}),l.jsx(I,{id:`rolle-${r.id}`,label:m?"Du kan ikke endre din egen rolle":"Endre rolle",value:v,onChange:C=>b(r.id,C),disabled:m,options:[{label:"Medlem",value:"Medlem"},{label:"Utvidet",value:"Utvidet"},{label:"KlubbAdmin",value:"KlubbAdmin"}]}),!m&&l.jsxs("div",{className:"flex gap-2",children:[l.jsx(L,{size:"sm",onClick:()=>y(r.id),disabled:!j,children:"Lagre"}),l.jsx(L,{size:"sm",variant:"ghost",onClick:()=>w(r.id),disabled:!j,children:"Avbryt"})]})]},r.id)})]})})}):l.jsx("p",{className:"text-sm text-destructive px-2 py-2 text-center",children:"Du har ikke tilgang til denne siden."})}export{se as default};
