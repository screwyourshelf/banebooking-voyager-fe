import{r as c,j as e}from"./shadcn-DDUjAgUv.js";import{u as S}from"./useSlug-DipqLcgr.js";import{P as T}from"./Page-Cq3gZojq.js";import{S as E}from"./SimpleTabsLazy-2FTM8ipJ.js";import{f as w,L as f,B as x,g as A,h as m,u as C,d as y,e as v,t as u,i as L}from"./index-VZYxSd3S.js";import{F as g,a as b}from"./FormField-D5-NoD76.js";import{T as K}from"./TextareaField-DDR9vy49.js";import{A as N,a as B,b as P,c as F,d as U,e as R,f as M,g as V,h as O}from"./alert-dialog-DRdKPtmT.js";import{f as D}from"./datoUtils-Bzity_GL.js";import{P as q}from"./PageSection-CrgFjiMc.js";import{T as $,a as H,b as j,c as p,d as I,e as h}from"./table-qwODnhVS.js";import{b as Q}from"./booking-ChEu_yS9.js";import"./react-RGnvvjkK.js";import"./lucide-Bc72fHhV.js";import"./index-CZuuFr9-.js";function z({slug:n}){const{data:t,isLoading:s,oppdaterKlubb:o}=w(n),[a,l]=c.useState({navn:"",kontaktEpost:"",banereglement:"",latitude:"",longitude:"",feedUrl:"",feedSynligAntallDager:"50"});return c.useEffect(()=>{t&&l({navn:t.navn??"",kontaktEpost:t.kontaktEpost??"",banereglement:t.banereglement??"",latitude:t.latitude?.toString()??"",longitude:t.longitude?.toString()??"",feedUrl:t.feedUrl??"",feedSynligAntallDager:t.feedSynligAntallDager?.toString()??"50"})},[t]),s||!t?e.jsx(f,{}):e.jsxs("form",{className:"space-y-4",onSubmit:r=>{r.preventDefault(),o.mutate({...t,navn:a.navn,kontaktEpost:a.kontaktEpost,banereglement:a.banereglement,latitude:parseFloat(a.latitude),longitude:parseFloat(a.longitude),feedUrl:a.feedUrl,feedSynligAntallDager:parseInt(a.feedSynligAntallDager,10)})},children:[e.jsx(g,{id:"navn",label:"Klubbnavn",value:a.navn,onChange:r=>l(i=>({...i,navn:r.target.value})),helpText:"Navnet på klubben slik det vises utad i Banebooking."}),e.jsx(g,{id:"kontaktEpost",label:"Kontakt-e-post",type:"email",value:a.kontaktEpost,onChange:r=>l(i=>({...i,kontaktEpost:r.target.value})),helpText:"E-postadresse som vises på klubbens infoside. Brukes til henvendelser fra medlemmer og gjester."}),e.jsx(K,{id:"banereglement",label:"Banereglement",value:a.banereglement,onChange:r=>l(i=>({...i,banereglement:r.target.value})),helpText:"Tekst som beskriver klubbens regler for bruk av banene. Vises til brukere når de booker."}),e.jsx(g,{id:"latitude",label:"Latitude (breddegrad)",value:a.latitude,onChange:r=>l(i=>({...i,latitude:r.target.value})),helpText:"Breddegrad for klubbens beliggenhet. Brukes til kartvisning."}),e.jsx(g,{id:"longitude",label:"Longitude (lengdegrad)",value:a.longitude,onChange:r=>l(i=>({...i,longitude:r.target.value})),helpText:"Lengdegrad for klubbens beliggenhet. Brukes til kartvisning."}),e.jsx(g,{id:"feedUrl",label:"RSS-feed (valgfritt)",value:a.feedUrl,onChange:r=>l(i=>({...i,feedUrl:r.target.value})),helpText:"URL til klubbens RSS-feed (f.eks. nyheter). Hvis satt, hentes og vises de nyeste innleggene i appen."}),e.jsx(g,{id:"feedSynligAntallDager",label:"Aldergrense for feedinnslag (dager)",type:"number",min:0,value:a.feedSynligAntallDager,onChange:r=>l(i=>({...i,feedSynligAntallDager:r.target.value})),helpText:"Bestemmer hvor mange dager gamle innslag fra klubbens RSS-feed som skal vises. Sett til 0 for å inkludere alle."}),e.jsx(x,{type:"submit",size:"sm",disabled:o.isPending,children:o.isPending?"Lagrer...":"Lagre endringer"})]})}function G({slettMeg:n}){const{signOut:t}=A(),[s,o]=c.useState(!1),a=async()=>{try{await n.mutateAsync(),o(!1),await t()}catch{}};return e.jsxs(N,{open:s,onOpenChange:o,children:[e.jsx(B,{asChild:!0,children:e.jsx(x,{variant:"destructive",disabled:n.isPending,children:n.isPending?"Sletter...":"Slett min bruker"})}),e.jsxs(P,{children:[e.jsxs(F,{children:[e.jsx(U,{children:"Er du sikker?"}),e.jsx(R,{children:"Dette vil slette din bruker og all tilknytning permanent. Denne handlingen kan ikke angres."})]}),e.jsxs(M,{children:[e.jsx(V,{disabled:n.isPending,children:"Avbryt"}),e.jsx(O,{variant:"destructive",onClick:a,disabled:n.isPending,children:n.isPending?"Sletter...":"Slett bruker"})]})]})]})}async function J(n){const t=await m(`/api/klubb/${n}/bruker/meg`,{method:"GET"},!0);if(!t.ok)throw new Error(await t.text()||"Kunne ikke hente meg");return await t.json()}async function W(n,t){const s=await m(`/api/klubb/${n}/bruker/meg`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)},!0);if(!s.ok)throw new Error(await s.text()||"Kunne ikke oppdatere visningsnavn")}async function _(n){const t=await m(`/api/klubb/${n}/bruker/meg/egen-data`,{method:"GET"},!0);if(!t.ok)throw new Error(await t.text()||"Kunne ikke hente egen data");const s=await t.blob(),o=window.URL.createObjectURL(s),a=document.createElement("a");a.href=o,a.download=`banebooking-data-${new Date().toISOString().slice(0,10)}.json`,document.body.appendChild(a),a.click(),a.remove(),window.URL.revokeObjectURL(o)}async function X(n){const t=await m(`/api/klubb/${n}/bruker/meg`,{method:"DELETE"},!0);if(!t.ok)throw new Error(await t.text()||"Kunne ikke slette brukeren")}function Y(n){const t=C(),{data:s,isLoading:o,error:a,refetch:l}=y({queryKey:["meg",n],queryFn:()=>J(n),enabled:!!n,staleTime:6e4,onError:d=>{u.error(d.message??"Kunne ikke hente brukerinfo")}}),r=v({mutationFn:d=>W(n,{visningsnavn:d}),onSuccess:()=>{u.success("Visningsnavn oppdatert"),t.invalidateQueries({queryKey:["meg",n]})},onError:d=>{u.error(d instanceof Error?d.message:"Kunne ikke oppdatere visningsnavn")}}),i=async()=>{try{await _(n),u.success("Data lastet ned")}catch(d){u.error(d instanceof Error?d.message:"Kunne ikke laste ned data")}},k=v({mutationFn:()=>X(n),onSuccess:()=>{u.success("Brukeren er slettet"),t.removeQueries({queryKey:["meg",n]})},onError:d=>{u.error(d instanceof Error?d.message:"Kunne ikke slette bruker")}});return{bruker:s,laster:o,error:a,refetch:l,oppdaterVisningsnavn:r,lastNedEgenData:i,slettMeg:k.mutate}}function Z({slug:n}){const{bruker:t,laster:s,lastNedEgenData:o,slettMeg:a}=Y(n),{isPending:l}=a;return s||!t?e.jsx(f,{}):e.jsxs(q,{bordered:!0,className:"space-y-4",children:[e.jsxs(b,{id:"vilkaar",label:"Vilkår for bruk",helpText:"Du aksepterer vilkårene automatisk ved første innlogging.",children:[t.vilkaarAkseptertDato?e.jsxs("p",{className:"text-sm text-foreground",children:["Akseptert ",D(t.vilkaarAkseptertDato)," ",t.vilkaarVersjon&&`(versjon ${t.vilkaarVersjon})`]}):e.jsx("p",{className:"text-sm text-muted-foreground italic",children:"Ikke registrert"}),e.jsx("p",{className:"text-sm mt-1",children:e.jsx(L,{to:`/${n}/vilkaar`,className:"underline text-primary hover:text-primary/80",target:"_blank",rel:"noopener noreferrer",children:"Les vilkårene"})})]}),e.jsx(b,{id:"last-ned-data",label:"Last ned dine data",helpText:"Du kan laste ned alle registrerte opplysninger og bookinger i JSON-format.",children:e.jsx(x,{onClick:o,size:"sm",variant:"outline",disabled:l,children:l?"Laster ned...":"Last ned data"})}),e.jsx(b,{id:"slett-bruker",label:"Slett bruker",helpText:"Dette sletter brukeren din og all tilknyttet data permanent.",children:e.jsx(G,{slettMeg:a})})]})}function ee(n,t=!1){return y({queryKey:["mineBookinger",n,t],queryFn:async()=>n?await Q(n,t):[],enabled:!!n,staleTime:6e4,onError:s=>u.error(s.message??"Ukjent feil ved henting av bookinger")})}function te({slug:n}){const[t,s]=c.useState(!1),{data:o=[],isLoading:a}=ee(n,t),l=[...o].sort((r,i)=>{const k=new Date(i.dato).getTime()-new Date(r.dato).getTime();return k!==0?k:i.startTid.localeCompare(r.startTid)});return a?e.jsx(f,{}):e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"flex items-center space-x-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:t,onChange:r=>s(r.target.checked)}),e.jsx("span",{children:"Vis også tidligere bookinger"})]}),l.length===0?e.jsx("p",{className:"text-sm text-muted-foreground italic",children:t?"Du har ingen registrerte bookinger.":"Du har ingen kommende bookinger."}):e.jsx("div",{className:"overflow-auto max-h-[60vh] border rounded-md",children:e.jsxs($,{className:"text-sm",children:[e.jsx(H,{children:e.jsxs(j,{children:[e.jsx(p,{children:"Dato"}),e.jsx(p,{children:"Tid"}),e.jsx(p,{children:"Bane"})]})}),e.jsx(I,{children:l.map((r,i)=>e.jsxs(j,{children:[e.jsx(h,{children:D(r.dato)}),e.jsxs(h,{children:[r.startTid,"–",r.sluttTid]}),e.jsx(h,{children:r.baneNavn})]},i))})]})})]})}function he(){const[n,t]=c.useState("bookinger"),s=S();return e.jsx(T,{children:e.jsx(E,{items:[{value:"bookinger",label:"Mine bookinger",content:e.jsx(te,{slug:s})},{value:"profil",label:"Min profil",content:e.jsx(z,{slug:s})},{value:"persondata",label:"Persondata",content:e.jsx(Z,{slug:s})}],value:n,onValueChange:t})})}export{he as default};
