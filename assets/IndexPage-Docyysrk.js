import{r as f,j as t}from"./shadcn-BW0HktFr.js";import{C as B,f as D,D as N}from"./checkbox-BUUBThao.js";import{F as w,B as j,a as A,b as E,c as $,L as T,u as C,d as Q,t as p,e as y,f as M,g as L}from"./index-BWn9U0qn.js";import{u as I}from"./useBaner-B8f9R8Ud.js";import{u as S}from"./useSlug-Dgkv8Wrt.js";import{P}from"./Page-D3HqBSgJ.js";import{S as F}from"./SimpleTabsLazy-C44pBQN4.js";import{D as _,a as K,b as z,c as R,d as V,e as q}from"./dialog-DSMzxNGf.js";import{a as O}from"./lucide-D2dOsrR-.js";import"./react-RGnvvjkK.js";import"./index-CVVkWozz.js";import"./index-CJjGIk76.js";function H(){const[e,n]=f.useState(!1);return{erBekreftet:e,setErBekreftet:n,reset:()=>n(!1)}}function W({slot:e,isOpen:n,erInteraktiv:i,currentUser:s}){const u=`${e.startTid.slice(0,2)}-${e.sluttTid.slice(0,2)}`,o=!!e.arrangementTittel,[a,c]=f.useState(!1);f.useEffect(()=>{const x=()=>c(window.innerWidth<640);return x(),window.addEventListener("resize",x),()=>window.removeEventListener("resize",x)},[]);const d=40,k=e.arrangementBeskrivelse&&a&&e.arrangementBeskrivelse.length>d?e.arrangementBeskrivelse.slice(0,d)+"...":e.arrangementBeskrivelse;return t.jsx("div",{className:"flex items-center",children:t.jsxs("div",{className:"flex flex-1 items-center justify-between",children:[t.jsx("div",{className:"whitespace-nowrap font-semibold text-sm text-right pr-1",children:u}),t.jsx("div",{className:"w-[18px] h-[18px] flex items-center justify-center",children:e.værSymbol?t.jsx("img",{src:`/banebooking-voyager-fe/weather-symbols/svg/${e.værSymbol}.svg`,alt:e.værSymbol,width:18,height:18,className:"select-none",draggable:!1}):t.jsx("span",{className:"invisible"})}),t.jsx("div",{className:"flex-grow text-sm p-1",children:o?t.jsxs("div",{children:[t.jsx("div",{className:"font-medium",children:e.arrangementTittel}),k&&t.jsx("div",{className:"text-xs text-gray-600",children:k})]}):t.jsx("div",{children:e.booketAv?s?e.booketAv:J(e.booketAv):"Ledig"})}),i&&t.jsx("div",{className:"p-1",children:t.jsx(w,{size:12,style:{transform:n?"rotate(180deg)":"rotate(0deg)",transition:"transform 0.2s"},"aria-hidden":"true"})})]})})}function J(e){const[n,i]=e.split("@");return!n||!i?e:`${n[0]}***@${i}`}function Y({slot:e,onBook:n=()=>{},onCancel:i=()=>{},onDelete:s=()=>{},time:u,erBekreftet:o,setErBekreftet:a,reset:c=()=>{}}){return t.jsxs("div",{className:"flex flex-col items-end w-full",children:[e.kanBookes&&o!==void 0&&a&&t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"flex items-center space-x-1 mb-2 text-sm",children:[t.jsx(B,{id:`book-${u}`,checked:o,onCheckedChange:d=>a(!!d)}),t.jsxs("label",{htmlFor:`book-${u}`,className:"cursor-pointer select-none",children:["Jeg (og de jeg spiller sammen med) har betalt medlemskap for ",new Date().getFullYear()]})]}),t.jsxs(j,{variant:"outline",size:"sm",disabled:!o,onClick:()=>{n(e),c()},className:"flex items-center gap-2 text-sm",children:[t.jsx(A,{}),"Book"]})]}),e.kanAvbestille&&t.jsxs(j,{variant:"outline",size:"sm",onClick:()=>{i(e),c()},className:"flex items-center gap-2 text-sm",children:[t.jsx(E,{}),"Avbestill"]}),e.kanSlette&&t.jsxs(j,{variant:"destructive",size:"sm",onClick:()=>{s(e),c()},className:"flex items-center gap-2 text-sm",children:[t.jsx($,{}),"Slett"]})]})}function G({slot:e,time:n,erBekreftet:i,setErBekreftet:s,onBook:u,onCancel:o,onDelete:a,reset:c}){return t.jsx("div",{className:"mt-1",children:t.jsx("div",{className:"bg-inherit",children:t.jsx(Y,{slot:e,time:n,erBekreftet:i,setErBekreftet:s,onBook:u,onCancel:o,onDelete:a,reset:c})})})}function U({slot:e,currentUser:n,isOpen:i=!1,onToggle:s,onBook:u=()=>{},onCancel:o=()=>{},onDelete:a=()=>{}}){const{erBekreftet:c,setErBekreftet:d,reset:k}=H(),x=`${e.startTid.slice(0,2)}-${e.sluttTid.slice(0,2)}`,v=e.kanBookes||e.kanAvbestille||e.kanSlette,b=!!n&&v&&!e.erPassert,h=!!e.arrangementTittel,r=e.erEier===!0,m=["border rounded shadow-sm p-2 mb-2","transition-colors duration-300 ease-in-out",e.erPassert?"bg-gray-100 text-gray-400":"",!e.erPassert&&h?"bg-gradient-to-r from-blue-0 via-blue-50 to-blue-200 border-blue-200":"",!e.erPassert&&!h?"bg-white text-gray-900":"",n&&r&&!h?"animate__animated animate__headShake animate__slow":""].join(" "),l=()=>{b&&s&&(s(),d(!1))};return t.jsxs("div",{className:m,style:{cursor:b?"pointer":"default",opacity:e.erPassert?.5:1},onClick:g=>{g.target.closest("button, input, label")||l()},role:b?"button":void 0,tabIndex:b?0:void 0,onKeyDown:g=>{(g.key==="Enter"||g.key===" ")&&(g.preventDefault(),l())},children:[t.jsx(W,{slot:e,isOpen:i,erInteraktiv:b,currentUser:n}),i&&!e.erPassert&&t.jsx(G,{slot:e,time:x,erBekreftet:c,setErBekreftet:d,onBook:u,onCancel:o,onDelete:a,reset:k})]})}function X({slots:e,currentUser:n,onBook:i,onCancel:s,onDelete:u,apenSlotTid:o,setApenSlotTid:a,isLoading:c=!1}){return c?t.jsx(T,{}):e.length===0?t.jsx("div",{className:"text-muted text-sm italic py-4 text-center",children:"Ingen bookinger eller slots � vise."}):t.jsx("div",{className:"space-y-2",children:e.map(d=>{const k=`${d.dato}-${d.startTid}-${d.baneId}`;return t.jsx(U,{slot:d,currentUser:n,onBook:i,onCancel:s,onDelete:u,isOpen:o===k,onToggle:()=>a?.(o===k?null:k)},k)})})}function Z(e,n,i){const s=C(),[u,o]=f.useState(null),a=["bookinger",e??"",i??"",n??""],c=Q(a,`/klubb/${e}/bookinger?baneId=${i}&dato=${n}`,{requireAuth:!0,enabled:!!e&&!!i&&!!n,staleTime:0,refetchInterval:3e4,refetchOnWindowFocus:!0,refetchIntervalInBackground:!1,placeholderData:[]}),d=f.useRef(!1);f.useEffect(()=>{if(!c.error){d.current=!1;return}d.current||(p.error(c.error.message??"Kunne ikke hente bookinger"),d.current=!0)},[c.error]);const k=()=>{s.invalidateQueries({queryKey:a}),s.invalidateQueries({queryKey:["mineBookinger",e]})},x=(r,m)=>r.startTid===m.startTid&&r.sluttTid===m.sluttTid,v=y("post",`/klubb/${e}/bookinger`,{onMutate:async r=>{await s.cancelQueries({queryKey:a});const m=s.getQueryData(a);return s.setQueryData(a,(l=[])=>l.map(g=>x(g,r)?{...g,booketAv:"Du",erEier:!0,kanBookes:!1,kanAvbestille:!0}:g)),{previous:m}},onError:(r,m,l)=>{l?.previous&&s.setQueryData(a,l.previous),p.error(r.message??"Kunne ikke booke.")},onSuccess:(r,m)=>{const l=`${m.startTid.slice(0,2)}-${m.sluttTid.slice(0,2)}`;p.success(`Booket ${l}`)},onSettled:()=>{k()}}),b=y("delete",`/klubb/${e}/bookinger`,{onMutate:async r=>{await s.cancelQueries({queryKey:a});const m=s.getQueryData(a);return s.setQueryData(a,(l=[])=>l.map(g=>x(g,r)?{...g,booketAv:null,erEier:!1,kanBookes:!0,kanAvbestille:!1,kanSlette:!1}:g)),{previous:m}},onError:(r,m,l)=>{l?.previous&&s.setQueryData(a,l.previous),p.error(r.message??"Kunne ikke avbestille.")},onSuccess:()=>{p.info("Bookingen er avbestilt.")},onSettled:()=>{k()}}),h=y("delete",`/klubb/${e}/bookinger/admin`,{onMutate:async r=>{await s.cancelQueries({queryKey:a});const m=s.getQueryData(a);return s.setQueryData(a,(l=[])=>l.map(g=>x(g,r)?{...g,booketAv:null,erEier:!1,kanBookes:!0,kanAvbestille:!1,kanSlette:!1}:g)),{previous:m}},onError:(r,m,l)=>{l?.previous&&s.setQueryData(a,l.previous),p.error(r.message??"Kunne ikke slette booking.")},onSuccess:()=>{p.success("Booking slettet"),o(null)},onSettled:()=>{k()}});return{slots:c.data??[],isLoading:c.isLoading,apenSlotTid:u,setApenSlotTid:o,onBook:r=>v.mutate({baneId:i,dato:n,startTid:r.startTid,sluttTid:r.sluttTid}),onCancel:r=>b.mutate({baneId:i,dato:n,startTid:r.startTid,sluttTid:r.sluttTid}),onDelete:r=>h.mutate({baneId:r.baneId??i,dato:r.dato??n,startTid:r.startTid,sluttTid:r.sluttTid}),hentBookinger:c.refetch}}function ee({children:e}){const n=S(),{data:i,isLoading:s}=M(n);if(s||!i)return null;const{bookingRegel:u}=i;return t.jsxs(_,{children:[t.jsx(K,{asChild:!0,children:e}),t.jsxs(z,{children:[t.jsxs(R,{children:[t.jsx(V,{children:"Bookingregler"}),t.jsx(q,{className:"sr-only",children:"Oversikt over bookingreglene i klubben"})]}),t.jsx("div",{className:"space-y-4",children:t.jsxs("ul",{className:"list-disc list-inside text-sm",children:[t.jsxs("li",{children:["Maks ",u.maksPerDag," bookinger per dag"]}),t.jsxs("li",{children:["Maks ",u.maksTotalt," aktive bookinger totalt"]}),t.jsxs("li",{children:["Opptil ",u.dagerFremITid," dager frem i tid"]}),t.jsxs("li",{children:[u.slotLengdeMinutter," minutter per booking"]}),t.jsxs("li",{children:["Tillatt mellom ",u.aapningstid,"–",u.stengetid]})]})})]})]})}function ke(){const e=S(),{baner:n,isLoading:i}=I(e,!1),[s,u]=f.useState(""),[o,a]=f.useState(new Date),{currentUser:c}=L(),d=f.useMemo(()=>o?D(o,"yyyy-MM-dd"):"",[o]),{slots:k,apenSlotTid:x,setApenSlotTid:v,onBook:b,onCancel:h,onDelete:r,isLoading:m}=Z(e,d,s);return f.useEffect(()=>{!s&&n.length>0&&u(n[0].id)},[n,s]),f.useEffect(()=>{v(null)},[o,s,v]),f.useEffect(()=>{c||v(null)},[c,v]),f.useEffect(()=>{o&&localStorage.setItem("valgtDato",o.toISOString())},[o]),i||!s?t.jsx(T,{}):t.jsxs(P,{children:[t.jsxs("div",{className:"flex justify-between items-center mb-2",children:[t.jsx(ee,{children:t.jsx(j,{variant:"ghost",size:"icon",className:"rounded-full",title:"Vis banereglement",children:t.jsx(O,{className:"w-5 h-5"})})}),t.jsx(N,{value:o,onChange:l=>a(l??null),visNavigering:!0})]}),t.jsx(F,{items:n.map(l=>({value:l.id,label:l.navn,content:t.jsx(X,{slots:k,currentUser:c?{epost:c.email??""}:null,apenSlotTid:x,setApenSlotTid:v,onBook:b,onCancel:h,onDelete:r,isLoading:m})})),value:s,onValueChange:u})]})}export{ke as default};
