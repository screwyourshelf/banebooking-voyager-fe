import{j as e,r as b}from"./react-Bq13ngtT.js";import{P as D}from"./Page-loVwC9K4.js";import{a as S,b as $,d as C,t as p,e as w,k as A,f as E,B as T,F as M,g as Q,h as L,i as I,L as B,j as F,l as P}from"./index-_75ENDbC.js";import{u as z}from"./useBaner-Dfw1qumi.js";import{D as _,f as K}from"./DatoVelger-BJ5dylm9.js";import{a as V,b as R}from"./lucide-CWsE_6zt.js";import{c as q,d as O}from"./shadcn-B0ihbUNs.js";import{D as H,a as W,b as J,c as Y,d as G,e as X}from"./dialog-CvIAI_A9.js";import{T as Z,a as U,b as ee}from"./tabs-B8FpkNRK.js";function te({items:t,value:n,onValueChange:a,className:s=""}){const o=t.find(l=>l.value===n)??t[0];return e.jsxs(Z,{value:o.value,onValueChange:a,children:[e.jsx(U,{className:`flex flex-wrap gap-2 mb-2 ${s}`,children:t.map(l=>e.jsx(ee,{value:l.value,children:l.label},l.value))}),e.jsx("div",{className:"mt-0",children:o.content})]})}function se(t,n){const a=S(),s=$(),[o,l]=b.useState(null),i=["bookinger",a,n,t],d=!!n&&!!t,c=C(i,`/klubb/${a}/bookinger?baneId=${n}&dato=${t}`,{requireAuth:!0,enabled:d,staleTime:0,refetchInterval:3e4,refetchOnWindowFocus:!0,refetchIntervalInBackground:!1,placeholderData:A}),g=b.useRef(!1);b.useEffect(()=>{if(!c.error){g.current=!1;return}g.current||(p.error(c.error.message??"Kunne ikke hente bookinger"),g.current=!0)},[c.error]);const k=()=>{s.invalidateQueries({queryKey:i}),s.invalidateQueries({queryKey:["mineBookinger",a]})},x=(r,u)=>r.startTid===u.startTid&&r.sluttTid===u.sluttTid,h=w("post",`/klubb/${a}/bookinger`,{onMutate:async r=>{await s.cancelQueries({queryKey:i});const u=s.getQueryData(i);return s.setQueryData(i,(m=[])=>m.map(f=>x(f,r)?{...f,booketAv:"Du",erEier:!0,kanBookes:!1,kanAvbestille:!0}:f)),{previous:u}},onError:(r,u,m)=>{m?.previous&&s.setQueryData(i,m.previous),p.error(r.message??"Kunne ikke booke.")},onSuccess:(r,u)=>{const m=`${u.startTid.slice(0,2)}-${u.sluttTid.slice(0,2)}`;p.success(`Booket ${m}`)},onSettled:()=>{k()}}),v=w("delete",`/klubb/${a}/bookinger`,{onMutate:async r=>{await s.cancelQueries({queryKey:i});const u=s.getQueryData(i);return s.setQueryData(i,(m=[])=>m.map(f=>x(f,r)?{...f,booketAv:null,erEier:!1,kanBookes:!0,kanAvbestille:!1,kanSlette:!1}:f)),{previous:u}},onError:(r,u,m)=>{m?.previous&&s.setQueryData(i,m.previous),p.error(r.message??"Kunne ikke avbestille.")},onSuccess:()=>{p.info("Bookingen er avbestilt.")},onSettled:()=>{k()}}),j=w("delete",`/klubb/${a}/bookinger/admin`,{onMutate:async r=>{await s.cancelQueries({queryKey:i});const u=s.getQueryData(i);return s.setQueryData(i,(m=[])=>m.map(f=>x(f,r)?{...f,booketAv:null,erEier:!1,kanBookes:!0,kanAvbestille:!1,kanSlette:!1}:f)),{previous:u}},onError:(r,u,m)=>{m?.previous&&s.setQueryData(i,m.previous),p.error(r.message??"Kunne ikke slette booking.")},onSuccess:()=>{p.success("Booking slettet"),l(null)},onSettled:()=>{k()}});return{slots:c.data??[],isLoading:c.isLoading,isFetching:c.isFetching,apenSlotTid:o,setApenSlotTid:l,onBook:r=>h.mutate({baneId:n,dato:t,startTid:r.startTid,sluttTid:r.sluttTid}),onCancel:r=>v.mutate({baneId:n,dato:t,startTid:r.startTid,sluttTid:r.sluttTid}),onDelete:r=>j.mutate({baneId:r.baneId??n,dato:r.dato??t,startTid:r.startTid,sluttTid:r.sluttTid}),hentBookinger:c.refetch}}function ae({className:t,...n}){return e.jsx(q,{"data-slot":"checkbox",className:E("peer border-input dark:bg-input/30 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground dark:data-[state=checked]:bg-primary data-[state=checked]:border-primary focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive size-4 shrink-0 rounded-[4px] border shadow-xs transition-shadow outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50",t),...n,children:e.jsx(O,{"data-slot":"checkbox-indicator",className:"flex items-center justify-center text-current transition-none",children:e.jsx(V,{className:"size-3.5"})})})}function re({slot:t,onBook:n=()=>{},onCancel:a=()=>{},onDelete:s=()=>{},time:o,erBekreftet:l,setErBekreftet:i,reset:d=()=>{}}){return e.jsxs("div",{className:"flex flex-col items-end w-full",children:[t.kanBookes&&l!==void 0&&i&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center space-x-1 mb-2 text-sm",children:[e.jsx(ae,{id:`book-${o}`,checked:l,onCheckedChange:c=>i(!!c)}),e.jsxs("label",{htmlFor:`book-${o}`,className:"cursor-pointer select-none",children:["Jeg (og de jeg spiller sammen med) har betalt medlemskap for"," ",new Date().getFullYear()]})]}),e.jsxs(T,{variant:"outline",size:"sm",disabled:!l,onClick:()=>{n(t),d()},className:"flex items-center gap-2 text-sm",children:[e.jsx(M,{}),"Book"]})]}),t.kanAvbestille&&e.jsxs(T,{variant:"outline",size:"sm",onClick:()=>{a(t),d()},className:"flex items-center gap-2 text-sm",children:[e.jsx(Q,{}),"Avbestill"]}),t.kanSlette&&e.jsxs(T,{variant:"destructive",size:"sm",onClick:()=>{s(t),d()},className:"flex items-center gap-2 text-sm",children:[e.jsx(L,{}),"Slett"]})]})}function ne({slot:t,time:n,erBekreftet:a,setErBekreftet:s,onBook:o,onCancel:l,onDelete:i,reset:d}){return e.jsx("div",{className:"mt-1",children:e.jsx("div",{className:"bg-inherit",children:e.jsx(re,{slot:t,time:n,erBekreftet:a,setErBekreftet:s,onBook:o,onCancel:l,onDelete:i,reset:d})})})}function ie({slot:t,isOpen:n,erInteraktiv:a,currentUser:s,overrideTitle:o,leftPrefix:l}){const i=`${t.startTid.slice(0,2)}-${t.sluttTid.slice(0,2)}`,d=!!t.arrangementTittel,[c,g]=b.useState(!1);b.useEffect(()=>{const h=()=>g(window.innerWidth<640);return h(),window.addEventListener("resize",h),()=>window.removeEventListener("resize",h)},[]);const k=40,x=t.arrangementBeskrivelse&&c&&t.arrangementBeskrivelse.length>k?t.arrangementBeskrivelse.slice(0,k)+"...":t.arrangementBeskrivelse;return e.jsx("div",{className:"flex items-center",children:e.jsxs("div",{className:"flex flex-1 items-center justify-between min-w-0",children:[e.jsxs("div",{className:"flex items-center min-w-0",children:[l?e.jsx("div",{className:"mr-2 whitespace-nowrap text-xs text-muted-foreground flex items-center gap-1",children:l}):null,e.jsx("div",{className:"whitespace-nowrap font-semibold text-sm text-right pr-1",children:i}),l?null:e.jsx("div",{className:"w-[18px] h-[18px] flex items-center justify-center",children:t.værSymbol?e.jsx("img",{src:`/banebooking-voyager-fe/weather-symbols/svg/${t.værSymbol}.svg`,alt:t.værSymbol,width:18,height:18,className:"select-none",draggable:!1}):e.jsx("span",{className:"invisible",children:"."})}),e.jsx("div",{className:"flex-grow text-sm p-1 min-w-0",children:o?e.jsx("div",{className:"min-w-0 whitespace-nowrap truncate",children:o}):d?e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"font-medium truncate",children:t.arrangementTittel}),x?e.jsx("div",{className:"text-xs text-muted-foreground truncate",children:x}):null]}):e.jsx("div",{className:"min-w-0 whitespace-nowrap truncate",children:t.booketAv?s?t.booketAv:oe(t.booketAv):"Ledig"})})]}),a?e.jsx("div",{className:"p-1 shrink-0",children:e.jsx(I,{size:12,className:`transition-transform duration-200 ${n?"rotate-180":"rotate-0"}`,"aria-hidden":"true"})}):e.jsx("div",{className:"p-1 shrink-0"})]})})}function oe(t){const[n,a]=t.split("@");return!n||!a?t:`${n[0]}***@${a}`}function le({slot:t,currentUser:n,isOpen:a=!1,onToggle:s,onBook:o=()=>{},onCancel:l=()=>{},onDelete:i=()=>{},headerOverrideTitle:d,headerLeftPrefix:c,erInteraktivOverride:g}){const[k,x]=b.useState(!1),h=()=>x(!1),v=`${t.startTid.slice(0,2)}-${t.sluttTid.slice(0,2)}`,j=t.kanBookes||t.kanAvbestille||t.kanSlette,r=g??(!!n&&j&&!t.erPassert),u=!!t.arrangementTittel,m=t.erEier===!0,f=["rounded shadow-sm p-2 mb-2","transition-colors duration-300 ease-in-out",t.erPassert?"bg-muted text-muted-foreground border border-border":"",!t.erPassert&&u?"bg-card text-foreground border-l-4 border-l-primary border-y border-r border-border":"",!t.erPassert&&!u?"bg-card text-card-foreground border border-border":"",n&&m&&!u?"animate__animated animate__headShake animate__slow":""].join(" "),N=()=>{r&&s&&(s(),x(!1))};return e.jsxs("div",{className:`${f} ${r?"cursor-pointer":"cursor-default"} ${t.erPassert?"opacity-50":"opacity-100"}`,onClick:y=>{y.target.closest("button, input, label")||N()},role:r?"button":void 0,tabIndex:r?0:void 0,onKeyDown:y=>{r&&(y.key==="Enter"||y.key===" ")&&(y.preventDefault(),N())},children:[e.jsx(ie,{slot:t,isOpen:a,erInteraktiv:r,currentUser:n,overrideTitle:d,leftPrefix:c}),a&&!t.erPassert&&e.jsx(ne,{slot:t,time:v,erBekreftet:k,setErBekreftet:x,onBook:o,onCancel:l,onDelete:i,reset:h})]})}function ce({slots:t,currentUser:n,onBook:a,onCancel:s,onDelete:o,apenSlotTid:l,setApenSlotTid:i,isLoading:d=!1}){return d?e.jsx(B,{}):t.length===0?e.jsx("div",{className:"text-muted text-sm italic py-4 text-center",children:"Ingen bookinger eller slots å vise."}):e.jsx("div",{className:"space-y-2",children:t.map(c=>{const g=`${c.dato}-${c.startTid}-${c.baneId}`;return e.jsx(le,{slot:c,currentUser:n,onBook:a,onCancel:s,onDelete:o,isOpen:l===g,onToggle:()=>i?.(l===g?null:g)},g)})})}function de({children:t}){const{data:n,isLoading:a}=F();if(a||!n)return null;const{bookingRegel:s}=n;return e.jsxs(H,{children:[e.jsx(W,{asChild:!0,children:t}),e.jsxs(J,{children:[e.jsxs(Y,{children:[e.jsx(G,{children:"Bookingregler"}),e.jsx(X,{className:"sr-only",children:"Oversikt over bookingreglene i klubben"})]}),e.jsx("div",{className:"space-y-4",children:e.jsxs("ul",{className:"list-disc list-inside text-sm",children:[e.jsxs("li",{children:["Maks ",s.maksPerDag," bookinger per dag"]}),e.jsxs("li",{children:["Maks ",s.maksTotalt," aktive bookinger totalt"]}),e.jsxs("li",{children:["Opptil ",s.dagerFremITid," dager frem i tid"]}),e.jsxs("li",{children:[s.slotLengdeMinutter," minutter per booking"]}),e.jsxs("li",{children:["Tillatt mellom ",s.aapningstid,"–",s.stengetid]})]})})]})]})}function ue({baner:t,valgtBaneId:n,onBaneChange:a,valgtDato:s,onDatoChange:o,slots:l,isLoading:i,currentUser:d,apenSlotTid:c,setApenSlotTid:g,onBook:k,onCancel:x,onDelete:h}){return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsx(de,{children:e.jsx(T,{variant:"ghost",size:"icon",className:"rounded-full",title:"Vis banereglement",children:e.jsx(R,{className:"w-5 h-5"})})}),e.jsx(_,{value:s,onChange:v=>o(v??null),visNavigering:!0})]}),e.jsx(te,{items:t.map(v=>({value:v.id,label:v.navn,content:e.jsx(ce,{slots:l,currentUser:d?{epost:d.email??""}:null,apenSlotTid:c,setApenSlotTid:g,onBook:k,onCancel:x,onDelete:h,isLoading:i})})),value:n,onValueChange:a})]})}function me(){const{baner:t,isLoading:n}=z(!1),[a,s]=b.useState(""),[o,l]=b.useState(new Date),{currentUser:i}=P(),d=b.useMemo(()=>o?K(o,"yyyy-MM-dd"):"",[o]),{slots:c,apenSlotTid:g,setApenSlotTid:k,onBook:x,onCancel:h,onDelete:v,isLoading:j}=se(d,a);return b.useEffect(()=>{!a&&t.length>0&&s(t[0].id)},[t,a]),b.useEffect(()=>{k(null)},[o,a,k]),b.useEffect(()=>{i||k(null)},[i,k]),b.useEffect(()=>{o&&localStorage.setItem("valgtDato",o.toISOString())},[o]),n||!a?e.jsx(B,{}):e.jsx(ue,{baner:t,valgtBaneId:a,onBaneChange:s,valgtDato:o,onDatoChange:l,slots:c,isLoading:j,currentUser:i,apenSlotTid:g,setApenSlotTid:k,onBook:x,onCancel:h,onDelete:v})}function Te(){return e.jsx(D,{children:e.jsx(me,{})})}export{Te as default};
