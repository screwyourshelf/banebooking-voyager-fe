import{r as m}from"./shadcn-BW0HktFr.js";import{m as F,h as T,u as w,f as L,d as C,e as v,t as f}from"./index-BWn9U0qn.js";import{u as I}from"./useBaner-B8f9R8Ud.js";function R(e,r,n,s){const l=s?.requireAuth??!1;return F({queryKey:e,enabled:(s?.enabled??!0)&&n!=null,retry:!1,...s,queryFn:async({signal:u})=>(await T.post(r,n,{requireAuth:l,signal:u,timeout:2e4,...s?.axiosConfig??{}})).data})}function k(e){const[r,n]=e.split(":").map(Number);return r*60+n}function B(e){const r=String(Math.floor(e/60)).padStart(2,"0"),n=String(e%60).padStart(2,"0");return`${r}:${n}`}function E(e,r,n){const s=k(e),l=k(r),u=[];for(let c=s;c+n<=l;c+=n)u.push(B(c));return u}const j={ledige:[],konflikter:[]};function x(e){const r={...e,ukedager:[...e.ukedager].sort(),tidspunkter:[...e.tidspunkter].sort(),baneIder:[...e.baneIder].sort()};return JSON.stringify(r)}function P(e){const r=w(),{data:n,isLoading:s}=L(e),{baner:l,isLoading:u}=I(e),c=m.useMemo(()=>{if(!n?.bookingRegel)return[];const t=n.bookingRegel.aapningstid||"08:00",i=n.bookingRegel.stengetid||"22:00",a=n.bookingRegel.slotLengdeMinutter||60;return E(t,i,a)},[n]),o=m.useMemo(()=>["arrangementer",e],[e]),g=C(o,`/klubb/${e}/arrangement/kommende`,{enabled:!!e,requireAuth:!0,staleTime:3e4,select:t=>[...t].sort((i,a)=>i.startDato.localeCompare(a.startDato))}),[d,y]=m.useState(null),A=m.useMemo(()=>!e||!d?["arrangement-forhandsvis","disabled"]:["arrangement-forhandsvis",e,x(d)],[e,d]),p=R(A,`/klubb/${e}/arrangement/forhandsvis`,e?d:null,{requireAuth:!0,enabled:!!e&&!!d,staleTime:6e4,retry:!1}),Q=p.data??j,q=p.isFetching,K=async t=>e?(y(t),{success:!0}):{success:!1},b=()=>{y(null),e&&(r.cancelQueries({queryKey:["arrangement-forhandsvis",e]}),r.removeQueries({queryKey:["arrangement-forhandsvis",e]}))},M=v("post",`/klubb/${e}/arrangement`,{onSuccess:async t=>{b(),f.success(`${t.opprettet.length} bookinger opprettet`),await r.invalidateQueries({queryKey:o})},onError:t=>f.error(t.message??"Feil ved oppretting"),retry:!1}),S=async t=>e?{success:!0,result:await M.mutateAsync(t)}:{success:!1},h=v("delete",({arrangementId:t})=>`/klubb/${e}/arrangement/${t}`,{onMutate:async({arrangementId:t})=>{if(!e)return{};await r.cancelQueries({queryKey:o});const i=r.getQueryData(o);return r.setQueryData(o,a=>(a??[]).filter(D=>D.id!==t)),{previous:i}},onError:(t,i,a)=>{f.error(t.message??"Kunne ikke slette arrangementet"),a?.previous&&r.setQueryData(o,a.previous)},onSuccess:t=>{f.success(`Arrangementet ble avlyst â€“ ${t.antallBookingerDeaktivert} bookinger fjernet`)},onSettled:async()=>{e&&await r.invalidateQueries({queryKey:o})},retry:!1}),$=async t=>{e&&await h.mutateAsync({arrangementId:t})};return{klubb:n,baner:l,tilgjengeligeTidspunkter:c,arrangementer:g.data??[],forhandsvisning:Q,forhandsvis:K,clearForhandsvisning:b,opprett:S,slettArrangement:$,refetchArrangementer:g.refetch,isLoading:s||u||g.isLoading,isLoadingForhandsvisning:q,sletterArrangementId:h.variables?.arrangementId??null}}export{P as u};
