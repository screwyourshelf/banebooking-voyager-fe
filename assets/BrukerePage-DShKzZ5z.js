import{r as n,j as c}from"./shadcn-BfUXmlP3.js";import{f as M,d as K,i as D,L as U,B,t as L}from"./index-CZ7yxNIj.js";import{C as $,a as P}from"./FieldWrapper--7bcjA_e.js";import{F as q}from"./FormField-BuG9kLHv.js";import{S as O}from"./SelectField-6ZkCjNlN.js";import"./react-D5d5vywP.js";import"./lucide-CZTSiasK.js";import"./index-36j8ZHWB.js";async function W(t,e){const u=await M(`/api/klubb/${t}/bruker/sok?query=${encodeURIComponent(e.trim())}`,{method:"GET"},!0);if(!u.ok){const o=await u.text();throw new Error(o||"Kunne ikke hente brukere")}return await u.json()}async function z(t,e,u){const o=await M(`/api/klubb/${t}/bruker/${e}/rolle`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(u)},!0);if(!o.ok){const i=await o.text();throw new Error(i||"Kunne ikke oppdatere rolle")}}function I(t,e,u){var o=this,i=n.useRef(null),f=n.useRef(0),s=n.useRef(null),l=n.useRef([]),m=n.useRef(),d=n.useRef(),g=n.useRef(t),v=n.useRef(!0);g.current=t;var w=typeof window<"u",b=!e&&e!==0&&w;if(typeof t!="function")throw new TypeError("Expected a function");e=+e||0;var R=!!(u=u||{}).leading,E=!("trailing"in u)||!!u.trailing,r="maxWait"in u,p="debounceOnServer"in u&&!!u.debounceOnServer,a=r?Math.max(+u.maxWait||0,e):null;n.useEffect(function(){return v.current=!0,function(){v.current=!1}},[]);var k=n.useMemo(function(){var y=function(h){var x=l.current,S=m.current;return l.current=m.current=null,f.current=h,d.current=g.current.apply(S,x)},j=function(h,x){b&&cancelAnimationFrame(s.current),s.current=b?requestAnimationFrame(h):setTimeout(h,x)},N=function(h){if(!v.current)return!1;var x=h-i.current;return!i.current||x>=e||x<0||r&&h-f.current>=a},F=function(h){return s.current=null,E&&l.current?y(h):(l.current=m.current=null,d.current)},C=function h(){var x=Date.now();if(N(x))return F(x);if(v.current){var S=e-(x-i.current),T=r?Math.min(S,a-(x-f.current)):S;j(h,T)}},A=function(){if(w||p){var h=Date.now(),x=N(h);if(l.current=[].slice.call(arguments),m.current=o,i.current=h,x){if(!s.current&&v.current)return f.current=i.current,j(C,e),R?y(i.current):d.current;if(r)return j(C,e),y(i.current)}return s.current||j(C,e),d.current}};return A.cancel=function(){s.current&&(b?cancelAnimationFrame(s.current):clearTimeout(s.current)),f.current=0,l.current=i.current=m.current=s.current=null},A.isPending=function(){return!!s.current},A.flush=function(){return s.current?F(Date.now()):d.current},A},[R,r,e,a,E,b,w,p]);return k}function Q(t,e){return t===e}function G(t,e,u){var o=Q,i=n.useRef(t),f=n.useState({})[1],s=I(n.useCallback(function(m){i.current=m,f({})},[f]),e,u),l=n.useRef(t);return o(l.current,t)||(s(t),l.current=t),[i.current,s]}function J(t,e=""){const[u,o]=n.useState([]),[i,f]=n.useState(!1),[s,l]=n.useState(null),[m]=G(e.trim(),300);return n.useEffect(()=>{if(!t||m.length<2)return;const d=new AbortController;return f(!0),W(t,m).then(g=>{d.signal.aborted||(o(g),l(null))}).catch(g=>{d.signal.aborted||(l(g.message),o([]))}).finally(()=>{d.signal.aborted||f(!1)}),()=>d.abort()},[t,m]),{brukere:u,laster:i,feil:s}}function te(){const{slug:t}=K(),{bruker:e,laster:u}=D(t),[o,i]=n.useState(""),{brukere:f,laster:s,feil:l}=J(t,o),[m,d]=n.useState({}),[g,v]=n.useState({}),w=e==null?void 0:e.roller.includes("KlubbAdmin"),b=(r,p)=>{d(a=>({...a,[r]:p}))},R=r=>{d(p=>{const a={...p};return delete a[r],a})},E=async r=>{if(!t)return;const p=m[r];if(p)try{await z(t,r,p),L.success("Rolle oppdatert"),v(a=>({...a,[r]:p})),d(a=>{const k={...a};return delete k[r],k})}catch(a){L.error(a instanceof Error?a.message:"Ukjent feil ved oppdatering")}};return n.useEffect(()=>{d({})},[o]),u?c.jsx(U,{}):w?c.jsx("div",{className:"max-w-screen-sm mx-auto px-2 py-2 space-y-4",children:c.jsx($,{children:c.jsxs(P,{className:"p-4 space-y-4",children:[c.jsx(q,{id:"sok",label:"Søk etter bruker",value:o,onChange:r=>i(r.target.value),helpText:"F.eks. navn eller e-post"}),s&&c.jsx("p",{children:"Laster brukere..."}),!s&&l&&c.jsx("p",{className:"text-red-600",children:l}),!s&&f.length===0&&!l&&c.jsx("p",{className:"text-muted-foreground",children:"Ingen brukere funnet"}),f.map(r=>{const p=r.id===(e==null?void 0:e.id),a=g[r.id]??r.roller[0]??"Medlem",k=m[r.id]??a,y=k!==a;return c.jsxs("div",{className:"border rounded p-3 space-y-2",children:[c.jsx("div",{className:"font-medium",children:r.epost}),c.jsxs("div",{className:"text-sm text-muted-foreground",children:["Nåværende rolle: ",c.jsx("strong",{children:a})]}),c.jsx(O,{id:`rolle-${r.id}`,label:p?"Du kan ikke endre din egen rolle":"Endre rolle",value:k,onChange:j=>b(r.id,j),disabled:p,options:[{label:"Medlem",value:"Medlem"},{label:"Utvidet",value:"Utvidet"},{label:"KlubbAdmin",value:"KlubbAdmin"}]}),!p&&c.jsxs("div",{className:"flex gap-2",children:[c.jsx(B,{size:"sm",onClick:()=>E(r.id),disabled:!y,children:"Lagre"}),c.jsx(B,{size:"sm",variant:"ghost",onClick:()=>R(r.id),disabled:!y,children:"Avbryt"})]})]},r.id)})]})})}):c.jsx("p",{className:"text-sm text-destructive px-2 py-2 text-center",children:"Du har ikke tilgang til denne siden."})}export{te as default};
