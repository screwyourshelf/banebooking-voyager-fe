import{r as g,j as e}from"./shadcn-DDUjAgUv.js";import{u as A}from"./useSlug-DGcvY4vP.js";import{P as L}from"./Page-Cq3gZojq.js";import{S as V}from"./SimpleTabsLazy-Cch1SZpp.js";import{f as h,e as C,g as D,h as j,t as u,L as f,B as v,d as M,i as P}from"./index-DPErGzPN.js";import{F as B,a as k}from"./FormField-CghnZKEh.js";import{P as w}from"./PageSection-CrgFjiMc.js";import{A as F,a as K,b as $,c as O,d as R,e as q,f as H,g as Q,h as U}from"./alert-dialog-DuleFzxY.js";import{f as T}from"./datoUtils-Bzity_GL.js";import{T as _,a as G,b as y,c as p,d as z,e as x}from"./table-DHXwnfa5.js";import{b as I}from"./booking-HRtkDR5-.js";import"./react-RGnvvjkK.js";import"./lucide-Bc72fHhV.js";import"./index-CZuuFr9-.js";async function J(n){const t=await h(`/api/klubb/${n}/bruker/meg/egen-data`,{method:"GET"},!0);if(!t.ok){const c=await t.text();throw new Error(c||"Kunne ikke hente egen data")}const r=await t.blob(),a=window.URL.createObjectURL(r),i=document.createElement("a");i.href=a,i.download=`banebooking-data-${new Date().toISOString().slice(0,10)}.json`,document.body.appendChild(i),i.click(),i.remove(),window.URL.revokeObjectURL(a)}async function W(n){const t=await h(`/api/klubb/${n}/bruker/meg`,{method:"GET"},!0);if(!t.ok){const r=await t.text();throw new Error(r||"Kunne ikke hente meg")}return await t.json()}async function X(n,t){const r=await h(`/api/klubb/${n}/bruker/meg`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)},!0);if(!r.ok){const a=await r.text();throw new Error(a||"Kunne ikke oppdatere visningsnavn")}}async function Y(n){const t=await h(`/api/klubb/${n}/bruker/meg`,{method:"DELETE"},!0);if(!t.ok){const r=await t.text();throw new Error(r||"Kunne ikke slette brukeren")}}function E(n){const t=C(),r=D({queryKey:["meg",n],queryFn:()=>W(n),enabled:!!n,staleTime:1e3*60*1,onError:s=>u.error(s.message??"Kunne ikke hente brukerdata")}),a=j({mutationFn:s=>X(n,{visningsnavn:s}),onSuccess:(s,l)=>{t.setQueryData(["meg",n],d=>d&&{...d,visningsnavn:l}),u.success("Visningsnavn lagret")},onError:s=>u.error(s.message??"Kunne ikke lagre visningsnavn")}),i=j({mutationFn:()=>Y(n),onSuccess:()=>{t.removeQueries({queryKey:["meg",n]}),u.success("Brukeren er slettet")},onError:s=>u.error(s.message??"Kunne ikke slette bruker")}),c=async()=>{if(n)try{await J(n),u.success("Dataen din lastes nå ned")}catch(s){const l=s instanceof Error?s.message:"Kunne ikke laste ned data";u.error(l)}};return{bruker:r.data,laster:r.isLoading,feil:r.error,refetch:r.refetch,oppdaterVisningsnavn:a,slettMeg:i,lastNedEgenData:c}}const b=50,Z=/^[\p{L}\d\s.@'_%+-]{2,}$/u;function ee({slug:n}){const{bruker:t,laster:r,oppdaterVisningsnavn:a}=E(n),[i,c]=g.useState(""),[s,l]=g.useState(!1),[d,m]=g.useState(null);g.useEffect(()=>{if(t){const o=t.visningsnavn?.trim();!o||o===t.epost?(l(!0),c("")):(c(o),l(!1))}},[t]);const N=async()=>{if(!t)return;if(s){m(null),await a.mutateAsync(t.epost);return}const o=i.trim();if(o.length===0){m("Visningsnavn kan ikke være tomt.");return}if(o.length<3){m("Visningsnavn må være minst 3 tegn.");return}if(!Z.test(o)){m("Visningsnavn inneholder ugyldige tegn.");return}if(o.length>b){m(`Visningsnavn kan ikke være lengre enn ${b} tegn.`);return}m(null),await a.mutateAsync(o)},S=t?s?t.visningsnavn!==t.epost:i.trim()!==t.visningsnavn:!1;return r||!t?e.jsx(f,{}):e.jsxs(e.Fragment,{children:[e.jsxs("form",{className:"space-y-4",onSubmit:o=>{o.preventDefault(),N()},children:[e.jsx(B,{id:"visningsnavn",label:"Visningsnavn",value:s?"":i,maxLength:b,placeholder:t?.epost||"f.eks. Ola Nordmann",onChange:o=>{c(o.target.value),l(!1)},disabled:s,error:d,helpText:"Navnet vises i grensesnittet, og settes automatisk til e-post ved første innlogging."}),e.jsxs("label",{className:"flex items-center space-x-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:s,onChange:o=>{l(o.target.checked),o.target.checked&&c("")}}),e.jsx("span",{children:"Bruk e-post som visningsnavn"})]}),e.jsx(v,{type:"submit",size:"sm",disabled:!S||a.isPending,children:a.isPending?"Lagrer...":"Lagre"})]}),e.jsxs(w,{bordered:!0,className:"space-y-4",children:[e.jsx(k,{id:"epost",label:"Brukernavn / ID",children:e.jsx("p",{className:"text-sm text-foreground",children:t.epost})}),e.jsx(k,{id:"rolle",label:"Rolle (i klubben)",helpText:"Roller tildeles av klubbens administrator og kan ikke endres manuelt.",children:e.jsx("p",{className:"text-sm text-foreground",children:t.roller.join(", ")})})]})]})}function te({slettMeg:n}){const{signOut:t}=M(),[r,a]=g.useState(!1),i=async()=>{try{await n.mutateAsync(),a(!1),await t()}catch{}};return e.jsxs(F,{open:r,onOpenChange:a,children:[e.jsx(K,{asChild:!0,children:e.jsx(v,{variant:"destructive",children:"Slett min bruker"})}),e.jsxs($,{children:[e.jsxs(O,{children:[e.jsx(R,{children:"Er du sikker?"}),e.jsx(q,{children:"Dette vil slette din bruker og all tilknytning permanent. Denne handlingen kan ikke angres."})]}),e.jsxs(H,{children:[e.jsx(Q,{disabled:n.isPending,children:"Avbryt"}),e.jsx(U,{variant:"destructive",onClick:i,disabled:n.isPending,children:n.isPending?"Sletter...":"Slett bruker"})]})]})]})}function ne({slug:n}){const{bruker:t,laster:r,lastNedEgenData:a,slettMeg:i}=E(n);return r||!t?e.jsx(f,{}):e.jsxs(w,{bordered:!0,className:"space-y-4",children:[e.jsxs(k,{id:"vilkaar",label:"Vilkår for bruk",helpText:"Du aksepterer vilkårene automatisk ved første innlogging.",children:[t.vilkaarAkseptertDato?e.jsxs("p",{className:"text-sm text-foreground",children:["Akseptert ",T(t.vilkaarAkseptertDato)," ",t.vilkaarVersjon&&`(versjon ${t.vilkaarVersjon})`]}):e.jsx("p",{className:"text-sm text-muted-foreground italic",children:"Ikke registrert"}),e.jsx("p",{className:"text-sm mt-1",children:e.jsx(P,{to:`/${n}/vilkaar`,className:"underline text-primary hover:text-primary/80",target:"_blank",rel:"noopener noreferrer",children:"Les vilkårene"})})]}),e.jsx(k,{id:"last-ned-data",label:"Last ned dine data",helpText:"Du kan laste ned alle registrerte opplysninger og bookinger i JSON-format.",children:e.jsx(v,{onClick:a,size:"sm",variant:"outline",children:"Last ned data"})}),e.jsx(k,{id:"slett-bruker",label:"Slett bruker",helpText:"Dette sletter brukeren din og all tilknyttet data permanent.",children:e.jsx(te,{slettMeg:i})})]})}function re(n,t=!1){return D({queryKey:["mineBookinger",n,t],queryFn:async()=>n?await I(n,t):[],enabled:!!n,staleTime:1e3*60,onError:r=>{u.error(r.message??"Ukjent feil ved henting av bookinger")}})}function se({slug:n}){const[t,r]=g.useState(!1),{data:a=[],isLoading:i}=re(n,t),c=[...a].sort((s,l)=>{const d=new Date(l.dato).getTime()-new Date(s.dato).getTime();return d!==0?d:l.startTid.localeCompare(s.startTid)});return i?e.jsx(f,{}):e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"flex items-center space-x-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:t,onChange:s=>r(s.target.checked)}),e.jsx("span",{children:"Vis også tidligere bookinger"})]}),c.length===0?e.jsx("p",{className:"text-sm text-muted-foreground italic",children:t?"Du har ingen registrerte bookinger.":"Du har ingen kommende bookinger."}):e.jsx("div",{className:"overflow-auto max-h-[60vh] border rounded-md",children:e.jsxs(_,{className:"text-sm",children:[e.jsx(G,{children:e.jsxs(y,{children:[e.jsx(p,{children:"Dato"}),e.jsx(p,{children:"Tid"}),e.jsx(p,{children:"Bane"})]})}),e.jsx(z,{children:c.map((s,l)=>e.jsxs(y,{children:[e.jsx(x,{children:T(s.dato)}),e.jsxs(x,{children:[s.startTid,"–",s.sluttTid]}),e.jsx(x,{children:s.baneNavn})]},l))})]})})]})}function fe(){const[n,t]=g.useState("persondata"),r=A();return e.jsx(L,{children:e.jsx(V,{items:[{value:"bookinger",label:"Mine bookinger",content:e.jsx(se,{slug:r})},{value:"profil",label:"Min profil",content:e.jsx(ee,{slug:r})},{value:"persondata",label:"Persondata",content:e.jsx(ne,{slug:r})}],value:n,onValueChange:t})})}export{fe as default};
