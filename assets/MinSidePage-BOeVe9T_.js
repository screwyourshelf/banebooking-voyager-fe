import{j as e,r as u}from"./shadcn-mOdBhBu9.js";import{P as w}from"./Page-DGRPpX6y.js";import{S as M}from"./SimpleTabsLazy-HWGk_Ewh.js";import{u as A,b as $,c as N,t as v,f as B,L,F as I,B as y,e as O,g as R,a as K}from"./index-CYoHqIT9.js";import{S as f,a as S}from"./SettingsRow-SsVQpD69.js";import{S as x}from"./SettingsSection-DgasYiYd.js";import{A as F,a as H,b as U,c as q,d as Q,e as _,f as z,g as G,h as X}from"./alert-dialog-BlISq4n6.js";import{f as D}from"./datoUtils-CMdMNzgI.js";import{S as J}from"./SwitchRow-Chp0owzM.js";import{B as W}from"./BookingSlotItem-DqZFsrZ2.js";import"./react-RGnvvjkK.js";import"./lucide-ByENZzyU.js";import"./index-BRMy6Ggk.js";import"./switch-rJg2FX1a.js";import"./index-Bb2dXpgu.js";import"./checkbox-C6XQ3Q6l.js";function T({label:n,value:s,description:a,className:i=""}){return e.jsx(f,{title:n,description:a,className:i,children:s})}function P(){const n=A(),s=$(["meg",n],`/klubb/${n}/bruker/meg`,{requireAuth:!0,staleTime:6e4}),a=N("patch",`/klubb/${n}/bruker/meg`,{onSuccess:()=>{v.success("Visningsnavn oppdatert"),s.refetch()},onError:r=>{v.error(r.message??"Kunne ikke oppdatere visningsnavn")}}),i=N("delete",`/klubb/${n}/bruker/meg`,{onSuccess:()=>v.success("Brukeren er slettet"),onError:r=>v.error(r.message??"Kunne ikke slette bruker")}),g=async()=>{try{const r=await B.get(`/klubb/${n}/bruker/meg/egen-data`,{requireAuth:!0,responseType:"blob"}),o=r.data,p=r.headers?.["content-disposition"]?.match(/filename\*=UTF-8''([^;]+)|filename="?([^"]+)"?/i),t=decodeURIComponent(p?.[1]??p?.[2]??"")||`banebooking-data-${new Date().toISOString().slice(0,10)}.json`,c=URL.createObjectURL(o),d=document.createElement("a");d.href=c,d.download=t,document.body.appendChild(d),d.click(),d.remove(),URL.revokeObjectURL(c)}catch(r){const o=r instanceof Error?r.message:"Kunne ikke laste ned egen data";v.error(o)}};return{bruker:s.data,laster:s.isLoading,error:s.error,refetch:s.refetch,lastNedEgenData:g,oppdaterVisningsnavn:a,slettMeg:i}}const b=50,Y=/^[\p{L}\d\s.@'_%+-]{2,}$/u;function Z(){const{bruker:n,laster:s,oppdaterVisningsnavn:a}=P(),{mutateAsync:i,isPending:g}=a,[r,o]=u.useState("epost"),[m,p]=u.useState(""),[k,t]=u.useState(null);u.useEffect(()=>{if(!n)return;const l=n.visningsnavn?.trim();!l||l===n.epost?(o("epost"),p("")):(o("navn"),p(l)),t(null)},[n]);const c=u.useMemo(()=>n?r==="epost"?n.epost:m.trim():"",[n,r,m]),d=u.useMemo(()=>{if(!n)return"Ukjent feil.";if(r==="epost")return null;const l=m.trim();return l.length===0?"Visningsnavn kan ikke være tomt.":l.length<3?"Visningsnavn må være minst 3 tegn.":Y.test(l)?l.length>b?`Visningsnavn kan ikke være lengre enn ${b} tegn.`:null:"Visningsnavn inneholder ugyldige tegn."},[n,r,m]),V=u.useMemo(()=>{if(!n)return!1;const l=c,h=(n.visningsnavn??"").trim();return l.length===0||l===h?!1:r==="navn"?!d:!0},[n,c,r,d]);async function j(){n&&(t(d),!d&&await i({visningsnavn:c}))}return s||!n?e.jsx(L,{}):e.jsxs("div",{className:"space-y-4",children:[e.jsx(x,{title:"Min profil",description:"Velg hva som vises som navnet ditt i appen.",children:e.jsxs(S,{children:[e.jsx(f,{title:"Visningsnavn",description:"Velg e-post eller et eget navn.",children:e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"flex items-center gap-2 text-sm cursor-pointer select-none",children:[e.jsx("input",{type:"radio",name:"visningsnavn-mode",checked:r==="epost",onChange:()=>{o("epost"),t(null)}}),e.jsxs("span",{children:["E-post (",n.epost,")"]})]}),e.jsxs("label",{className:"flex items-center gap-2 text-sm cursor-pointer select-none",children:[e.jsx("input",{type:"radio",name:"visningsnavn-mode",checked:r==="navn",onChange:()=>{o("navn"),t(null)}}),e.jsx("span",{children:"Eget navn"})]})]})}),r==="navn"?e.jsx(f,{title:"Eget navn",description:`Maks ${b} tegn.`,children:e.jsx(I,{id:"visningsnavn",label:"Eget navn",hideLabel:!0,value:m,error:k,onChange:l=>{p(l.target.value),k&&t(null)},inputProps:{placeholder:"f.eks. Ola Nordmann",maxLength:b}})}):null,e.jsx(f,{title:"Dette vil lagres",description:"Slik vil navnet ditt vises.",right:e.jsx(y,{type:"button",size:"sm",disabled:!V||g,onClick:()=>void j(),children:g?"Lagrer...":"Lagre"}),children:e.jsx("div",{className:"text-sm text-foreground break-words",children:c})})]})}),e.jsx(x,{title:"Konto",description:"Denne informasjonen kan bare endres av klubbadministrator.",children:e.jsxs(S,{children:[e.jsx(T,{label:"Brukernavn / ID",value:n.epost}),e.jsx(T,{label:"Tilgang",value:n.roller.join(", ")})]})})]})}function ee({slettMeg:n}){const{signOut:s}=O(),[a,i]=u.useState(!1),g=async()=>{try{await n.mutateAsync(),i(!1),await s()}catch{}};return e.jsxs(F,{open:a,onOpenChange:i,children:[e.jsx(H,{asChild:!0,children:e.jsx(y,{variant:"destructive",disabled:n.isPending,children:n.isPending?"Sletter...":"Slett min bruker"})}),e.jsxs(U,{children:[e.jsxs(q,{children:[e.jsx(Q,{children:"Er du sikker?"}),e.jsx(_,{children:"Dette vil slette din bruker og all tilknytning permanent. Denne handlingen kan ikke angres."})]}),e.jsxs(z,{children:[e.jsx(G,{disabled:n.isPending,children:"Avbryt"}),e.jsx(X,{asChild:!0,children:e.jsx(y,{variant:"destructive",onClick:g,disabled:n.isPending,children:n.isPending?"Sletter...":"Slett bruker"})})]})]})]})}function ne(){const n=A(),{bruker:s,laster:a,lastNedEgenData:i,slettMeg:g}=P(),[r,o]=u.useState(!1);if(a||!s)return e.jsx(L,{});const m=s.vilkaarAkseptertDato?`Akseptert ${D(s.vilkaarAkseptertDato)}${s.vilkaarVersjon?` (versjon ${s.vilkaarVersjon})`:""}`:"Ikke registrert",p=async()=>{if(!r)try{o(!0),await i()}catch(k){const t=k instanceof Error?k.message:"Kunne ikke laste ned egen data";v.error(t)}finally{o(!1)}};return e.jsxs("div",{className:"space-y-4",children:[e.jsx(x,{title:"Persondata",description:"Her kan du se vilkår og laste ned egne data.",children:e.jsxs(S,{children:[e.jsx(T,{label:"Vilkår",description:"Vilkårene aksepteres automatisk ved første innlogging.",value:m}),e.jsx(f,{title:"Les vilkårene",description:"Åpnes i ny fane.",right:e.jsx(R,{to:`/${n}/vilkaar`,className:"text-sm underline text-primary hover:text-primary/80",target:"_blank",rel:"noopener noreferrer",children:"Åpne"})}),e.jsx(f,{title:"Last ned dine data",description:"JSON med registrerte opplysninger og bookinger.",right:e.jsx(y,{onClick:p,size:"sm",variant:"outline",disabled:r||g.isPending,children:r?"Laster...":"Last ned"})})]})}),e.jsx(x,{title:"Slett bruker",description:"Sletter bruker og all tilknyttet data permanent.",children:e.jsx(S,{children:e.jsx(f,{title:"",description:"Dette kan ikke angres.",right:e.jsx(ee,{slettMeg:g})})})})]})}function te(n=!1){const s=A(),a=$(["mineBookinger",s,n],`/klubb/${s}/bookinger/mine${n?"?inkluderHistoriske=true":""}`,{requireAuth:!0,staleTime:6e4}),i=u.useRef(!1);return u.useEffect(()=>{if(!a.error){i.current=!1;return}i.current||(v.error(a.error.message??"Ukjent feil ved henting av bookinger"),i.current=!0)},[a.error]),a}function se(){const n=A(),s=K(),a=()=>{s.invalidateQueries({queryKey:["mineBookinger",n]}),s.invalidateQueries({queryKey:["bookinger",n]})},i=N("delete",`/klubb/${n}/bookinger`,{onError:o=>{v.error(o.message??"Kunne ikke avbestille.")},onSuccess:()=>{v.info("Bookingen er avbestilt.")},onSettled:()=>{a()}});return{avbestill:o=>{i.mutate(o)},avbestillAsync:async o=>i.mutateAsync(o),isPending:i.isPending}}function re(){const[n,s]=u.useState(!1),{data:a=[],isLoading:i}=te(n),{avbestillAsync:g,isPending:r}=se(),[o,m]=u.useState(null),p=u.useMemo(()=>[...a].sort((t,c)=>{const d=new Date(c.dato).getTime()-new Date(t.dato).getTime();return d!==0?d:c.startTid.localeCompare(t.startTid)}),[a]);async function k(t){r||(await g({baneId:t.baneId,dato:t.dato,startTid:t.startTid,sluttTid:t.sluttTid}),m(null))}return i?e.jsx(L,{}):e.jsx("div",{className:"space-y-4",children:e.jsx(x,{title:"Bookinger",description:"Se kommende bookinger og velg om du vil inkludere tidligere.",children:e.jsxs("div",{className:"space-y-3",children:[e.jsx(J,{title:"Vis også tidligere bookinger",description:"Inkluder bookinger som allerede er gjennomført.",checked:n,onCheckedChange:t=>{s(t),m(null)}}),p.length===0?e.jsx("div",{className:"text-sm text-muted-foreground italic",children:n?"Du har ingen registrerte bookinger.":"Du har ingen kommende bookinger."}):e.jsx("div",{className:r?"pointer-events-none opacity-60":"",children:p.map(t=>{const c=`${t.baneId}-${t.dato}-${t.startTid}-${t.sluttTid}`,d=o===c,j=!!t.kanAvbestille&&!t.erPassert,l=typeof t.temperatur=="number",h=typeof t.vind=="number",C=!!t.værSymbol||l||h?e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx("span",{children:D(t.dato)}),e.jsx("span",{className:"w-[18px] h-[18px] flex items-center justify-center",children:t.værSymbol?e.jsx("img",{src:`/banebooking-voyager-fe/weather-symbols/svg/${t.værSymbol}.svg`,alt:t.værSymbol,width:18,height:18,className:"select-none",draggable:!1}):e.jsx("span",{className:"invisible",children:"."})}),l||h?e.jsxs("span",{className:"text-[11px] text-muted-foreground",children:[l?`${t.temperatur}°`:null,l&&h?" · ":null,h?`${t.vind} m/s`:null]}):null]}):e.jsx("span",{className:"flex items-center gap-1",children:e.jsx("span",{children:D(t.dato)})});return e.jsx(W,{slot:t,currentUser:null,erInteraktivOverride:j,isOpen:d,onToggle:()=>{j&&m(E=>E===c?null:c)},onCancel:()=>void k(t),headerOverrideTitle:t.baneNavn,headerLeftPrefix:C},c)})})]})})})}function ye(){const[n,s]=u.useState("bookinger");return e.jsx(w,{children:e.jsx(M,{items:[{value:"bookinger",label:"Mine bookinger",content:e.jsx(re,{})},{value:"profil",label:"Min profil",content:e.jsx(Z,{})},{value:"persondata",label:"Persondata",content:e.jsx(ne,{})}],value:n,onValueChange:s})})}export{ye as default};
