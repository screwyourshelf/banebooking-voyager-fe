import{j as e,r as u}from"./shadcn-ciDZoPHa.js";import{P}from"./Page-DY-nzD88.js";import{T as E,a as B,b as I,c as M}from"./tabs-Bsc7dcri.js";import{u as y,b as D,t as f,a as F,c as N,f as K,L as V,g as O,T as R,B as b,e as H,h as U}from"./index-DwBi739w.js";import{F as k,P as h}from"./FieldRow-CWaEdzBa.js";import{F as j,a as x}from"./FieldList-BQUYp8es.js";import{S as q}from"./SwitchRow-D5BQ59Qn.js";import{B as G}from"./BookingSlotItem-CabGTjOz.js";import{f as S}from"./datoUtils-CMdMNzgI.js";import{A as Q,a as _,b as z,c as X,d as J,e as W,f as Y,g as Z,h as ee}from"./alert-dialog-DYz4occH.js";import"./react-RGnvvjkK.js";import"./lucide-DUUYvuJp.js";import"./switch-HPBUd7c1.js";import"./index-4Vwc2qQR.js";import"./checkbox-BrPP86He.js";import"./index-DkVNnv8l.js";function ne({items:n,className:t="",value:r,onValueChange:s,defaultValue:c}){const i=n[0];if(!i)return null;const o=c??i.value,l=r&&n.some(a=>a.value===r)?r:void 0;return e.jsxs(E,{value:l,defaultValue:o,onValueChange:s,children:[e.jsx(B,{className:`flex flex-wrap gap-2 mb-2 ${t}`,children:n.map(a=>e.jsx(I,{value:a.value,children:a.label},a.value))}),n.map(a=>e.jsx(M,{value:a.value,className:"mt-0",children:a.content},a.value))]})}function te(n=!1){const t=y(),r=D(["mineBookinger",t,n],`/klubb/${t}/bookinger/mine${n?"?inkluderHistoriske=true":""}`,{requireAuth:!0,staleTime:6e4}),s=u.useRef(!1);return u.useEffect(()=>{if(!r.error){s.current=!1;return}s.current||(f.error(r.error.message??"Ukjent feil ved henting av bookinger"),s.current=!0)},[r.error]),r}function re(){const n=y(),t=F(),r=()=>{t.invalidateQueries({queryKey:["mineBookinger",n]}),t.invalidateQueries({queryKey:["bookinger",n]})},s=N("delete",`/klubb/${n}/bookinger`,{onError:o=>{f.error(o.message??"Kunne ikke avbestille.")},onSuccess:()=>{f.info("Bookingen er avbestilt.")},onSettled:()=>{r()}});return{avbestill:o=>{s.mutate(o)},avbestillAsync:async o=>s.mutateAsync(o),isPending:s.isPending}}function A({label:n,value:t,description:r,className:s,density:c="default"}){return e.jsx(k,{title:n,description:r,density:c,className:s,children:e.jsx("div",{className:K("text-sm text-foreground break-words"),children:t})})}function se({slot:n}){const t=typeof n.temperatur=="number",r=typeof n.vind=="number";return!!n.værSymbol||t||r?e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx("span",{children:S(n.dato)}),e.jsx("span",{className:"w-[18px] h-[18px] flex items-center justify-center",children:n.værSymbol?e.jsx("img",{src:`/banebooking-voyager-fe/weather-symbols/svg/${n.værSymbol}.svg`,alt:n.værSymbol,width:18,height:18,className:"select-none",draggable:!1}):e.jsx("span",{className:"invisible",children:"."})}),t||r?e.jsxs("span",{className:"text-[11px] text-muted-foreground",children:[t?`${n.temperatur}°`:null,t&&r?" · ":null,r?`${n.vind} m/s`:null]}):null]}):e.jsx("span",{className:"flex items-center gap-1",children:e.jsx("span",{children:S(n.dato)})})}function ie(n){return[...n].sort((t,r)=>{const s=new Date(r.dato).getTime()-new Date(t.dato).getTime();return s!==0?s:r.startTid.localeCompare(t.startTid)})}function ae(n){return`${n.baneId}-${n.dato}-${n.startTid}-${n.sluttTid}`}function oe({visHistoriske:n,onToggleVisHistoriske:t,bookinger:r,isPending:s,openKey:c,onToggleOpenKey:i,onAvbestill:o}){return e.jsx("div",{className:"space-y-4",children:e.jsx(h,{title:"Bookinger",description:"Se kommende bookinger og velg om du vil inkludere tidligere.",children:e.jsxs("div",{className:"space-y-3",children:[e.jsx(j,{children:e.jsxs(x,{children:[e.jsx(q,{title:"Vis også tidligere bookinger",description:"Inkluder bookinger som allerede er gjennomført.",checked:n,onCheckedChange:t}),r.length===0?e.jsx("div",{className:"px-3 py-2 text-sm text-muted-foreground italic",children:n?"Du har ingen registrerte bookinger.":"Du har ingen kommende bookinger."}):null]})}),r.length>0?e.jsx("div",{className:s?"pointer-events-none opacity-60":"",children:r.map(l=>{const a=ae(l),g=c===a,m=!!l.kanAvbestille&&!l.erPassert;return e.jsx(G,{slot:l,currentUser:null,erInteraktivOverride:m,isOpen:g,onToggle:()=>{m&&i(g?null:a)},onCancel:()=>o(l),headerOverrideTitle:l.baneNavn,headerLeftPrefix:e.jsx(se,{slot:l})},a)})}):null]})})})}function le(){const[n,t]=u.useState(!1),[r,s]=u.useState(null),{data:c=[],isLoading:i}=te(n),{avbestillAsync:o,isPending:l}=re(),a=u.useMemo(()=>ie(c),[c]);async function g(d){l||(await o({baneId:d.baneId,dato:d.dato,startTid:d.startTid,sluttTid:d.sluttTid}),s(null))}return i?e.jsx(V,{}):e.jsx(oe,{visHistoriske:n,onToggleVisHistoriske:d=>{t(d),s(null)},bookinger:a,isPending:l,openKey:r,onToggleOpenKey:s,onAvbestill:g})}function L(){const n=y(),t=D(["meg",n],`/klubb/${n}/bruker/meg`,{requireAuth:!0,staleTime:6e4}),r=N("patch",`/klubb/${n}/bruker/meg`,{onSuccess:()=>{f.success("Visningsnavn oppdatert"),t.refetch()},onError:i=>{f.error(i.message??"Kunne ikke oppdatere visningsnavn")}}),s=N("delete",`/klubb/${n}/bruker/meg`,{onSuccess:()=>f.success("Brukeren er slettet"),onError:i=>f.error(i.message??"Kunne ikke slette bruker")}),c=async()=>{try{const i=await O.get(`/klubb/${n}/bruker/meg/egen-data`,{requireAuth:!0,responseType:"blob"}),o=i.data,a=i.headers?.["content-disposition"]?.match(/filename\*=UTF-8''([^;]+)|filename="?([^"]+)"?/i),d=decodeURIComponent(a?.[1]??a?.[2]??"")||`banebooking-data-${new Date().toISOString().slice(0,10)}.json`,m=URL.createObjectURL(o),v=document.createElement("a");v.href=m,v.download=d,document.body.appendChild(v),v.click(),v.remove(),URL.revokeObjectURL(m)}catch(i){const o=i instanceof Error?i.message:"Kunne ikke laste ned egen data";f.error(o)}};return{bruker:t.data,laster:t.isLoading,error:t.error,refetch:t.refetch,lastNedEgenData:c,oppdaterVisningsnavn:r,slettMeg:s}}function ce({epost:n,rollerText:t,mode:r,onSetMode:s,visningsnavn:c,onChangeVisningsnavn:i,maxLength:o,feil:l,valgtVisningsnavn:a,kanLagre:g,isPending:d,onLagre:m}){return e.jsxs("div",{className:"space-y-4",children:[e.jsx(h,{title:"Min profil",description:"Velg hva som vises som navnet ditt i appen.",children:e.jsx(j,{children:e.jsxs(x,{children:[e.jsx(k,{title:"Visningsnavn",description:"Velg e-post eller et eget navn.",children:e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"flex items-center gap-2 text-sm cursor-pointer select-none",children:[e.jsx("input",{type:"radio",name:"visningsnavn-mode",checked:r==="epost",onChange:()=>s("epost")}),e.jsxs("span",{children:["E-post (",n,")"]})]}),e.jsxs("label",{className:"flex items-center gap-2 text-sm cursor-pointer select-none",children:[e.jsx("input",{type:"radio",name:"visningsnavn-mode",checked:r==="navn",onChange:()=>s("navn")}),e.jsx("span",{children:"Eget navn"})]})]})}),r==="navn"?e.jsx(k,{title:"Eget navn",description:`Maks ${o} tegn.`,children:e.jsx(R,{id:"visningsnavn",label:"Eget navn",hideLabel:!0,value:c,error:l,onChange:v=>i(v.target.value),inputProps:{placeholder:"f.eks. Ola Nordmann",maxLength:o}})}):null,e.jsx(k,{title:"Dette vil lagres",description:"Slik vil navnet ditt vises.",right:e.jsx(b,{type:"button",size:"sm",disabled:!g||d,onClick:m,children:d?"Lagrer...":"Lagre"}),children:e.jsx("div",{className:"text-sm text-foreground break-words",children:a})})]})})}),e.jsx(h,{title:"Konto",description:"Denne informasjonen kan bare endres av klubbadministrator.",children:e.jsx(j,{children:e.jsxs(x,{children:[e.jsx(A,{label:"Brukernavn / ID",value:n}),e.jsx(A,{label:"Tilgang",value:t})]})})})]})}const T=50,de=/^[\p{L}\d\s.@'_%+-]{2,}$/u;function ue(n){const t=n.trim();return t.length===0?"Visningsnavn kan ikke v�re tomt.":t.length<3?"Visningsnavn m� v�re minst 3 tegn.":de.test(t)?t.length>T?`Visningsnavn kan ikke v�re lengre enn ${T} tegn.`:null:"Visningsnavn inneholder ugyldige tegn."}function ge(){const{bruker:n,laster:t,oppdaterVisningsnavn:r}=L(),{mutateAsync:s,isPending:c}=r,[i,o]=u.useState("epost"),[l,a]=u.useState(""),[g,d]=u.useState(null);u.useEffect(()=>{if(!n)return;const p=n.visningsnavn?.trim();!p||p===n.epost?(o("epost"),a("")):(o("navn"),a(p)),d(null)},[n]);const m=u.useMemo(()=>n?i==="epost"?n.epost:l.trim():"",[n,i,l]),v=u.useMemo(()=>n?i==="epost"?null:ue(l):"Ukjent feil.",[n,i,l]),$=u.useMemo(()=>{if(!n)return!1;const p=m,w=(n.visningsnavn??"").trim();return p.length===0||p===w?!1:i==="navn"?!v:!0},[n,m,i,v]);async function C(){n&&(d(v),!v&&await s({visningsnavn:m}))}return t||!n?e.jsx(V,{}):e.jsx(ce,{epost:n.epost,rollerText:n.roller.join(", "),mode:i,onSetMode:p=>{o(p),d(null)},visningsnavn:l,onChangeVisningsnavn:p=>{a(p),g&&d(null)},maxLength:T,feil:g,valgtVisningsnavn:m,kanLagre:$,isPending:c,onLagre:()=>void C()})}function me({slettMeg:n}){const{signOut:t}=H(),[r,s]=u.useState(!1),c=async()=>{try{await n.mutateAsync(),s(!1),await t()}catch{}};return e.jsxs(Q,{open:r,onOpenChange:s,children:[e.jsx(_,{asChild:!0,children:e.jsx(b,{variant:"destructive",disabled:n.isPending,children:n.isPending?"Sletter...":"Slett min bruker"})}),e.jsxs(z,{children:[e.jsxs(X,{children:[e.jsx(J,{children:"Er du sikker?"}),e.jsx(W,{children:"Dette vil slette din bruker og all tilknytning permanent. Denne handlingen kan ikke angres."})]}),e.jsxs(Y,{children:[e.jsx(Z,{disabled:n.isPending,children:"Avbryt"}),e.jsx(ee,{asChild:!0,children:e.jsx(b,{variant:"destructive",onClick:c,disabled:n.isPending,children:n.isPending?"Sletter...":"Slett bruker"})})]})]})]})}function ve(){const n=y(),{bruker:t,laster:r,lastNedEgenData:s,slettMeg:c}=L(),[i,o]=u.useState(!1);if(r||!t)return e.jsx(V,{});const l=t.vilkaarAkseptertDato?`Akseptert ${S(t.vilkaarAkseptertDato)}${t.vilkaarVersjon?` (versjon ${t.vilkaarVersjon})`:""}`:"Ikke registrert",a=async()=>{if(!i)try{o(!0),await s()}catch(g){const d=g instanceof Error?g.message:"Kunne ikke laste ned egen data";f.error(d)}finally{o(!1)}};return e.jsxs("div",{className:"space-y-4",children:[e.jsx(h,{title:"Persondata",description:"Her kan du se vilkår og laste ned egne data.",children:e.jsx(j,{children:e.jsxs(x,{children:[e.jsx(A,{label:"Vilkår",description:"Vilkårene aksepteres automatisk ved første innlogging.",value:l}),e.jsx(k,{title:"Les vilkårene",description:"Åpnes i ny fane.",right:e.jsx(U,{to:`/${n}/vilkaar`,className:"text-sm underline text-primary hover:text-primary/80",target:"_blank",rel:"noopener noreferrer",children:"Åpne"})}),e.jsx(k,{title:"Last ned dine data",description:"JSON med registrerte opplysninger og bookinger.",right:e.jsx(b,{onClick:a,size:"sm",variant:"outline",disabled:i||c.isPending,children:i?"Laster...":"Last ned"})})]})})}),e.jsx(h,{title:"Slett bruker",description:"Sletter bruker og all tilknyttet data permanent.",children:e.jsx(x,{children:e.jsx(k,{title:"",description:"Dette kan ikke angres.",right:e.jsx(me,{slettMeg:c})})})})]})}function Ce(){return e.jsx(P,{children:e.jsx(ne,{defaultValue:"bookinger",items:[{value:"bookinger",label:"Mine bookinger",content:e.jsx(le,{})},{value:"profil",label:"Min profil",content:e.jsx(ge,{})},{value:"persondata",label:"Persondata",content:e.jsx(ve,{})}]})})}export{Ce as default};
