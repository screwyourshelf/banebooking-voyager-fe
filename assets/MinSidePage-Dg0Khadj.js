import{r as a,j as e}from"./shadcn-DPSgmxN6.js";import{t as g,f as y,u as U,B as E,d as G,S as I,L as C}from"./index-BYC8jElZ.js";import{b as P}from"./booking-UdrAetQp.js";import{T as _,a as z,b as A,c as D,d as J,e as w}from"./index-Ma-LHvo-.js";import{T as W,a as X,b as L,c as V}from"./tabs-BeMiRqZx.js";import{C as B,a as M}from"./card-Bt8C29rJ.js";import{F as q}from"./FormField-rCnNSN9O.js";import{F as b}from"./FieldWrapper-DqorA9eC.js";import{f as $}from"./datoUtils-Bzity_GL.js";import{A as Q,a as Y,b as Z,c as ee,d as te,e as se,f as ne,g as re,h as ae}from"./alert-dialog-tfR90E3b.js";import"./react-RGnvvjkK.js";import"./lucide-Uxrg_z7G.js";function ie(s,n=!1){const[i,c]=a.useState([]),[t,d]=a.useState(!0),[k,x]=a.useState(null),m=a.useCallback(async()=>{if(s)try{d(!0),x(null);const u=await P(s,n);c(u)}catch(u){const h=u instanceof Error?u.message:"Ukjent feil ved henting av bookinger";x(h),g.error(h)}finally{d(!1)}},[s,n]);return a.useEffect(()=>{m()},[m]),{bookinger:i,laster:t,error:k,refetch:m}}async function le(s){const n=await y(`/api/klubb/${s}/bruker/meg/egen-data`,{method:"GET"},!0);if(!n.ok){const d=await n.text();throw new Error(d||"Kunne ikke hente egen data")}const i=await n.blob(),c=window.URL.createObjectURL(i),t=document.createElement("a");t.href=c,t.download=`banebooking-data-${new Date().toISOString().slice(0,10)}.json`,document.body.appendChild(t),t.click(),t.remove(),window.URL.revokeObjectURL(c)}async function oe(s){const n=await y(`/api/klubb/${s}/bruker/meg`,{method:"GET"},!0);if(!n.ok){const i=await n.text();throw new Error(i||"Kunne ikke hente meg")}return await n.json()}async function ce(s,n){const i=await y(`/api/klubb/${s}/bruker/meg`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)},!0);if(!i.ok){const c=await i.text();throw new Error(c||"Kunne ikke oppdatere visningsnavn")}}async function de(s){const n=await y(`/api/klubb/${s}/bruker/meg`,{method:"DELETE"},!0);if(!n.ok){const i=await n.text();throw new Error(i||"Kunne ikke slette brukeren")}}function ue(s){const[n,i]=a.useState(null),[c,t]=a.useState(!0),[d,k]=a.useState(null),x=a.useCallback(async()=>{if(s)try{await le(s),g.success("Dataen din lastes nå ned")}catch(o){const l=o instanceof Error?o.message:"Kunne ikke laste ned data";g.error(l)}},[s]),m=a.useCallback(async()=>{if(s){t(!0);try{const o=await oe(s);i(o),k(null)}catch(o){const l=o instanceof Error?o.message:"Ukjent feil ved henting";k(l),g.error(l),i(null)}finally{t(!1)}}},[s]),u=a.useCallback(async o=>{if(!(!n||!s))try{await ce(s,{visningsnavn:o}),i({...n,visningsnavn:o}),g.success("Visningsnavn lagret")}catch(l){const f=l instanceof Error?l.message:"Kunne ikke lagre visningsnavn";g.error(f)}},[s,n]),h=a.useCallback(async()=>{if(s)try{await de(s),i(null),g.success("Brukeren er slettet")}catch(o){const l=o instanceof Error?o.message:"Kunne ikke slette bruker";g.error(l)}},[s]);return a.useEffect(()=>{m()},[m]),{bruker:n,laster:c,feil:d,oppdaterVisningsnavn:u,refetch:m,slettMeg:h,lastNedEgenData:x}}function ge({slettMeg:s}){const{signOut:n}=U(),[i,c]=a.useState(!1),[t,d]=a.useState(!1),k=async()=>{d(!0);try{await s(),g.success("Brukeren er slettet"),c(!1),await n()}catch{g.error("Noe gikk galt ved sletting")}finally{d(!1)}};return e.jsxs(Q,{open:i,onOpenChange:c,children:[e.jsx(Y,{asChild:!0,children:e.jsx(E,{variant:"destructive",children:"Slett min bruker"})}),e.jsxs(Z,{children:[e.jsxs(ee,{children:[e.jsx(te,{children:"Er du sikker?"}),e.jsx(se,{children:"Dette vil slette din bruker og all tilknytning permanent. Denne handlingen kan ikke angres."})]}),e.jsxs(ne,{children:[e.jsx(re,{disabled:t,children:"Avbryt"}),e.jsx(ae,{className:"bg-red-600 hover:bg-red-700 focus:ring-red-600",onClick:k,disabled:t,children:t?"Sletter...":"Slett bruker"})]})]})]})}const T=50,ke=/^[\p{L}\d\s.@'_%+-]{2,}$/u;function Ee(){const{slug:s}=G(),n=a.useContext(I)??s,[i,c]=a.useState("profil"),{bruker:t,laster:d,oppdaterVisningsnavn:k,slettMeg:x,lastNedEgenData:m}=ue(n),[u,h]=a.useState(""),[o,l]=a.useState(null),[f,F]=a.useState(!1),{bookinger:O,laster:R}=ie(n,f),[p,v]=a.useState(!1);a.useEffect(()=>{if(t){const r=t.visningsnavn?.trim();!r||r===t.epost?(v(!0),h("")):(h(r),v(!1))}},[t]);const K=()=>{if(!t)return;if(p){l(null),k(t.epost);return}const r=u.trim();if(r.length===0){l("Visningsnavn kan ikke være tomt.");return}if(r.length<3){l("Visningsnavn må være minst 3 tegn.");return}if(!ke.test(r)){l("Visningsnavn inneholder ugyldige tegn.");return}if(r.length>T){l(`Visningsnavn kan ikke være lengre enn ${T} tegn.`);return}l(null),k(r)},H=t?p?t.visningsnavn!==t.epost:u.trim()!==t.visningsnavn:!1,N=[...O].sort((r,j)=>{const S=new Date(j.dato).getTime()-new Date(r.dato).getTime();return S!==0?S:j.startTid.localeCompare(r.startTid)});return e.jsx("div",{className:"max-w-screen-md mx-auto px-2 py-4",children:e.jsxs(W,{value:i,onValueChange:c,children:[e.jsxs(X,{className:"mb-4",children:[e.jsx(L,{value:"profil",children:"Min profil"}),e.jsx(L,{value:"bookinger",children:"Mine bookinger"})]}),e.jsx(V,{value:"profil",children:e.jsx(B,{children:e.jsx(M,{className:"p-4 space-y-6",children:d||!t?e.jsx(C,{}):e.jsxs(e.Fragment,{children:[e.jsxs("form",{className:"space-y-4",onSubmit:r=>{r.preventDefault(),K()},children:[e.jsx(q,{id:"visningsnavn",label:"Visningsnavn",value:p?"":u,maxLength:T,placeholder:t?.epost||"f.eks. Ola Nordmann",onChange:r=>{h(r.target.value),v(!1)},disabled:p,error:o,helpText:"Navnet vises i grensesnittet, og settes automatisk til e-post ved første innlogging. Du kan endre det her. Eller velg å bruke e-post i stedet."}),e.jsxs("label",{className:"flex items-center space-x-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:p,onChange:r=>{v(r.target.checked),r.target.checked&&h("")}}),e.jsx("span",{children:"Bruk e-post som visningsnavn"})]}),e.jsx(E,{type:"submit",size:"sm",disabled:!H,children:"Lagre"})]}),e.jsxs("div",{className:"pt-4 border-t mt-4 space-y-4",children:[e.jsx(b,{id:"epost",label:"Brukernavn / ID",children:e.jsx("p",{className:"text-sm text-foreground",children:t.epost})}),e.jsx(b,{id:"rolle",label:"Rolle (i klubben)",helpText:"Roller tildeles av klubbens administrator og kan ikke endres manuelt.",children:e.jsx("p",{className:"text-sm text-foreground",children:t.roller.join(", ")})})]}),e.jsxs("div",{className:"pt-4 border-t mt-4 space-y-4",children:[e.jsxs(b,{id:"vilkaar",label:"Vilkår for bruk",helpText:"Du aksepterer vilkårene automatisk ved første innlogging.",children:[t.vilkaarAkseptertDato?e.jsxs("p",{className:"text-sm text-foreground",children:["Akseptert ",$(t.vilkaarAkseptertDato)," ",t.vilkaarVersjon&&`(versjon ${t.vilkaarVersjon})`]}):e.jsx("p",{className:"text-sm text-muted-foreground italic",children:"Ikke registrert"}),e.jsx("p",{className:"text-sm mt-1",children:e.jsx("a",{href:`/banebooking-voyager-fe/${n}/vilkaar`,className:"underline text-primary hover:text-primary/80",children:"Les vilkårene"})})]}),e.jsx(b,{id:"last-ned-data",label:"Last ned dine data",helpText:"Du kan laste ned alle registrerte opplysninger og bookinger i JSON-format.",children:e.jsx(E,{onClick:m,size:"sm",variant:"outline",children:"Last ned data"})}),e.jsx(b,{id:"slett-bruker",label:"Slett bruker",helpText:"Dette sletter brukeren din og all tilknyttet data permanent. Dette kan ikke angres.",children:e.jsx(ge,{slettMeg:x})})]})]})})})}),e.jsx(V,{value:"bookinger",children:e.jsx(B,{children:e.jsx(M,{className:"p-4 space-y-4",children:R?e.jsx(C,{}):e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"flex items-center space-x-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:f,onChange:r=>{F(r.target.checked)}}),e.jsx("span",{children:"Vis også tidligere bookinger"})]}),N.length===0?e.jsx("p",{className:"text-sm text-muted-foreground italic",children:f?"Du har ingen registrerte bookinger.":"Du har ingen kommende bookinger."}):e.jsx("div",{className:"overflow-auto max-h-[60vh] border-b border-x rounded-b-md",children:e.jsxs(_,{className:"text-sm",children:[e.jsx(z,{children:e.jsxs(A,{children:[e.jsx(D,{children:"Dato"}),e.jsx(D,{children:"Tid"}),e.jsx(D,{children:"Bane"})]})}),e.jsx(J,{children:N.map((r,j)=>e.jsxs(A,{children:[e.jsx(w,{children:$(r.dato)}),e.jsxs(w,{children:[r.startTid,"–",r.sluttTid]}),e.jsx(w,{children:r.baneNavn})]},j))})]})})]})})})})]})})}export{Ee as default};
