import{r,j as e}from"./shadcn-V64FgQuT.js";import{t as g,f as y,u as G,B as E,d as I,S as P,L as A}from"./index-BUl1sceL.js";import{b as _}from"./booking-WJze_yna.js";import{T as z,a as J,b as L,c as D,d as W,e as w}from"./index-nCnPoXBt.js";import{T as X,a as q,b as V,c as B}from"./tabs-CZTDlSF2.js";import{C as M,a as $}from"./card-DJrtFHge.js";import{F as Q}from"./FormField-pJlN5988.js";import{F as v}from"./FieldWrapper-CnVp9v9G.js";import{f as F}from"./datoUtils-Bzity_GL.js";import{A as Y,a as Z,b as ee,c as te,d as se,e as ne,f as ae,g as re,h as ie}from"./alert-dialog-Cl0_ixlU.js";import"./react-D5d5vywP.js";import"./lucide-VYBZz5NY.js";function le(s,a=!1){const[i,c]=r.useState([]),[t,d]=r.useState(!0),[k,f]=r.useState(null),m=r.useCallback(async()=>{if(s)try{d(!0),f(null);const u=await _(s,a);c(u)}catch(u){const h=u instanceof Error?u.message:"Ukjent feil ved henting av bookinger";f(h),g.error(h)}finally{d(!1)}},[s,a]);return r.useEffect(()=>{m()},[m]),{bookinger:i,laster:t,error:k,refetch:m}}async function oe(s){const a=await y(`/api/klubb/${s}/bruker/meg/egen-data`,{method:"GET"},!0);if(!a.ok){const d=await a.text();throw new Error(d||"Kunne ikke hente egen data")}const i=await a.blob(),c=window.URL.createObjectURL(i),t=document.createElement("a");t.href=c,t.download=`banebooking-data-${new Date().toISOString().slice(0,10)}.json`,document.body.appendChild(t),t.click(),t.remove(),window.URL.revokeObjectURL(c)}async function ce(s){const a=await y(`/api/klubb/${s}/bruker/meg`,{method:"GET"},!0);if(!a.ok){const i=await a.text();throw new Error(i||"Kunne ikke hente meg")}return await a.json()}async function de(s,a){const i=await y(`/api/klubb/${s}/bruker/meg`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)},!0);if(!i.ok){const c=await i.text();throw new Error(c||"Kunne ikke oppdatere visningsnavn")}}async function ue(s){const a=await y(`/api/klubb/${s}/bruker/meg`,{method:"DELETE"},!0);if(!a.ok){const i=await a.text();throw new Error(i||"Kunne ikke slette brukeren")}}function ge(s){const[a,i]=r.useState(null),[c,t]=r.useState(!0),[d,k]=r.useState(null),f=r.useCallback(async()=>{if(s)try{await oe(s),g.success("Dataen din lastes nå ned")}catch(o){const l=o instanceof Error?o.message:"Kunne ikke laste ned data";g.error(l)}},[s]),m=r.useCallback(async()=>{if(s){t(!0);try{const o=await ce(s);i(o),k(null)}catch(o){const l=o instanceof Error?o.message:"Ukjent feil ved henting";k(l),g.error(l),i(null)}finally{t(!1)}}},[s]),u=r.useCallback(async o=>{if(!(!a||!s))try{await de(s,{visningsnavn:o}),i({...a,visningsnavn:o}),g.success("Visningsnavn lagret")}catch(l){const p=l instanceof Error?l.message:"Kunne ikke lagre visningsnavn";g.error(p)}},[s,a]),h=r.useCallback(async()=>{if(s)try{await ue(s),i(null),g.success("Brukeren er slettet")}catch(o){const l=o instanceof Error?o.message:"Kunne ikke slette bruker";g.error(l)}},[s]);return r.useEffect(()=>{m()},[m]),{bruker:a,laster:c,feil:d,oppdaterVisningsnavn:u,refetch:m,slettMeg:h,lastNedEgenData:f}}function ke({slettMeg:s}){const{signOut:a}=G(),[i,c]=r.useState(!1),[t,d]=r.useState(!1),k=async()=>{d(!0);try{await s(),g.success("Brukeren er slettet"),c(!1),await a()}catch{g.error("Noe gikk galt ved sletting")}finally{d(!1)}};return e.jsxs(Y,{open:i,onOpenChange:c,children:[e.jsx(Z,{asChild:!0,children:e.jsx(E,{variant:"destructive",children:"Slett min bruker"})}),e.jsxs(ee,{children:[e.jsxs(te,{children:[e.jsx(se,{children:"Er du sikker?"}),e.jsx(ne,{children:"Dette vil slette din bruker og all tilknytning permanent. Denne handlingen kan ikke angres."})]}),e.jsxs(ae,{children:[e.jsx(re,{disabled:t,children:"Avbryt"}),e.jsx(ie,{className:"bg-red-600 hover:bg-red-700 focus:ring-red-600",onClick:k,disabled:t,children:t?"Sletter...":"Slett bruker"})]})]})]})}const T=50,me=/^[\p{L}\d\s.@'_%+-]{2,}$/u;function Ne(){const{slug:s}=I(),a=r.useContext(P)??s,[i,c]=r.useState("profil"),{bruker:t,laster:d,oppdaterVisningsnavn:k,slettMeg:f,lastNedEgenData:m}=ge(a),[u,h]=r.useState(""),[o,l]=r.useState(null),[p,O]=r.useState(!1),{bookinger:N,laster:R}=le(a,p),[b,j]=r.useState(!1);r.useEffect(()=>{var n;if(t){const x=(n=t.visningsnavn)==null?void 0:n.trim();!x||x===t.epost?(j(!0),h("")):(h(x),j(!1))}},[t]);const K=()=>{if(!t)return;if(b){l(null),k(t.epost);return}const n=u.trim();if(n.length===0){l("Visningsnavn kan ikke være tomt.");return}if(n.length<3){l("Visningsnavn må være minst 3 tegn.");return}if(!me.test(n)){l("Visningsnavn inneholder ugyldige tegn.");return}if(n.length>T){l(`Visningsnavn kan ikke være lengre enn ${T} tegn.`);return}l(null),k(n)},H=t?b?t.visningsnavn!==t.epost:u.trim()!==t.visningsnavn:!1,U=new Date,S=(p?N:N.filter(n=>new Date(n.dato)>=U)).sort((n,x)=>{const C=new Date(x.dato).getTime()-new Date(n.dato).getTime();return C!==0?C:x.startTid.localeCompare(n.startTid)});return e.jsx("div",{className:"max-w-screen-md mx-auto px-2 py-4",children:e.jsxs(X,{value:i,onValueChange:c,children:[e.jsxs(q,{className:"mb-4",children:[e.jsx(V,{value:"profil",children:"Min profil"}),e.jsx(V,{value:"bookinger",children:"Mine bookinger"})]}),e.jsx(B,{value:"profil",children:e.jsx(M,{children:e.jsx($,{className:"p-4 space-y-6",children:d||!t?e.jsx(A,{}):e.jsxs(e.Fragment,{children:[e.jsxs("form",{className:"space-y-4",onSubmit:n=>{n.preventDefault(),K()},children:[e.jsx(Q,{id:"visningsnavn",label:"Visningsnavn",value:b?"":u,maxLength:T,placeholder:(t==null?void 0:t.epost)||"f.eks. Ola Nordmann",onChange:n=>{h(n.target.value),j(!1)},disabled:b,error:o,helpText:"Navnet vises i grensesnittet, og settes automatisk til e-post ved første innlogging. Du kan endre det her. Eller velg å bruke e-post i stedet."}),e.jsxs("label",{className:"flex items-center space-x-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:b,onChange:n=>{j(n.target.checked),n.target.checked&&h("")}}),e.jsx("span",{children:"Bruk e-post som visningsnavn"})]}),e.jsx(E,{type:"submit",size:"sm",disabled:!H,children:"Lagre"})]}),e.jsxs("div",{className:"pt-4 border-t mt-4 space-y-4",children:[e.jsx(v,{id:"epost",label:"Brukernavn / ID",children:e.jsx("p",{className:"text-sm text-foreground",children:t.epost})}),e.jsx(v,{id:"rolle",label:"Rolle (i klubben)",helpText:"Roller tildeles av klubbens administrator og kan ikke endres manuelt.",children:e.jsx("p",{className:"text-sm text-foreground",children:t.roller.join(", ")})})]}),e.jsxs("div",{className:"pt-4 border-t mt-4 space-y-4",children:[e.jsxs(v,{id:"vilkaar",label:"Vilkår for bruk",helpText:"Du aksepterer vilkårene automatisk ved første innlogging.",children:[t.vilkaarAkseptertDato?e.jsxs("p",{className:"text-sm text-foreground",children:["Akseptert ",F(t.vilkaarAkseptertDato)," ",t.vilkaarVersjon&&`(versjon ${t.vilkaarVersjon})`]}):e.jsx("p",{className:"text-sm text-muted-foreground italic",children:"Ikke registrert"}),e.jsx("p",{className:"text-sm mt-1",children:e.jsx("a",{href:`/banebooking-voyager-fe/${a}/vilkaar`,className:"underline text-primary hover:text-primary/80",children:"Les vilkårene"})})]}),e.jsx(v,{id:"last-ned-data",label:"Last ned dine data",helpText:"Du kan laste ned alle registrerte opplysninger og bookinger i JSON-format.",children:e.jsx(E,{onClick:m,size:"sm",variant:"outline",children:"Last ned data"})}),e.jsx(v,{id:"slett-bruker",label:"Slett bruker",helpText:"Dette sletter brukeren din og all tilknyttet data permanent. Dette kan ikke angres.",children:e.jsx(ke,{slettMeg:f})})]})]})})})}),e.jsx(B,{value:"bookinger",children:e.jsx(M,{children:e.jsx($,{className:"p-4 space-y-4",children:R?e.jsx(A,{}):e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"flex items-center space-x-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:p,onChange:n=>{O(n.target.checked)}}),e.jsx("span",{children:"Vis også tidligere bookinger"})]}),S.length===0?e.jsx("p",{className:"text-sm text-muted-foreground italic",children:p?"Du har ingen registrerte bookinger.":"Du har ingen kommende bookinger."}):e.jsx("div",{className:"overflow-auto max-h-[60vh] border-b border-x rounded-b-md",children:e.jsxs(z,{className:"text-sm",children:[e.jsx(J,{children:e.jsxs(L,{children:[e.jsx(D,{children:"Dato"}),e.jsx(D,{children:"Tid"}),e.jsx(D,{children:"Bane"})]})}),e.jsx(W,{children:S.map((n,x)=>e.jsxs(L,{children:[e.jsx(w,{children:F(n.dato)}),e.jsxs(w,{children:[n.startTid,"–",n.sluttTid]}),e.jsx(w,{children:n.baneNavn})]},x))})]})})]})})})})]})})}export{Ne as default};
