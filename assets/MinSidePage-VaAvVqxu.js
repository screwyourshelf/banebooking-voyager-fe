import{r as g,j as e}from"./shadcn-DDUjAgUv.js";import{u as E}from"./useSlug-ZE28OrjG.js";import{P}from"./Page-Cq3gZojq.js";import{S as C}from"./SimpleTabsLazy-DwlegirF.js";import{d as N,e as D,t as h,h as B,L as j,B as T,g as R,i as w}from"./index-3DUQE2SU.js";import{F,a as p}from"./FormField-DZiGabeK.js";import{P as S}from"./PageSection-CrgFjiMc.js";import{A as $,a as O,b as H,c as M,d as U,e as q,f as I,g as _,h as z}from"./alert-dialog-Cl3hAkOK.js";import{f as A}from"./datoUtils-CMdMNzgI.js";import{T as K,a as G,b as y,c as b,d as Q,e as f}from"./table-rAwfkCth.js";import"./react-RGnvvjkK.js";import"./lucide-Bc72fHhV.js";import"./index-CZuuFr9-.js";function L(t){const n=N(["meg",t],`/klubb/${t}/bruker/meg`,{requireAuth:!0,enabled:!!t,staleTime:6e4}),r=D("patch",`/klubb/${t}/bruker/meg`,{onSuccess:()=>{h.success("Visningsnavn oppdatert"),n.refetch()},onError:a=>{h.error(a.message??"Kunne ikke oppdatere visningsnavn")}}),o=D("delete",`/klubb/${t}/bruker/meg`,{onSuccess:()=>h.success("Brukeren er slettet"),onError:a=>h.error(a.message??"Kunne ikke slette bruker")}),l=async()=>{if(!t)return;const a=await B.get(`/klubb/${t}/bruker/meg/egen-data`,{requireAuth:!0,responseType:"blob"}),i=a.data,d=a.headers?.["content-disposition"]?.match(/filename\*=UTF-8''([^;]+)|filename="?([^"]+)"?/i),x=decodeURIComponent(d?.[1]??d?.[2]??"")||`banebooking-data-${new Date().toISOString().slice(0,10)}.json`,u=URL.createObjectURL(i),m=document.createElement("a");m.href=u,m.download=x,document.body.appendChild(m),m.click(),m.remove(),URL.revokeObjectURL(u)};return{bruker:n.data,laster:n.isLoading,error:n.error,refetch:n.refetch,lastNedEgenData:l,oppdaterVisningsnavn:r,slettMeg:o}}const v=50,X=/^[\p{L}\d\s.@'_%+-]{2,}$/u;function J({slug:t}){const{bruker:n,laster:r,oppdaterVisningsnavn:o}=L(t),{mutateAsync:l,isPending:a}=o,[i,c]=g.useState(""),[d,k]=g.useState(!1),[x,u]=g.useState(null);g.useEffect(()=>{if(n){const s=n.visningsnavn?.trim();!s||s===n.epost?(k(!0),c("")):(c(s),k(!1))}},[n]);const m=async()=>{if(!n)return;if(d){u(null),await l({visningsnavn:n.epost});return}const s=i.trim();if(s.length===0){u("Visningsnavn kan ikke være tomt.");return}if(s.length<3){u("Visningsnavn må være minst 3 tegn.");return}if(!X.test(s)){u("Visningsnavn inneholder ugyldige tegn.");return}if(s.length>v){u(`Visningsnavn kan ikke være lengre enn ${v} tegn.`);return}u(null),await l({visningsnavn:s})},V=n?d?n.visningsnavn!==n.epost:i.trim()!==n.visningsnavn:!1;return r||!n?e.jsx(j,{}):e.jsxs(e.Fragment,{children:[e.jsxs("form",{className:"space-y-4",onSubmit:s=>{s.preventDefault(),m()},children:[e.jsx(F,{id:"visningsnavn",label:"Visningsnavn",value:d?"":i,maxLength:v,placeholder:n?.epost||"f.eks. Ola Nordmann",onChange:s=>{c(s.target.value),k(!1)},disabled:d,error:x,helpText:"Navnet vises i grensesnittet, og settes automatisk til e-post ved første innlogging."}),e.jsxs("label",{className:"flex items-center space-x-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:d,onChange:s=>{k(s.target.checked),s.target.checked&&c("")}}),e.jsx("span",{children:"Bruk e-post som visningsnavn"})]}),e.jsx(T,{type:"submit",size:"sm",disabled:!V||a,children:a?"Lagrer...":"Lagre"})]}),e.jsxs(S,{bordered:!0,className:"space-y-4",children:[e.jsx(p,{id:"epost",label:"Brukernavn / ID",children:e.jsx("p",{className:"text-sm text-foreground",children:n.epost})}),e.jsx(p,{id:"rolle",label:"Rolle (i klubben)",helpText:"Roller tildeles av klubbens administrator og kan ikke endres manuelt.",children:e.jsx("p",{className:"text-sm text-foreground",children:n.roller.join(", ")})})]})]})}function W({slettMeg:t}){const{signOut:n}=R(),[r,o]=g.useState(!1),l=async()=>{try{await t.mutateAsync(),o(!1),await n()}catch{}};return e.jsxs($,{open:r,onOpenChange:o,children:[e.jsx(O,{asChild:!0,children:e.jsx(T,{variant:"destructive",disabled:t.isPending,children:t.isPending?"Sletter...":"Slett min bruker"})}),e.jsxs(H,{children:[e.jsxs(M,{children:[e.jsx(U,{children:"Er du sikker?"}),e.jsx(q,{children:"Dette vil slette din bruker og all tilknytning permanent. Denne handlingen kan ikke angres."})]}),e.jsxs(I,{children:[e.jsx(_,{disabled:t.isPending,children:"Avbryt"}),e.jsx(z,{variant:"destructive",onClick:l,disabled:t.isPending,children:t.isPending?"Sletter...":"Slett bruker"})]})]})]})}function Y({slug:t}){const{bruker:n,laster:r,lastNedEgenData:o,slettMeg:l}=L(t),{isPending:a}=l;return r||!n?e.jsx(j,{}):e.jsxs(S,{bordered:!0,className:"space-y-4",children:[e.jsxs(p,{id:"vilkaar",label:"Vilkår for bruk",helpText:"Du aksepterer vilkårene automatisk ved første innlogging.",children:[n.vilkaarAkseptertDato?e.jsxs("p",{className:"text-sm text-foreground",children:["Akseptert ",A(n.vilkaarAkseptertDato)," ",n.vilkaarVersjon&&`(versjon ${n.vilkaarVersjon})`]}):e.jsx("p",{className:"text-sm text-muted-foreground italic",children:"Ikke registrert"}),e.jsx("p",{className:"text-sm mt-1",children:e.jsx(w,{to:`/${t}/vilkaar`,className:"underline text-primary hover:text-primary/80",target:"_blank",rel:"noopener noreferrer",children:"Les vilkårene"})})]}),e.jsx(p,{id:"last-ned-data",label:"Last ned dine data",helpText:"Du kan laste ned alle registrerte opplysninger og bookinger i JSON-format.",children:e.jsx(T,{onClick:o,size:"sm",variant:"outline",disabled:a,children:a?"Laster ned...":"Last ned data"})}),e.jsx(p,{id:"slett-bruker",label:"Slett bruker",helpText:"Dette sletter brukeren din og all tilknyttet data permanent.",children:e.jsx(W,{slettMeg:l})})]})}function Z(t,n=!1){const r=N(["mineBookinger",t,n],`/klubb/${t}/bookinger/mine${n?"?inkluderHistoriske=true":""}`,{requireAuth:!0,enabled:!!t,staleTime:6e4}),o=g.useRef(!1);return g.useEffect(()=>{if(!r.error){o.current=!1;return}o.current||(h.error(r.error.message??"Ukjent feil ved henting av bookinger"),o.current=!0)},[r.error]),r}function ee({slug:t}){const[n,r]=g.useState(!1),{data:o=[],isLoading:l}=Z(t,n),a=[...o].sort((i,c)=>{const d=new Date(c.dato).getTime()-new Date(i.dato).getTime();return d!==0?d:c.startTid.localeCompare(i.startTid)});return l?e.jsx(j,{}):e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"flex items-center space-x-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:n,onChange:i=>r(i.target.checked)}),e.jsx("span",{children:"Vis også tidligere bookinger"})]}),a.length===0?e.jsx("p",{className:"text-sm text-muted-foreground italic",children:n?"Du har ingen registrerte bookinger.":"Du har ingen kommende bookinger."}):e.jsx("div",{className:"overflow-auto max-h-[60vh] border rounded-md",children:e.jsxs(K,{className:"text-sm",children:[e.jsx(G,{children:e.jsxs(y,{children:[e.jsx(b,{children:"Dato"}),e.jsx(b,{children:"Tid"}),e.jsx(b,{children:"Bane"})]})}),e.jsx(Q,{children:a.map((i,c)=>e.jsxs(y,{children:[e.jsx(f,{children:A(i.dato)}),e.jsxs(f,{children:[i.startTid,"–",i.sluttTid]}),e.jsx(f,{children:i.baneNavn})]},c))})]})})]})}function ke(){const[t,n]=g.useState("bookinger"),r=E();return e.jsx(P,{children:e.jsx(C,{items:[{value:"bookinger",label:"Mine bookinger",content:e.jsx(ee,{slug:r})},{value:"profil",label:"Min profil",content:e.jsx(J,{slug:r})},{value:"persondata",label:"Persondata",content:e.jsx(Y,{slug:r})}],value:t,onValueChange:n})})}export{ke as default};
