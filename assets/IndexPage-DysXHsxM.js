import{j as t,r as k}from"./shadcn-nsGv8pGm.js";import{f as D,D as B}from"./DatoVelger-DgKi0TLT.js";import{B as S}from"./BookingSlotItem-DkIIke8B.js";import{L as y,u as Q,a as M,b as A,t as v,c as j,k as E,d as $,e as L,B as I}from"./index-CEYMlDzC.js";import{u as N}from"./useBaner-OUooAADc.js";import{P as C}from"./Page-Cvsn-K9O.js";import{T as w,a as K,b as O}from"./tabs-CqimfX6u.js";import{D as P,a as R,b as V,c as q,d as F,e as _}from"./dialog-FwmrfKZx.js";import{a as z}from"./lucide-ByRD2J1s.js";import"./react-RGnvvjkK.js";import"./index-lSrDbPdF.js";import"./index-BEQRqDzz.js";function U({slots:r,currentUser:o,onBook:n,onCancel:s,onDelete:l,apenSlotTid:d,setApenSlotTid:a,isLoading:b=!1}){return b?t.jsx(y,{}):r.length===0?t.jsx("div",{className:"text-muted text-sm italic py-4 text-center",children:"Ingen bookinger eller slots � vise."}):t.jsx("div",{className:"space-y-2",children:r.map(u=>{const m=`${u.dato}-${u.startTid}-${u.baneId}`;return t.jsx(S,{slot:u,currentUser:o,onBook:n,onCancel:s,onDelete:l,isOpen:d===m,onToggle:()=>a?.(d===m?null:m)},m)})})}function H(r,o){const n=Q(),s=M(),[l,d]=k.useState(null),a=["bookinger",n,o,r],b=!!o&&!!r,u=A(a,`/klubb/${n}/bookinger?baneId=${o}&dato=${r}`,{requireAuth:!0,enabled:b,staleTime:0,refetchInterval:3e4,refetchOnWindowFocus:!0,refetchIntervalInBackground:!1,placeholderData:E}),m=k.useRef(!1);k.useEffect(()=>{if(!u.error){m.current=!1;return}m.current||(v.error(u.error.message??"Kunne ikke hente bookinger"),m.current=!0)},[u.error]);const f=()=>{s.invalidateQueries({queryKey:a}),s.invalidateQueries({queryKey:["mineBookinger",n]})},p=(e,c)=>e.startTid===c.startTid&&e.sluttTid===c.sluttTid,h=j("post",`/klubb/${n}/bookinger`,{onMutate:async e=>{await s.cancelQueries({queryKey:a});const c=s.getQueryData(a);return s.setQueryData(a,(i=[])=>i.map(g=>p(g,e)?{...g,booketAv:"Du",erEier:!0,kanBookes:!1,kanAvbestille:!0}:g)),{previous:c}},onError:(e,c,i)=>{i?.previous&&s.setQueryData(a,i.previous),v.error(e.message??"Kunne ikke booke.")},onSuccess:(e,c)=>{const i=`${c.startTid.slice(0,2)}-${c.sluttTid.slice(0,2)}`;v.success(`Booket ${i}`)},onSettled:()=>{f()}}),x=j("delete",`/klubb/${n}/bookinger`,{onMutate:async e=>{await s.cancelQueries({queryKey:a});const c=s.getQueryData(a);return s.setQueryData(a,(i=[])=>i.map(g=>p(g,e)?{...g,booketAv:null,erEier:!1,kanBookes:!0,kanAvbestille:!1,kanSlette:!1}:g)),{previous:c}},onError:(e,c,i)=>{i?.previous&&s.setQueryData(a,i.previous),v.error(e.message??"Kunne ikke avbestille.")},onSuccess:()=>{v.info("Bookingen er avbestilt.")},onSettled:()=>{f()}}),T=j("delete",`/klubb/${n}/bookinger/admin`,{onMutate:async e=>{await s.cancelQueries({queryKey:a});const c=s.getQueryData(a);return s.setQueryData(a,(i=[])=>i.map(g=>p(g,e)?{...g,booketAv:null,erEier:!1,kanBookes:!0,kanAvbestille:!1,kanSlette:!1}:g)),{previous:c}},onError:(e,c,i)=>{i?.previous&&s.setQueryData(a,i.previous),v.error(e.message??"Kunne ikke slette booking.")},onSuccess:()=>{v.success("Booking slettet"),d(null)},onSettled:()=>{f()}});return{slots:u.data??[],isLoading:u.isLoading,isFetching:u.isFetching,apenSlotTid:l,setApenSlotTid:d,onBook:e=>h.mutate({baneId:o,dato:r,startTid:e.startTid,sluttTid:e.sluttTid}),onCancel:e=>x.mutate({baneId:o,dato:r,startTid:e.startTid,sluttTid:e.sluttTid}),onDelete:e=>T.mutate({baneId:e.baneId??o,dato:e.dato??r,startTid:e.startTid,sluttTid:e.sluttTid}),hentBookinger:u.refetch}}function W({items:r,value:o,onValueChange:n,className:s=""}){const l=r.find(d=>d.value===o)??r[0];return t.jsxs(w,{value:l.value,onValueChange:n,children:[t.jsx(K,{className:`flex flex-wrap gap-2 mb-2 ${s}`,children:r.map(d=>t.jsx(O,{value:d.value,children:d.label},d.value))}),t.jsx("div",{className:"mt-0",children:l.content})]})}function G({children:r}){const{data:o,isLoading:n}=$();if(n||!o)return null;const{bookingRegel:s}=o;return t.jsxs(P,{children:[t.jsx(R,{asChild:!0,children:r}),t.jsxs(V,{children:[t.jsxs(q,{children:[t.jsx(F,{children:"Bookingregler"}),t.jsx(_,{className:"sr-only",children:"Oversikt over bookingreglene i klubben"})]}),t.jsx("div",{className:"space-y-4",children:t.jsxs("ul",{className:"list-disc list-inside text-sm",children:[t.jsxs("li",{children:["Maks ",s.maksPerDag," bookinger per dag"]}),t.jsxs("li",{children:["Maks ",s.maksTotalt," aktive bookinger totalt"]}),t.jsxs("li",{children:["Opptil ",s.dagerFremITid," dager frem i tid"]}),t.jsxs("li",{children:[s.slotLengdeMinutter," minutter per booking"]}),t.jsxs("li",{children:["Tillatt mellom ",s.aapningstid,"–",s.stengetid]})]})})]})]})}function le(){const{baner:r,isLoading:o}=N(!1),[n,s]=k.useState(""),[l,d]=k.useState(new Date),{currentUser:a}=L(),b=k.useMemo(()=>l?D(l,"yyyy-MM-dd"):"",[l]),{slots:u,apenSlotTid:m,setApenSlotTid:f,onBook:p,onCancel:h,onDelete:x,isLoading:T}=H(b,n);return k.useEffect(()=>{!n&&r.length>0&&s(r[0].id)},[r,n]),k.useEffect(()=>{f(null)},[l,n,f]),k.useEffect(()=>{a||f(null)},[a,f]),k.useEffect(()=>{l&&localStorage.setItem("valgtDato",l.toISOString())},[l]),o||!n?t.jsx(y,{}):t.jsxs(C,{children:[t.jsxs("div",{className:"flex justify-between items-center mb-2",children:[t.jsx(G,{children:t.jsx(I,{variant:"ghost",size:"icon",className:"rounded-full",title:"Vis banereglement",children:t.jsx(z,{className:"w-5 h-5"})})}),t.jsx(B,{value:l,onChange:e=>d(e??null),visNavigering:!0})]}),t.jsx(W,{items:r.map(e=>({value:e.id,label:e.navn,content:t.jsx(U,{slots:u,currentUser:a?{epost:a.email??""}:null,apenSlotTid:m,setApenSlotTid:f,onBook:p,onCancel:h,onDelete:x,isLoading:T})})),value:n,onValueChange:s})]})}export{le as default};
