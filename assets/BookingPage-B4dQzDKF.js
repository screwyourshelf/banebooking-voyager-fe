import{r as f,j as e}from"./shadcn-CGWS6Fka.js";import{P as y}from"./Page-DHRv0mUi.js";import{u as B,a as S,b as Q,t as h,c as T,k as M,L as D,d as A,B as E,e as $}from"./index-CCQsaDNR.js";import{u as C}from"./useBaner-D2qeMvyt.js";import{D as L,f as N}from"./DatoVelger-DCErdYmy.js";import{B as I}from"./BookingSlotItem-Ba2onRy-.js";import{T as w,a as K,b as V}from"./tabs-97O1sjzz.js";import{D as F,a as O,b as P,c as R,d as q,e as _}from"./dialog-FaEPS2ZE.js";import{a as z}from"./lucide-C5rSQBgG.js";import"./react-RGnvvjkK.js";import"./index-DnnwNeRP.js";import"./index-2r_zrsQA.js";function H(a,o){const r=B(),t=S(),[i,c]=f.useState(null),n=["bookinger",r,o,a],v=!!o&&!!a,l=Q(n,`/klubb/${r}/bookinger?baneId=${o}&dato=${a}`,{requireAuth:!0,enabled:v,staleTime:0,refetchInterval:3e4,refetchOnWindowFocus:!0,refetchIntervalInBackground:!1,placeholderData:M}),g=f.useRef(!1);f.useEffect(()=>{if(!l.error){g.current=!1;return}g.current||(h.error(l.error.message??"Kunne ikke hente bookinger"),g.current=!0)},[l.error]);const k=()=>{t.invalidateQueries({queryKey:n}),t.invalidateQueries({queryKey:["mineBookinger",r]})},p=(s,d)=>s.startTid===d.startTid&&s.sluttTid===d.sluttTid,x=T("post",`/klubb/${r}/bookinger`,{onMutate:async s=>{await t.cancelQueries({queryKey:n});const d=t.getQueryData(n);return t.setQueryData(n,(u=[])=>u.map(m=>p(m,s)?{...m,booketAv:"Du",erEier:!0,kanBookes:!1,kanAvbestille:!0}:m)),{previous:d}},onError:(s,d,u)=>{u?.previous&&t.setQueryData(n,u.previous),h.error(s.message??"Kunne ikke booke.")},onSuccess:(s,d)=>{const u=`${d.startTid.slice(0,2)}-${d.sluttTid.slice(0,2)}`;h.success(`Booket ${u}`)},onSettled:()=>{k()}}),b=T("delete",`/klubb/${r}/bookinger`,{onMutate:async s=>{await t.cancelQueries({queryKey:n});const d=t.getQueryData(n);return t.setQueryData(n,(u=[])=>u.map(m=>p(m,s)?{...m,booketAv:null,erEier:!1,kanBookes:!0,kanAvbestille:!1,kanSlette:!1}:m)),{previous:d}},onError:(s,d,u)=>{u?.previous&&t.setQueryData(n,u.previous),h.error(s.message??"Kunne ikke avbestille.")},onSuccess:()=>{h.info("Bookingen er avbestilt.")},onSettled:()=>{k()}}),j=T("delete",`/klubb/${r}/bookinger/admin`,{onMutate:async s=>{await t.cancelQueries({queryKey:n});const d=t.getQueryData(n);return t.setQueryData(n,(u=[])=>u.map(m=>p(m,s)?{...m,booketAv:null,erEier:!1,kanBookes:!0,kanAvbestille:!1,kanSlette:!1}:m)),{previous:d}},onError:(s,d,u)=>{u?.previous&&t.setQueryData(n,u.previous),h.error(s.message??"Kunne ikke slette booking.")},onSuccess:()=>{h.success("Booking slettet"),c(null)},onSettled:()=>{k()}});return{slots:l.data??[],isLoading:l.isLoading,isFetching:l.isFetching,apenSlotTid:i,setApenSlotTid:c,onBook:s=>x.mutate({baneId:o,dato:a,startTid:s.startTid,sluttTid:s.sluttTid}),onCancel:s=>b.mutate({baneId:o,dato:a,startTid:s.startTid,sluttTid:s.sluttTid}),onDelete:s=>j.mutate({baneId:s.baneId??o,dato:s.dato??a,startTid:s.startTid,sluttTid:s.sluttTid}),hentBookinger:l.refetch}}function U({slots:a,currentUser:o,onBook:r,onCancel:t,onDelete:i,apenSlotTid:c,setApenSlotTid:n,isLoading:v=!1}){return v?e.jsx(D,{}):a.length===0?e.jsx("div",{className:"text-muted text-sm italic py-4 text-center",children:"Ingen bookinger eller slots å vise."}):e.jsx("div",{className:"space-y-2",children:a.map(l=>{const g=`${l.dato}-${l.startTid}-${l.baneId}`;return e.jsx(I,{slot:l,currentUser:o,onBook:r,onCancel:t,onDelete:i,isOpen:c===g,onToggle:()=>n?.(c===g?null:g)},g)})})}function W({items:a,value:o,onValueChange:r,className:t=""}){const i=a.find(c=>c.value===o)??a[0];return e.jsxs(w,{value:i.value,onValueChange:r,children:[e.jsx(K,{className:`flex flex-wrap gap-2 mb-2 ${t}`,children:a.map(c=>e.jsx(V,{value:c.value,children:c.label},c.value))}),e.jsx("div",{className:"mt-0",children:i.content})]})}function G({children:a}){const{data:o,isLoading:r}=A();if(r||!o)return null;const{bookingRegel:t}=o;return e.jsxs(F,{children:[e.jsx(O,{asChild:!0,children:a}),e.jsxs(P,{children:[e.jsxs(R,{children:[e.jsx(q,{children:"Bookingregler"}),e.jsx(_,{className:"sr-only",children:"Oversikt over bookingreglene i klubben"})]}),e.jsx("div",{className:"space-y-4",children:e.jsxs("ul",{className:"list-disc list-inside text-sm",children:[e.jsxs("li",{children:["Maks ",t.maksPerDag," bookinger per dag"]}),e.jsxs("li",{children:["Maks ",t.maksTotalt," aktive bookinger totalt"]}),e.jsxs("li",{children:["Opptil ",t.dagerFremITid," dager frem i tid"]}),e.jsxs("li",{children:[t.slotLengdeMinutter," minutter per booking"]}),e.jsxs("li",{children:["Tillatt mellom ",t.aapningstid,"–",t.stengetid]})]})})]})]})}function J({baner:a,valgtBaneId:o,onBaneChange:r,valgtDato:t,onDatoChange:i,slots:c,isLoading:n,currentUser:v,apenSlotTid:l,setApenSlotTid:g,onBook:k,onCancel:p,onDelete:x}){return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsx(G,{children:e.jsx(E,{variant:"ghost",size:"icon",className:"rounded-full",title:"Vis banereglement",children:e.jsx(z,{className:"w-5 h-5"})})}),e.jsx(L,{value:t,onChange:b=>i(b??null),visNavigering:!0})]}),e.jsx(W,{items:a.map(b=>({value:b.id,label:b.navn,content:e.jsx(U,{slots:c,currentUser:v?{epost:v.email??""}:null,apenSlotTid:l,setApenSlotTid:g,onBook:k,onCancel:p,onDelete:x,isLoading:n})})),value:o,onValueChange:r})]})}function X(){const{baner:a,isLoading:o}=C(!1),[r,t]=f.useState(""),[i,c]=f.useState(new Date),{currentUser:n}=$(),v=f.useMemo(()=>i?N(i,"yyyy-MM-dd"):"",[i]),{slots:l,apenSlotTid:g,setApenSlotTid:k,onBook:p,onCancel:x,onDelete:b,isLoading:j}=H(v,r);return f.useEffect(()=>{!r&&a.length>0&&t(a[0].id)},[a,r]),f.useEffect(()=>{k(null)},[i,r,k]),f.useEffect(()=>{n||k(null)},[n,k]),f.useEffect(()=>{i&&localStorage.setItem("valgtDato",i.toISOString())},[i]),o||!r?e.jsx(D,{}):e.jsx(J,{baner:a,valgtBaneId:r,onBaneChange:t,valgtDato:i,onDatoChange:c,slots:l,isLoading:j,currentUser:n,apenSlotTid:g,setApenSlotTid:k,onBook:p,onCancel:x,onDelete:b})}function ce(){return e.jsx(y,{children:e.jsx(X,{})})}export{ce as default};
