import{j as s,r as m}from"./shadcn-mOdBhBu9.js";import{f as j,D as S}from"./DatoVelger-CxCalxD8.js";import{B}from"./BookingSlotItem-DqZFsrZ2.js";import{L as T,u as Q,a as M,b as A,t as p,c as D,k as E,d as $,e as L,B as I}from"./index-CYoHqIT9.js";import{u as C}from"./useBaner-Dh0Ak8Hz.js";import{P as N}from"./Page-DGRPpX6y.js";import{S as K}from"./SimpleTabsLazy-HWGk_Ewh.js";import{D as w,a as O,b as P,c as R,d as V,e as q}from"./dialog-cwAo6BDm.js";import{a as F}from"./lucide-ByENZzyU.js";import"./react-RGnvvjkK.js";import"./checkbox-C6XQ3Q6l.js";import"./index-Bb2dXpgu.js";import"./index-BRMy6Ggk.js";function _({slots:n,currentUser:u,onBook:a,onCancel:t,onDelete:c,apenSlotTid:f,setApenSlotTid:r,isLoading:b=!1}){return b?s.jsx(T,{}):n.length===0?s.jsx("div",{className:"text-muted text-sm italic py-4 text-center",children:"Ingen bookinger eller slots � vise."}):s.jsx("div",{className:"space-y-2",children:n.map(o=>{const g=`${o.dato}-${o.startTid}-${o.baneId}`;return s.jsx(B,{slot:o,currentUser:u,onBook:a,onCancel:t,onDelete:c,isOpen:f===g,onToggle:()=>r?.(f===g?null:g)},g)})})}function z(n,u){const a=Q(),t=M(),[c,f]=m.useState(null),r=["bookinger",a,u,n],b=!!u&&!!n,o=A(r,`/klubb/${a}/bookinger?baneId=${u}&dato=${n}`,{requireAuth:!0,enabled:b,staleTime:0,refetchInterval:3e4,refetchOnWindowFocus:!0,refetchIntervalInBackground:!1,placeholderData:E}),g=m.useRef(!1);m.useEffect(()=>{if(!o.error){g.current=!1;return}g.current||(p.error(o.error.message??"Kunne ikke hente bookinger"),g.current=!0)},[o.error]);const k=()=>{t.invalidateQueries({queryKey:r}),t.invalidateQueries({queryKey:["mineBookinger",a]})},v=(e,l)=>e.startTid===l.startTid&&e.sluttTid===l.sluttTid,h=D("post",`/klubb/${a}/bookinger`,{onMutate:async e=>{await t.cancelQueries({queryKey:r});const l=t.getQueryData(r);return t.setQueryData(r,(i=[])=>i.map(d=>v(d,e)?{...d,booketAv:"Du",erEier:!0,kanBookes:!1,kanAvbestille:!0}:d)),{previous:l}},onError:(e,l,i)=>{i?.previous&&t.setQueryData(r,i.previous),p.error(e.message??"Kunne ikke booke.")},onSuccess:(e,l)=>{const i=`${l.startTid.slice(0,2)}-${l.sluttTid.slice(0,2)}`;p.success(`Booket ${i}`)},onSettled:()=>{k()}}),x=D("delete",`/klubb/${a}/bookinger`,{onMutate:async e=>{await t.cancelQueries({queryKey:r});const l=t.getQueryData(r);return t.setQueryData(r,(i=[])=>i.map(d=>v(d,e)?{...d,booketAv:null,erEier:!1,kanBookes:!0,kanAvbestille:!1,kanSlette:!1}:d)),{previous:l}},onError:(e,l,i)=>{i?.previous&&t.setQueryData(r,i.previous),p.error(e.message??"Kunne ikke avbestille.")},onSuccess:()=>{p.info("Bookingen er avbestilt.")},onSettled:()=>{k()}}),y=D("delete",`/klubb/${a}/bookinger/admin`,{onMutate:async e=>{await t.cancelQueries({queryKey:r});const l=t.getQueryData(r);return t.setQueryData(r,(i=[])=>i.map(d=>v(d,e)?{...d,booketAv:null,erEier:!1,kanBookes:!0,kanAvbestille:!1,kanSlette:!1}:d)),{previous:l}},onError:(e,l,i)=>{i?.previous&&t.setQueryData(r,i.previous),p.error(e.message??"Kunne ikke slette booking.")},onSuccess:()=>{p.success("Booking slettet"),f(null)},onSettled:()=>{k()}});return{slots:o.data??[],isLoading:o.isLoading,isFetching:o.isFetching,apenSlotTid:c,setApenSlotTid:f,onBook:e=>h.mutate({baneId:u,dato:n,startTid:e.startTid,sluttTid:e.sluttTid}),onCancel:e=>x.mutate({baneId:u,dato:n,startTid:e.startTid,sluttTid:e.sluttTid}),onDelete:e=>y.mutate({baneId:e.baneId??u,dato:e.dato??n,startTid:e.startTid,sluttTid:e.sluttTid}),hentBookinger:o.refetch}}function U({children:n}){const{data:u,isLoading:a}=$();if(a||!u)return null;const{bookingRegel:t}=u;return s.jsxs(w,{children:[s.jsx(O,{asChild:!0,children:n}),s.jsxs(P,{children:[s.jsxs(R,{children:[s.jsx(V,{children:"Bookingregler"}),s.jsx(q,{className:"sr-only",children:"Oversikt over bookingreglene i klubben"})]}),s.jsx("div",{className:"space-y-4",children:s.jsxs("ul",{className:"list-disc list-inside text-sm",children:[s.jsxs("li",{children:["Maks ",t.maksPerDag," bookinger per dag"]}),s.jsxs("li",{children:["Maks ",t.maksTotalt," aktive bookinger totalt"]}),s.jsxs("li",{children:["Opptil ",t.dagerFremITid," dager frem i tid"]}),s.jsxs("li",{children:[t.slotLengdeMinutter," minutter per booking"]}),s.jsxs("li",{children:["Tillatt mellom ",t.aapningstid,"–",t.stengetid]})]})})]})]})}function ie(){const{baner:n,isLoading:u}=C(!1),[a,t]=m.useState(""),[c,f]=m.useState(new Date),{currentUser:r}=L(),b=m.useMemo(()=>c?j(c,"yyyy-MM-dd"):"",[c]),{slots:o,apenSlotTid:g,setApenSlotTid:k,onBook:v,onCancel:h,onDelete:x,isLoading:y}=z(b,a);return m.useEffect(()=>{!a&&n.length>0&&t(n[0].id)},[n,a]),m.useEffect(()=>{k(null)},[c,a,k]),m.useEffect(()=>{r||k(null)},[r,k]),m.useEffect(()=>{c&&localStorage.setItem("valgtDato",c.toISOString())},[c]),u||!a?s.jsx(T,{}):s.jsxs(N,{children:[s.jsxs("div",{className:"flex justify-between items-center mb-2",children:[s.jsx(U,{children:s.jsx(I,{variant:"ghost",size:"icon",className:"rounded-full",title:"Vis banereglement",children:s.jsx(F,{className:"w-5 h-5"})})}),s.jsx(S,{value:c,onChange:e=>f(e??null),visNavigering:!0})]}),s.jsx(K,{items:n.map(e=>({value:e.id,label:e.navn,content:s.jsx(_,{slots:o,currentUser:r?{epost:r.email??""}:null,apenSlotTid:g,setApenSlotTid:k,onBook:v,onCancel:h,onDelete:x,isLoading:y})})),value:a,onValueChange:t})]})}export{ie as default};
