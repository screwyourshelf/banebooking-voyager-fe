import{r as g,j as e}from"./shadcn-CGWS6Fka.js";import{P as se}from"./Page-cxAHLmJB.js";import{s as re,h as ae,u as ie,a as oe,d as le,c as de,t as z,f as ge,B as L,F as ce,i as H,I as ue,l as he,m as pe,L as ke}from"./index-C3_SJj2x.js";import{u as me}from"./useBaner-BeOGvSnu.js";import{P as M,a as P,b as q,R as C}from"./RowList-DthgaHi0.js";import{T as fe,a as xe,b as W,c as K,d as ve,e as N,f as je,L as be,S as E,h as Z,u as G,i as _,t as J}from"./table-rb_SL4c6.js";import{S as Te,a as Se,b as Ce,c as ye,d as De}from"./select-BKYAeyxQ.js";import{D as X}from"./DatoVelger-BekmR9zd.js";import{D as Fe,b as we,c as Be,d as Ae,f as Ke}from"./dialog-BOOgHMIb.js";import"./react-RGnvvjkK.js";import"./lucide-C5rSQBgG.js";import"./switch-3Gj4XlTo.js";import"./index-DnnwNeRP.js";import"./index-2r_zrsQA.js";function Ne(t){if(!t)return;const n={...t};return delete n.requireAuth,delete n.axiosConfig,delete n.enabled,n}function Le(t,n,s,r){const a=(r?.enabled??!0)&&s!=null,o=r?.requireAuth??!0,l=Ne(r);return re({queryKey:t,enabled:a,retry:!1,...l,queryFn:async({signal:h})=>(await ae.post(n,s,{requireAuth:o,signal:h,timeout:2e4,...r?.axiosConfig??{}})).data})}function Y(t){const[n,s]=t.split(":").map(Number);return n*60+s}function Ve(t){const n=String(Math.floor(t/60)).padStart(2,"0"),s=String(t%60).padStart(2,"0");return`${n}:${s}`}function Ue(t,n,s){const r=Y(t),a=Y(n),o=[];for(let l=r;l+s<=a;l+=s)o.push(Ve(l));return o}const Ie={ledige:[],konflikter:[]};function Oe(t){const n={...t,ukedager:[...t.ukedager].sort((s,r)=>s-r),tidspunkter:[...t.tidspunkter].sort(),baneIder:[...t.baneIder].sort()};return JSON.stringify(n)}function Re(){const t=ie(),n=oe(),{data:s,isLoading:r}=le(),{baner:a,isLoading:o}=me(!1),l=g.useMemo(()=>{const c=s?.bookingRegel;if(!c)return[];const f=c.aapningstid||"08:00",D=c.stengetid||"22:00",T=c.slotLengdeMinutter||60;return Ue(f,D,T)},[s?.bookingRegel]),[h,u]=g.useState(null),x=h?["arrangement-forhandsvis",t,Oe(h)]:["arrangement-forhandsvis",t,"empty"],p=Le(x,`/klubb/${t}/arrangement/forhandsvis`,h,{requireAuth:!0,enabled:!!h,staleTime:6e4,retry:!1}),k=p.data??Ie,v=p.isFetching,j=async c=>(u(c),{success:!0}),m=()=>{u(null),n.cancelQueries({queryKey:["arrangement-forhandsvis",t]}),n.removeQueries({queryKey:["arrangement-forhandsvis",t]})},b=de("post",`/klubb/${t}/arrangement`,{onSuccess:async c=>{m(),z.success(`${c.opprettet.length} bookinger opprettet`)},onError:c=>z.error(c.message??"Feil ved oppretting"),retry:!1});return{klubb:s,baner:a,tilgjengeligeTidspunkter:l,forhandsvisning:k,forhandsvis:j,clearForhandsvisning:m,opprett:async c=>({success:!0,result:await b.mutateAsync(c)}),isLoading:r||o,isLoadingForhandsvisning:v}}function $(t){return`${t.dato}|${t.baneId}|${t.startTid}|${t.sluttTid}`}function Me({beskrivelse:t,forhandsvisning:n}){const s=g.useMemo(()=>new Set(n.konflikter.map($)),[n.konflikter]),r=g.useMemo(()=>{const a=[...n.ledige,...n.konflikter];return a.sort((o,l)=>o.dato.localeCompare(l.dato)||o.startTid.localeCompare(l.startTid)||o.baneId.localeCompare(l.baneId)),a},[n.ledige,n.konflikter]);return e.jsx("div",{className:"max-h-[60vh] overflow-auto rounded-md border",children:e.jsxs(fe,{children:[e.jsx(xe,{children:e.jsxs(W,{children:[e.jsx(K,{children:"Dato"}),e.jsx(K,{children:"Klokkeslett"}),e.jsx(K,{children:"Bane"}),e.jsx(K,{children:"Beskrivelse"})]})}),e.jsx(ve,{children:r.map(a=>{const o=s.has($(a)),l=a.baneNavn?.trim()||"(ukjent bane)";return e.jsxs(W,{className:ge("hover:bg-muted/50",o&&"bg-muted/40"),children:[e.jsx(N,{className:"align-top whitespace-nowrap",children:je(a.dato)}),e.jsxs(N,{className:"align-top whitespace-nowrap",children:[a.startTid," – ",a.sluttTid]}),e.jsx(N,{className:"align-top whitespace-nowrap",children:l}),e.jsxs(N,{className:"align-top",children:[t,o&&e.jsx("span",{className:"ml-2 text-xs text-muted-foreground",children:"(Konflikt)"})]})]},$(a))})})]})})}function Pe({open:t,onOpenChange:n,beskrivelse:s,forhandsvisning:r,isLoading:a,onCreate:o}){const l=r.ledige.length,h=r.konflikter.length,u=l+h>0;return e.jsx(Fe,{open:t,onOpenChange:n,children:e.jsxs(we,{className:"max-w-3xl",children:[e.jsx(Be,{children:e.jsx(Ae,{children:"Forhåndsvis bookingene"})}),a?e.jsx("p",{className:"text-muted-foreground italic",children:"Laster forhåndsvisning…"}):u?e.jsxs(e.Fragment,{children:[e.jsx(Me,{beskrivelse:s,forhandsvisning:r}),e.jsx(Ke,{className:"mt-3",children:e.jsxs(L,{type:"button",onClick:o,children:["Opprett ",l," bookinger"]})})]}):e.jsx("p",{className:"text-muted-foreground italic",children:"Ingen bookinger å vise."})]})})}const qe=["Man","Tir","Ons","Tor","Fre","Lør","Søn"];function Ee(t){const{kategorier:n,kategori:s,beskrivelse:r,datoFra:a,datoTil:o,baner:l,tilgjengeligeUkedager:h,tilgjengeligeTidspunkter:u,valgteBaner:x,valgteUkedager:p,valgteTidspunkter:k,alleBaner:v,alleUkedager:j,alleTidspunkter:m,dialogOpen:b,forhandsvisning:y,isLoadingForhandsvisning:c,onChangeKategori:f,onChangeBeskrivelse:D,onChangeDatoFra:T,onChangeDatoTil:V,onToggleAlleBaner:F,onToggleAlleUkedager:U,onToggleAlleTidspunkter:B,onToggleBane:I,onToggleUkedag:A,onToggleTidspunkt:O,onOpenPreview:R,onCreate:w,onDialogOpenChange:S}=t;return e.jsxs(e.Fragment,{children:[e.jsxs(ce,{onSubmit:i=>{i.preventDefault(),R()},children:[e.jsx(M,{title:"Type",description:"Kategori og beskrivelse for arrangementet.",children:e.jsx(P,{children:e.jsxs(q,{children:[e.jsx(C,{title:"Kategori",description:"Velg type arrangement.",children:e.jsxs(H,{children:[e.jsx(be,{htmlFor:"kategori",className:"sr-only",children:"Kategori"}),e.jsxs(Te,{value:s,onValueChange:f,children:[e.jsx(Se,{id:"kategori",children:e.jsx(Ce,{placeholder:"Velg kategori..."})}),e.jsx(ye,{children:n.map(i=>e.jsx(De,{value:i,children:i},i))})]})]})}),e.jsx(C,{title:"Beskrivelse",description:"Vises på bookingene.",children:e.jsx(H,{children:e.jsx(ue,{id:"beskrivelse",value:r,onChange:i=>D(i.target.value)})})})]})})}),e.jsx(M,{title:"Periode",description:"Velg dato-intervallet og hvilke ukedager som gjelder.",children:e.jsx(P,{children:e.jsxs(q,{children:[e.jsx(C,{title:"Fra",description:"Startdato.",children:e.jsx(X,{value:a,onChange:T,visNavigering:!0})}),e.jsx(C,{title:"Til",description:"Sluttdato.",children:e.jsx(X,{value:o,onChange:V,visNavigering:!0})}),e.jsx(E,{title:"Alle gyldige dager",description:"Velger automatisk alle dager som finnes i perioden.",checked:j,onCheckedChange:U}),e.jsx(C,{title:"Ukedager",description:"Bare dager som finnes i perioden er aktive.",children:e.jsx("div",{className:"flex flex-wrap gap-2",children:qe.map(i=>e.jsx(L,{type:"button",variant:p.includes(i)?"default":"outline",size:"sm",onClick:()=>A(i),disabled:j||!h.includes(i),children:i},i))})})]})})}),e.jsx(M,{title:"Baner og tid",description:"Velg hvilke baner og tidspunkter som skal reserveres.",children:e.jsx(P,{children:e.jsxs(q,{children:[e.jsx(E,{title:"Velg alle baner",checked:v,onCheckedChange:F}),e.jsx(C,{title:"Baner",description:"Velg hvilke baner arrangementet gjelder.",children:e.jsx("div",{className:"flex flex-wrap gap-2",children:l.map(i=>e.jsx(L,{type:"button",variant:x.includes(i.id)?"default":"outline",size:"sm",onClick:()=>I(i.id),disabled:v,children:i.navn},i.id))})}),e.jsx(E,{title:"Velg alle tidspunkter",checked:m,onCheckedChange:B}),e.jsx(C,{title:"Tidspunkter",description:"Velg start-tidspunkt for bookingene.",children:e.jsx("div",{className:"flex flex-wrap gap-2",children:u.map(i=>e.jsx(L,{type:"button",variant:k.includes(i)?"default":"outline",size:"sm",onClick:()=>O(i),disabled:m,children:i},i))})})]})})}),e.jsx(he,{variant:"sticky",children:e.jsx(pe,{isLoading:c,loadingText:"Forhåndsviser…",fullWidth:!0,children:"Forhåndsvis bookinger"})})]}),e.jsx(Pe,{open:b,onOpenChange:S,beskrivelse:r,forhandsvisning:y,isLoading:c,onCreate:w})]})}function $e(t,n){const s=Z(t,n),r=new Set;for(const a of s){const o=G.find(l=>_[l]===a);o&&r.add(o)}return G.filter(a=>r.has(a))}function Qe(t){const{datoFra:n,datoTil:s,valgteBaner:r,valgteUkedager:a,valgteTidspunkter:o,kategori:l,beskrivelse:h,onWarning:u}=t;if(r.length===0)return u("Du må velge minst én bane"),null;if(o.length===0)return u("Du må velge minst ett tidspunkt"),null;if(a.length===0)return u("Du må velge minst én ukedag"),null;const x=Z(n,s),p=a.map(k=>_[k]).filter(k=>x.has(k));return p.length===0?(u("Ingen av de valgte ukedagene finnes i datointervallet"),null):{tittel:l,beskrivelse:h?.trim()?h:void 0,kategori:l,startDato:J(n),sluttDato:J(s),ukedager:p,tidspunkter:o,baneIder:r}}const ze=["Trening","Turnering","Klubbmersterskap","Kurs","Lagkamp","Stigespill","Dugnad","Vedlikehold","Sosialt","Annet"];function Q(t,n){n(s=>s.includes(t)?s.filter(r=>r!==t):[...s,t])}function He(){const{baner:t,tilgjengeligeTidspunkter:n,forhandsvisning:s,forhandsvis:r,clearForhandsvisning:a,opprett:o,isLoading:l,isLoadingForhandsvisning:h}=Re(),[u,x]=g.useState(new Date),[p,k]=g.useState(new Date),[v,j]=g.useState([]),[m,b]=g.useState([]),[y,c]=g.useState([]),[f,D]=g.useState(!1),[T,V]=g.useState(!1),[F,U]=g.useState(!1),[B,I]=g.useState("Annet"),[A,O]=g.useState(""),[R,w]=g.useState(!1),S=g.useMemo(()=>$e(u,p),[u,p]);g.useEffect(()=>{f&&j(t.map(d=>d.id))},[f,t]),g.useEffect(()=>{T&&b(S)},[T,S]),g.useEffect(()=>{F&&c(n)},[F,n]),g.useEffect(()=>{b(d=>d.filter(ne=>S.includes(ne)))},[S]);const i=()=>Qe({datoFra:u,datoTil:p,valgteBaner:v,valgteUkedager:m,valgteTidspunkter:y,kategori:B,beskrivelse:A,onWarning:d=>z.warning(d)}),ee=async()=>{const d=i();d&&(w(!0),await r(d))},te=async()=>{const d=i();d&&(await o(d),a(),w(!1))};return l?e.jsx(ke,{}):e.jsx(Ee,{kategorier:ze,kategori:B,beskrivelse:A,datoFra:u,datoTil:p,baner:t,tilgjengeligeUkedager:S,tilgjengeligeTidspunkter:n,valgteBaner:v,valgteUkedager:m,valgteTidspunkter:y,alleBaner:f,alleUkedager:T,alleTidspunkter:F,dialogOpen:R,forhandsvisning:s,isLoadingForhandsvisning:h,onChangeKategori:I,onChangeBeskrivelse:O,onChangeDatoFra:x,onChangeDatoTil:k,onToggleAlleBaner:D,onToggleAlleUkedager:V,onToggleAlleTidspunkter:U,onToggleBane:d=>Q(d,j),onToggleUkedag:d=>Q(d,b),onToggleTidspunkt:d=>Q(d,c),onOpenPreview:ee,onCreate:te,onDialogOpenChange:d=>{w(d),d||a()}})}function ot(){return e.jsx(se,{children:e.jsx(He,{})})}export{ot as default};
