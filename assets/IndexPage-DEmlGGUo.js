import{r as k,j as t}from"./shadcn-BW0HktFr.js";import{f as B,D as S}from"./DatoVelger-CSTxVIQm.js";import{F as D,L as y,u as w,a as E,t as p,b as j,c as N,d as A,B as $}from"./index-CzxoQ6zV.js";import{B as Q}from"./BookingActions-ro987vvC.js";import{u as M}from"./useBaner-DQTfcJlE.js";import{u as T}from"./useSlug-Cz8CiGa-.js";import{P as L}from"./Page-B60DnEFg.js";import{S as I}from"./SimpleTabsLazy-BZ3XvqyC.js";import{D as C,a as P,b as _,c as K,d as z,e as R}from"./dialog-Bqatb_7H.js";import{a as V}from"./lucide-D2dOsrR-.js";import"./react-RGnvvjkK.js";import"./checkbox-BbFqfSU5.js";import"./index-CVVkWozz.js";import"./index-CJjGIk76.js";function q({slot:e,isOpen:n,erInteraktiv:o,currentUser:s}){const u=`${e.startTid.slice(0,2)}-${e.sluttTid.slice(0,2)}`,l=!!e.arrangementTittel,[a,c]=k.useState(!1);k.useEffect(()=>{const v=()=>c(window.innerWidth<640);return v(),window.addEventListener("resize",v),()=>window.removeEventListener("resize",v)},[]);const m=40,f=e.arrangementBeskrivelse&&a&&e.arrangementBeskrivelse.length>m?e.arrangementBeskrivelse.slice(0,m)+"...":e.arrangementBeskrivelse;return t.jsx("div",{className:"flex items-center",children:t.jsxs("div",{className:"flex flex-1 items-center justify-between",children:[t.jsx("div",{className:"whitespace-nowrap font-semibold text-sm text-right pr-1",children:u}),t.jsx("div",{className:"w-[18px] h-[18px] flex items-center justify-center",children:e.værSymbol?t.jsx("img",{src:`/banebooking-voyager-fe/weather-symbols/svg/${e.værSymbol}.svg`,alt:e.værSymbol,width:18,height:18,className:"select-none",draggable:!1}):t.jsx("span",{className:"invisible"})}),t.jsx("div",{className:"flex-grow text-sm p-1",children:l?t.jsxs("div",{children:[t.jsx("div",{className:"font-medium",children:e.arrangementTittel}),f&&t.jsx("div",{className:"text-xs text-gray-600",children:f})]}):t.jsx("div",{children:e.booketAv?s?e.booketAv:F(e.booketAv):"Ledig"})}),o&&t.jsx("div",{className:"p-1",children:t.jsx(D,{size:12,style:{transform:n?"rotate(180deg)":"rotate(0deg)",transition:"transform 0.2s"},"aria-hidden":"true"})})]})})}function F(e){const[n,o]=e.split("@");return!n||!o?e:`${n[0]}***@${o}`}function O({slot:e,time:n,erBekreftet:o,setErBekreftet:s,onBook:u,onCancel:l,onDelete:a,reset:c}){return t.jsx("div",{className:"mt-1",children:t.jsx("div",{className:"bg-inherit",children:t.jsx(Q,{slot:e,time:n,erBekreftet:o,setErBekreftet:s,onBook:u,onCancel:l,onDelete:a,reset:c})})})}function H({slot:e,currentUser:n,isOpen:o=!1,onToggle:s,onBook:u=()=>{},onCancel:l=()=>{},onDelete:a=()=>{}}){const[c,m]=k.useState(!1),f=()=>m(!1),v=`${e.startTid.slice(0,2)}-${e.sluttTid.slice(0,2)}`,b=e.kanBookes||e.kanAvbestille||e.kanSlette,x=!!n&&b&&!e.erPassert,h=!!e.arrangementTittel,r=e.erEier===!0,d=["border rounded shadow-sm p-2 mb-2","transition-colors duration-300 ease-in-out",e.erPassert?"bg-gray-100 text-gray-400":"",!e.erPassert&&h?"bg-gradient-to-r from-blue-0 via-blue-50 to-blue-200 border-blue-200":"",!e.erPassert&&!h?"bg-white text-gray-900":"",n&&r&&!h?"animate__animated animate__headShake animate__slow":""].join(" "),i=()=>{x&&s&&(s(),m(!1))};return t.jsxs("div",{className:d,style:{cursor:x?"pointer":"default",opacity:e.erPassert?.5:1},onClick:g=>{g.target.closest("button, input, label")||i()},role:x?"button":void 0,tabIndex:x?0:void 0,onKeyDown:g=>{(g.key==="Enter"||g.key===" ")&&(g.preventDefault(),i())},children:[t.jsx(q,{slot:e,isOpen:o,erInteraktiv:x,currentUser:n}),o&&!e.erPassert&&t.jsx(O,{slot:e,time:v,erBekreftet:c,setErBekreftet:m,onBook:u,onCancel:l,onDelete:a,reset:f})]})}function W({slots:e,currentUser:n,onBook:o,onCancel:s,onDelete:u,apenSlotTid:l,setApenSlotTid:a,isLoading:c=!1}){return c?t.jsx(y,{}):e.length===0?t.jsx("div",{className:"text-muted text-sm italic py-4 text-center",children:"Ingen bookinger eller slots � vise."}):t.jsx("div",{className:"space-y-2",children:e.map(m=>{const f=`${m.dato}-${m.startTid}-${m.baneId}`;return t.jsx(H,{slot:m,currentUser:n,onBook:o,onCancel:s,onDelete:u,isOpen:l===f,onToggle:()=>a?.(l===f?null:f)},f)})})}function G(e,n,o){const s=w(),[u,l]=k.useState(null),a=["bookinger",e??"",o??"",n??""],c=E(a,`/klubb/${e}/bookinger?baneId=${o}&dato=${n}`,{requireAuth:!0,enabled:!!e&&!!o&&!!n,staleTime:0,refetchInterval:3e4,refetchOnWindowFocus:!0,refetchIntervalInBackground:!1,placeholderData:[]}),m=k.useRef(!1);k.useEffect(()=>{if(!c.error){m.current=!1;return}m.current||(p.error(c.error.message??"Kunne ikke hente bookinger"),m.current=!0)},[c.error]);const f=()=>{s.invalidateQueries({queryKey:a}),s.invalidateQueries({queryKey:["mineBookinger",e]})},v=(r,d)=>r.startTid===d.startTid&&r.sluttTid===d.sluttTid,b=j("post",`/klubb/${e}/bookinger`,{onMutate:async r=>{await s.cancelQueries({queryKey:a});const d=s.getQueryData(a);return s.setQueryData(a,(i=[])=>i.map(g=>v(g,r)?{...g,booketAv:"Du",erEier:!0,kanBookes:!1,kanAvbestille:!0}:g)),{previous:d}},onError:(r,d,i)=>{i?.previous&&s.setQueryData(a,i.previous),p.error(r.message??"Kunne ikke booke.")},onSuccess:(r,d)=>{const i=`${d.startTid.slice(0,2)}-${d.sluttTid.slice(0,2)}`;p.success(`Booket ${i}`)},onSettled:()=>{f()}}),x=j("delete",`/klubb/${e}/bookinger`,{onMutate:async r=>{await s.cancelQueries({queryKey:a});const d=s.getQueryData(a);return s.setQueryData(a,(i=[])=>i.map(g=>v(g,r)?{...g,booketAv:null,erEier:!1,kanBookes:!0,kanAvbestille:!1,kanSlette:!1}:g)),{previous:d}},onError:(r,d,i)=>{i?.previous&&s.setQueryData(a,i.previous),p.error(r.message??"Kunne ikke avbestille.")},onSuccess:()=>{p.info("Bookingen er avbestilt.")},onSettled:()=>{f()}}),h=j("delete",`/klubb/${e}/bookinger/admin`,{onMutate:async r=>{await s.cancelQueries({queryKey:a});const d=s.getQueryData(a);return s.setQueryData(a,(i=[])=>i.map(g=>v(g,r)?{...g,booketAv:null,erEier:!1,kanBookes:!0,kanAvbestille:!1,kanSlette:!1}:g)),{previous:d}},onError:(r,d,i)=>{i?.previous&&s.setQueryData(a,i.previous),p.error(r.message??"Kunne ikke slette booking.")},onSuccess:()=>{p.success("Booking slettet"),l(null)},onSettled:()=>{f()}});return{slots:c.data??[],isLoading:c.isLoading,apenSlotTid:u,setApenSlotTid:l,onBook:r=>b.mutate({baneId:o,dato:n,startTid:r.startTid,sluttTid:r.sluttTid}),onCancel:r=>x.mutate({baneId:o,dato:n,startTid:r.startTid,sluttTid:r.sluttTid}),onDelete:r=>h.mutate({baneId:r.baneId??o,dato:r.dato??n,startTid:r.startTid,sluttTid:r.sluttTid}),hentBookinger:c.refetch}}function J({children:e}){const n=T(),{data:o,isLoading:s}=N(n);if(s||!o)return null;const{bookingRegel:u}=o;return t.jsxs(C,{children:[t.jsx(P,{asChild:!0,children:e}),t.jsxs(_,{children:[t.jsxs(K,{children:[t.jsx(z,{children:"Bookingregler"}),t.jsx(R,{className:"sr-only",children:"Oversikt over bookingreglene i klubben"})]}),t.jsx("div",{className:"space-y-4",children:t.jsxs("ul",{className:"list-disc list-inside text-sm",children:[t.jsxs("li",{children:["Maks ",u.maksPerDag," bookinger per dag"]}),t.jsxs("li",{children:["Maks ",u.maksTotalt," aktive bookinger totalt"]}),t.jsxs("li",{children:["Opptil ",u.dagerFremITid," dager frem i tid"]}),t.jsxs("li",{children:[u.slotLengdeMinutter," minutter per booking"]}),t.jsxs("li",{children:["Tillatt mellom ",u.aapningstid,"–",u.stengetid]})]})})]})]})}function de(){const e=T(),{baner:n,isLoading:o}=M(e,!1),[s,u]=k.useState(""),[l,a]=k.useState(new Date),{currentUser:c}=A(),m=k.useMemo(()=>l?B(l,"yyyy-MM-dd"):"",[l]),{slots:f,apenSlotTid:v,setApenSlotTid:b,onBook:x,onCancel:h,onDelete:r,isLoading:d}=G(e,m,s);return k.useEffect(()=>{!s&&n.length>0&&u(n[0].id)},[n,s]),k.useEffect(()=>{b(null)},[l,s,b]),k.useEffect(()=>{c||b(null)},[c,b]),k.useEffect(()=>{l&&localStorage.setItem("valgtDato",l.toISOString())},[l]),o||!s?t.jsx(y,{}):t.jsxs(L,{children:[t.jsxs("div",{className:"flex justify-between items-center mb-2",children:[t.jsx(J,{children:t.jsx($,{variant:"ghost",size:"icon",className:"rounded-full",title:"Vis banereglement",children:t.jsx(V,{className:"w-5 h-5"})})}),t.jsx(S,{value:l,onChange:i=>a(i??null),visNavigering:!0})]}),t.jsx(I,{items:n.map(i=>({value:i.id,label:i.navn,content:t.jsx(W,{slots:f,currentUser:c?{epost:c.email??""}:null,apenSlotTid:v,setApenSlotTid:b,onBook:x,onCancel:h,onDelete:r,isLoading:d})})),value:s,onValueChange:u})]})}export{de as default};
