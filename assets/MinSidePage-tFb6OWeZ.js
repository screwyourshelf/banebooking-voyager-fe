import{j as e,r as u}from"./shadcn-mOdBhBu9.js";import{u as M}from"./useSlug-DMGJr7eH.js";import{P as w}from"./Page-pTszYvfk.js";import{S as B}from"./SimpleTabsLazy-Cmj-F3Ld.js";import{a as $,b as A,t as v,e as I,L as T,B as V,d as O,f as R,u as K}from"./index-DACapAhf.js";import{S as f,a as S}from"./SettingsRow-SsVQpD69.js";import{S as b}from"./SettingsSection-DfNPesyK.js";import{F}from"./FormField-Yytd7LCQ.js";import{A as H,a as U,b as q,c as Q,d as _,e as z,f as G,g as X,h as J}from"./alert-dialog-BhfCC4US.js";import{f as D}from"./datoUtils-CMdMNzgI.js";import{S as W}from"./SwitchRow-Dtxv7Wv4.js";import{B as Y}from"./BookingSlotItem-Bql7-nYg.js";import"./react-RGnvvjkK.js";import"./lucide-ByENZzyU.js";import"./FieldWrapper-BhwyvJQg.js";import"./index-BRMy6Ggk.js";import"./switch-CqkRJ2Qn.js";import"./index-Bb2dXpgu.js";import"./checkbox-CS2usIo5.js";function N({label:r,value:n,description:s,className:i=""}){return e.jsx(f,{title:r,description:s,className:i,children:n})}function P(r){const n=$(["meg",r],`/klubb/${r}/bruker/meg`,{requireAuth:!0,enabled:!!r,staleTime:6e4}),s=A("patch",`/klubb/${r}/bruker/meg`,{onSuccess:()=>{v.success("Visningsnavn oppdatert"),n.refetch()},onError:c=>{v.error(c.message??"Kunne ikke oppdatere visningsnavn")}}),i=A("delete",`/klubb/${r}/bruker/meg`,{onSuccess:()=>v.success("Brukeren er slettet"),onError:c=>v.error(c.message??"Kunne ikke slette bruker")}),d=async()=>{if(!r)return;const c=await I.get(`/klubb/${r}/bruker/meg/egen-data`,{requireAuth:!0,responseType:"blob"}),l=c.data,m=c.headers?.["content-disposition"]?.match(/filename\*=UTF-8''([^;]+)|filename="?([^"]+)"?/i),h=decodeURIComponent(m?.[1]??m?.[2]??"")||`banebooking-data-${new Date().toISOString().slice(0,10)}.json`,t=URL.createObjectURL(l),a=document.createElement("a");a.href=t,a.download=h,document.body.appendChild(a),a.click(),a.remove(),URL.revokeObjectURL(t)};return{bruker:n.data,laster:n.isLoading,error:n.error,refetch:n.refetch,lastNedEgenData:d,oppdaterVisningsnavn:s,slettMeg:i}}const y=50,Z=/^[\p{L}\d\s.@'_%+-]{2,}$/u;function ee({slug:r}){const{bruker:n,laster:s,oppdaterVisningsnavn:i}=P(r),{mutateAsync:d,isPending:c}=i,[l,g]=u.useState("epost"),[m,k]=u.useState(""),[h,t]=u.useState(null);u.useEffect(()=>{if(!n)return;const o=n.visningsnavn?.trim();!o||o===n.epost?(g("epost"),k("")):(g("navn"),k(o)),t(null)},[n]);const a=u.useMemo(()=>n?l==="epost"?n.epost:m.trim():"",[n,l,m]),p=u.useMemo(()=>{if(!n)return"Ukjent feil.";if(l==="epost")return null;const o=m.trim();return o.length===0?"Visningsnavn kan ikke være tomt.":o.length<3?"Visningsnavn må være minst 3 tegn.":Z.test(o)?o.length>y?`Visningsnavn kan ikke være lengre enn ${y} tegn.`:null:"Visningsnavn inneholder ugyldige tegn."},[n,l,m]),L=u.useMemo(()=>{if(!n)return!1;const o=a,x=(n.visningsnavn??"").trim();return o.length===0||o===x?!1:l==="navn"?!p:!0},[n,a,l,p]);async function j(){n&&(t(p),!p&&await d({visningsnavn:a}))}return s||!n?e.jsx(T,{}):e.jsxs("div",{className:"space-y-4",children:[e.jsx(b,{title:"Min profil",description:"Velg hva som vises som navnet ditt i appen.",children:e.jsxs(S,{children:[e.jsx(f,{title:"Visningsnavn",description:"Velg e-post eller et eget navn.",children:e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"flex items-center gap-2 text-sm cursor-pointer select-none",children:[e.jsx("input",{type:"radio",name:"visningsnavn-mode",checked:l==="epost",onChange:()=>{g("epost"),t(null)}}),e.jsxs("span",{children:["E-post (",n.epost,")"]})]}),e.jsxs("label",{className:"flex items-center gap-2 text-sm cursor-pointer select-none",children:[e.jsx("input",{type:"radio",name:"visningsnavn-mode",checked:l==="navn",onChange:()=>{g("navn"),t(null)}}),e.jsx("span",{children:"Eget navn"})]})]})}),l==="navn"?e.jsx(f,{title:"Eget navn",description:`Maks ${y} tegn.`,children:e.jsx(F,{id:"visningsnavn",label:"Eget navn",hideLabel:!0,value:m,error:h,onChange:o=>{k(o.target.value),h&&t(null)},inputProps:{placeholder:"f.eks. Ola Nordmann",maxLength:y}})}):null,e.jsx(f,{title:"Dette vil lagres",description:"Slik vil navnet ditt vises.",right:e.jsx(V,{type:"button",size:"sm",disabled:!L||c,onClick:()=>void j(),children:c?"Lagrer...":"Lagre"}),children:e.jsx("div",{className:"text-sm text-foreground break-words",children:a})})]})}),e.jsx(b,{title:"Konto",description:"Denne informasjonen kan bare endres av klubbadministrator.",children:e.jsxs(S,{children:[e.jsx(N,{label:"Brukernavn / ID",value:n.epost}),e.jsx(N,{label:"Tilgang",value:n.roller.join(", ")})]})})]})}function ne({slettMeg:r}){const{signOut:n}=O(),[s,i]=u.useState(!1),d=async()=>{try{await r.mutateAsync(),i(!1),await n()}catch{}};return e.jsxs(H,{open:s,onOpenChange:i,children:[e.jsx(U,{asChild:!0,children:e.jsx(V,{variant:"destructive",disabled:r.isPending,children:r.isPending?"Sletter...":"Slett min bruker"})}),e.jsxs(q,{children:[e.jsxs(Q,{children:[e.jsx(_,{children:"Er du sikker?"}),e.jsx(z,{children:"Dette vil slette din bruker og all tilknytning permanent. Denne handlingen kan ikke angres."})]}),e.jsxs(G,{children:[e.jsx(X,{disabled:r.isPending,children:"Avbryt"}),e.jsx(J,{variant:"destructive",onClick:d,disabled:r.isPending,children:r.isPending?"Sletter...":"Slett bruker"})]})]})]})}function te({slug:r}){const{bruker:n,laster:s,lastNedEgenData:i,slettMeg:d}=P(r),{isPending:c}=d;if(s||!n)return e.jsx(T,{});const l=n.vilkaarAkseptertDato?`Akseptert ${D(n.vilkaarAkseptertDato)}${n.vilkaarVersjon?` (versjon ${n.vilkaarVersjon})`:""}`:"Ikke registrert";return e.jsxs("div",{className:"space-y-4",children:[e.jsx(b,{title:"Persondata",description:"Her kan du se vilkår og laste ned egne data.",children:e.jsxs(S,{children:[e.jsx(N,{label:"Vilkår",description:"Vilkårene aksepteres automatisk ved første innlogging.",value:l}),e.jsx(f,{title:"Les vilkårene",description:"Åpnes i ny fane.",right:e.jsx(R,{to:`/${r}/vilkaar`,className:"text-sm underline text-primary hover:text-primary/80",target:"_blank",rel:"noopener noreferrer",children:"Åpne"})}),e.jsx(f,{title:"Last ned dine data",description:"JSON med registrerte opplysninger og bookinger.",right:e.jsx(V,{onClick:i,size:"sm",variant:"outline",disabled:c,children:c?"Laster...":"Last ned"})})]})}),e.jsx(b,{title:"Slett bruker",description:"Sletter bruker og all tilknyttet data permanent.",children:e.jsx(S,{children:e.jsx(f,{title:"",description:"Dette kan ikke angres.",right:e.jsx(ne,{slettMeg:d})})})})]})}function re(r,n=!1){const s=$(["mineBookinger",r,n],`/klubb/${r}/bookinger/mine${n?"?inkluderHistoriske=true":""}`,{requireAuth:!0,enabled:!!r,staleTime:6e4}),i=u.useRef(!1);return u.useEffect(()=>{if(!s.error){i.current=!1;return}i.current||(v.error(s.error.message??"Ukjent feil ved henting av bookinger"),i.current=!0)},[s.error]),s}function se(r){const n=K(),s=r??"",i=()=>{n.invalidateQueries({queryKey:["mineBookinger",s]}),n.invalidateQueries({queryKey:["bookinger",s]})},d=A("delete",`/klubb/${r}/bookinger`,{onError:g=>{v.error(g.message??"Kunne ikke avbestille.")},onSuccess:()=>{v.info("Bookingen er avbestilt.")},onSettled:()=>{i()}});return{avbestill:g=>{if(!r){v.error("Mangler klubb (slug).");return}d.mutate(g)},avbestillAsync:async g=>{if(!r){v.error("Mangler klubb (slug).");return}return d.mutateAsync(g)},isPending:d.isPending}}function ie({slug:r}){const[n,s]=u.useState(!1),{data:i=[],isLoading:d}=re(r,n),{avbestillAsync:c,isPending:l}=se(r),[g,m]=u.useState(null),k=u.useMemo(()=>[...i].sort((t,a)=>{const p=new Date(a.dato).getTime()-new Date(t.dato).getTime();return p!==0?p:a.startTid.localeCompare(t.startTid)}),[i]);async function h(t){l||(await c({baneId:t.baneId,dato:t.dato,startTid:t.startTid,sluttTid:t.sluttTid}),m(null))}return d?e.jsx(T,{}):e.jsx("div",{className:"space-y-4",children:e.jsx(b,{title:"Bookinger",description:"Se kommende bookinger og velg om du vil inkludere tidligere.",children:e.jsxs("div",{className:"space-y-3",children:[e.jsx(W,{title:"Vis også tidligere bookinger",description:"Inkluder bookinger som allerede er gjennomført.",checked:n,onCheckedChange:t=>{s(t),m(null)}}),k.length===0?e.jsx("div",{className:"text-sm text-muted-foreground italic",children:n?"Du har ingen registrerte bookinger.":"Du har ingen kommende bookinger."}):e.jsx("div",{className:l?"pointer-events-none opacity-60":"",children:k.map(t=>{const a=`${t.baneId}-${t.dato}-${t.startTid}-${t.sluttTid}`,p=g===a,j=!!t.kanAvbestille&&!t.erPassert,o=typeof t.temperatur=="number",x=typeof t.vind=="number",C=!!t.værSymbol||o||x?e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx("span",{children:D(t.dato)}),e.jsx("span",{className:"w-[18px] h-[18px] flex items-center justify-center",children:t.værSymbol?e.jsx("img",{src:`/banebooking-voyager-fe/weather-symbols/svg/${t.værSymbol}.svg`,alt:t.værSymbol,width:18,height:18,className:"select-none",draggable:!1}):e.jsx("span",{className:"invisible",children:"."})}),o||x?e.jsxs("span",{className:"text-[11px] text-muted-foreground",children:[o?`${t.temperatur}°`:null,o&&x?" · ":null,x?`${t.vind} m/s`:null]}):null]}):e.jsx("span",{className:"flex items-center gap-1",children:e.jsx("span",{children:D(t.dato)})});return e.jsx(Y,{slot:t,currentUser:null,erInteraktivOverride:j,isOpen:p,onToggle:()=>{j&&m(E=>E===a?null:a)},onCancel:()=>void h(t),headerOverrideTitle:t.baneNavn,headerLeftPrefix:C},a)})})]})})})}function Ne(){const[r,n]=u.useState("bookinger"),s=M();return e.jsx(w,{children:e.jsx(B,{items:[{value:"bookinger",label:"Mine bookinger",content:e.jsx(ie,{slug:s})},{value:"profil",label:"Min profil",content:e.jsx(ee,{slug:s})},{value:"persondata",label:"Persondata",content:e.jsx(te,{slug:s})}],value:r,onValueChange:n})})}export{Ne as default};
