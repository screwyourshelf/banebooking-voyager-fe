import{r as c,j as e}from"./react-Bq13ngtT.js";import{P as te}from"./Page-DzYq3R64.js";import{v as ne,m as ae,a as se,b as re,i as ie,e as oe,t as z,f as C,B as O,n as le,o as G,I as de,q as ce,r as ge,L as ue}from"./index-Bzex8V_f.js";import{u as he}from"./useBaner-D6nNAZ81.js";import{P,a as M,b as q,R as S}from"./RowList-BGi2Do7y.js";import{f as pe,L as me,S as $,d as ke,b as fe,c as xe,e as be,t as H}from"./datoUtils-BLr8kfab.js";import{S as je,a as ve,b as Te,c as ye,d as Se}from"./select-CdHJUXBo.js";import{D as _}from"./DatoVelger-B0Nt5C_e.js";import{D as Ce,b as we,c as De,d as Fe,f as Ne}from"./dialog-COtQF8jY.js";import"./shadcn-B0ihbUNs.js";import"./lucide-Bfr9gI8s.js";import"./switch-en2qxcLY.js";function Ae(t){if(!t)return;const n={...t};return delete n.requireAuth,delete n.axiosConfig,delete n.enabled,n}function Be(t,n,a,i){const r=(i?.enabled??!0)&&a!=null,l=i?.requireAuth??!0,o=Ae(i);return ne({queryKey:t,enabled:r,retry:!1,...o,queryFn:async({signal:h})=>(await ae.post(n,a,{requireAuth:l,signal:h,timeout:2e4,...i?.axiosConfig??{}})).data})}function J(t){const[n,a]=t.split(":").map(Number);return n*60+a}function Ke(t){const n=String(Math.floor(t/60)).padStart(2,"0"),a=String(t%60).padStart(2,"0");return`${n}:${a}`}function Le(t,n,a){const i=J(t),r=J(n),l=[];for(let o=i;o+a<=r;o+=a)l.push(Ke(o));return l}const Oe={ledige:[],konflikter:[]};function Ue(t){const n={...t,ukedager:[...t.ukedager].sort(),tidspunkter:[...t.tidspunkter].sort(),baneIder:[...t.baneIder].sort()};return JSON.stringify(n)}function Ve(){const t=se(),n=re(),{data:a,isLoading:i}=ie(),{baner:r,isLoading:l}=he(!1),o=c.useMemo(()=>{const g=a?.bookingRegel;if(!g)return[];const k=g.aapningstid||"08:00",D=g.stengetid||"22:00",T=g.slotLengdeMinutter||60;return Le(k,D,T)},[a?.bookingRegel]),[h,u]=c.useState(null),f=h?["arrangement-forhandsvis",t,Ue(h)]:["arrangement-forhandsvis",t,"empty"],p=Be(f,`/klubb/${t}/arrangement/forhandsvis`,h,{requireAuth:!0,enabled:!!h,staleTime:6e4,retry:!1}),x=p.data??Oe,b=p.isFetching,j=async g=>(u(g),{success:!0}),m=()=>{u(null),n.cancelQueries({queryKey:["arrangement-forhandsvis",t]}),n.removeQueries({queryKey:["arrangement-forhandsvis",t]})},v=oe("post",`/klubb/${t}/arrangement`,{onSuccess:async g=>{m(),z.success(`${g.antallOpprettet} bookinger opprettet`)},onError:g=>z.error(g.message??"Feil ved oppretting"),retry:!1});return{klubb:a,baner:r,tilgjengeligeTidspunkter:o,forhandsvisning:x,forhandsvis:j,clearForhandsvisning:m,opprett:async g=>({success:!0,result:await v.mutateAsync(g)}),isLoading:i||l,isLoadingForhandsvisning:b}}function Ie({className:t,...n}){return e.jsx("div",{"data-slot":"table-container",className:"relative w-full overflow-x-auto",children:e.jsx("table",{"data-slot":"table",className:C("w-full caption-bottom text-sm",t),...n})})}function Ee({className:t,...n}){return e.jsx("thead",{"data-slot":"table-header",className:C("[&_tr]:border-b",t),...n})}function Re({className:t,...n}){return e.jsx("tbody",{"data-slot":"table-body",className:C("[&_tr:last-child]:border-0",t),...n})}function X({className:t,...n}){return e.jsx("tr",{"data-slot":"table-row",className:C("hover:bg-muted/50 data-[state=selected]:bg-muted border-b transition-colors",t),...n})}function K({className:t,...n}){return e.jsx("th",{"data-slot":"table-head",className:C("text-foreground h-10 px-2 text-left align-middle font-medium whitespace-nowrap [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]",t),...n})}function L({className:t,...n}){return e.jsx("td",{"data-slot":"table-cell",className:C("p-2 align-middle whitespace-nowrap [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]",t),...n})}function W(t){return`${t.dato}|${t.baneId}|${t.startTid}|${t.sluttTid}`}function Pe({beskrivelse:t,forhandsvisning:n}){const a=c.useMemo(()=>new Set(n.konflikter.map(W)),[n.konflikter]),i=c.useMemo(()=>{const r=[...n.ledige,...n.konflikter];return r.sort((l,o)=>l.dato.localeCompare(o.dato)||l.startTid.localeCompare(o.startTid)||l.baneId.localeCompare(o.baneId)),r},[n.ledige,n.konflikter]);return e.jsx("div",{className:"max-h-[60vh] overflow-auto rounded-md border",children:e.jsxs(Ie,{children:[e.jsx(Ee,{children:e.jsxs(X,{children:[e.jsx(K,{children:"Dato"}),e.jsx(K,{children:"Klokkeslett"}),e.jsx(K,{children:"Bane"}),e.jsx(K,{children:"Beskrivelse"})]})}),e.jsx(Re,{children:i.map(r=>{const l=a.has(W(r)),o=r.baneNavn?.trim()||"(ukjent bane)";return e.jsxs(X,{className:C("hover:bg-muted/50",l&&"bg-muted/40"),children:[e.jsx(L,{className:"align-top whitespace-nowrap",children:pe(r.dato)}),e.jsxs(L,{className:"align-top whitespace-nowrap",children:[r.startTid," – ",r.sluttTid]}),e.jsx(L,{className:"align-top whitespace-nowrap",children:o}),e.jsxs(L,{className:"align-top",children:[t,l&&e.jsx("span",{className:"ml-2 text-xs text-muted-foreground",children:"(Konflikt)"})]})]},W(r))})})]})})}function Me({open:t,onOpenChange:n,beskrivelse:a,forhandsvisning:i,isLoading:r,onCreate:l}){const o=i.ledige.length,h=i.konflikter.length,u=o+h>0;return e.jsx(Ce,{open:t,onOpenChange:n,children:e.jsxs(we,{className:"max-w-3xl",children:[e.jsx(De,{children:e.jsx(Fe,{children:"Forhåndsvis bookingene"})}),r?e.jsx("p",{className:"text-muted-foreground italic",children:"Laster forhåndsvisning…"}):u?e.jsxs(e.Fragment,{children:[e.jsx(Pe,{beskrivelse:a,forhandsvisning:i}),e.jsx(Ne,{className:"mt-3",children:e.jsxs(O,{type:"button",onClick:l,children:["Opprett ",o," bookinger"]})})]}):e.jsx("p",{className:"text-muted-foreground italic",children:"Ingen bookinger å vise."})]})})}const qe=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];function $e(t){const{kategorier:n,kategori:a,beskrivelse:i,datoFra:r,datoTil:l,baner:o,tilgjengeligeUkedager:h,tilgjengeligeTidspunkter:u,valgteBaner:f,valgteUkedager:p,valgteTidspunkter:x,alleBaner:b,alleUkedager:j,alleTidspunkter:m,dialogOpen:v,forhandsvisning:w,isLoadingForhandsvisning:g,onChangeKategori:k,onChangeBeskrivelse:D,onChangeDatoFra:T,onChangeDatoTil:U,onToggleAlleBaner:F,onToggleAlleUkedager:V,onToggleAlleTidspunkter:A,onToggleBane:I,onToggleUkedag:B,onToggleTidspunkt:E,onOpenPreview:R,onCreate:N,onDialogOpenChange:y}=t;return e.jsxs(e.Fragment,{children:[e.jsxs(le,{onSubmit:s=>{s.preventDefault(),R()},children:[e.jsx(P,{title:"Type",description:"Kategori og beskrivelse for arrangementet.",children:e.jsx(M,{children:e.jsxs(q,{children:[e.jsx(S,{title:"Kategori",description:"Velg type arrangement.",children:e.jsxs(G,{children:[e.jsx(me,{htmlFor:"kategori",className:"sr-only",children:"Kategori"}),e.jsxs(je,{value:a,onValueChange:k,children:[e.jsx(ve,{id:"kategori",children:e.jsx(Te,{placeholder:"Velg kategori..."})}),e.jsx(ye,{children:n.map(s=>e.jsx(Se,{value:s,children:s},s))})]})]})}),e.jsx(S,{title:"Beskrivelse",description:"Vises på bookingene.",children:e.jsx(G,{children:e.jsx(de,{id:"beskrivelse",value:i,onChange:s=>D(s.target.value)})})})]})})}),e.jsx(P,{title:"Periode",description:"Velg dato-intervallet og hvilke ukedager som gjelder.",children:e.jsx(M,{children:e.jsxs(q,{children:[e.jsx(S,{title:"Fra",description:"Startdato.",children:e.jsx(_,{value:r,onChange:T,visNavigering:!0})}),e.jsx(S,{title:"Til",description:"Sluttdato.",children:e.jsx(_,{value:l,onChange:U,visNavigering:!0})}),e.jsx($,{title:"Alle gyldige dager",description:"Velger automatisk alle dager som finnes i perioden.",checked:j,onCheckedChange:V}),e.jsx(S,{title:"Ukedager",description:"Bare dager som finnes i perioden er aktive.",children:e.jsx("div",{className:"flex flex-wrap gap-2",children:qe.map(s=>e.jsx(O,{type:"button",variant:p.includes(s)?"default":"outline",size:"sm",onClick:()=>B(s),disabled:j||!h.includes(s),children:ke(s)},s))})})]})})}),e.jsx(P,{title:"Baner og tid",description:"Velg hvilke baner og tidspunkter som skal reserveres.",children:e.jsx(M,{children:e.jsxs(q,{children:[e.jsx($,{title:"Velg alle baner",checked:b,onCheckedChange:F}),e.jsx(S,{title:"Baner",description:"Velg hvilke baner arrangementet gjelder.",children:e.jsx("div",{className:"flex flex-wrap gap-2",children:o.map(s=>e.jsx(O,{type:"button",variant:f.includes(s.id)?"default":"outline",size:"sm",onClick:()=>I(s.id),disabled:b,children:s.navn},s.id))})}),e.jsx($,{title:"Velg alle tidspunkter",checked:m,onCheckedChange:A}),e.jsx(S,{title:"Tidspunkter",description:"Velg start-tidspunkt for bookingene.",children:e.jsx("div",{className:"flex flex-wrap gap-2",children:u.map(s=>e.jsx(O,{type:"button",variant:x.includes(s)?"default":"outline",size:"sm",onClick:()=>E(s),disabled:m,children:s},s))})})]})})}),e.jsx(ce,{variant:"sticky",children:e.jsx(ge,{isLoading:g,loadingText:"Forhåndsviser…",fullWidth:!0,children:"Forhåndsvis bookinger"})})]}),e.jsx(Me,{open:v,onOpenChange:y,beskrivelse:i,forhandsvisning:w,isLoading:g,onCreate:N})]})}function We(t,n){return fe(t,n)}function Qe(t){const{datoFra:n,datoTil:a,valgteBaner:i,valgteUkedager:r,valgteTidspunkter:l,kategori:o,beskrivelse:h,onWarning:u}=t;if(i.length===0)return u("Du må velge minst én bane"),null;if(l.length===0)return u("Du må velge minst ett tidspunkt"),null;if(r.length===0)return u("Du må velge minst én ukedag"),null;const f=xe(n,a),p=r.filter(x=>f.has(be(x)));return p.length===0?(u("Ingen av de valgte ukedagene finnes i datointervallet"),null):{tittel:o,beskrivelse:h?.trim()?h:void 0,kategori:o,startDato:H(n),sluttDato:H(a),ukedager:p,tidspunkter:l,baneIder:i}}const ze=["Trening","Turnering","Klubbmersterskap","Kurs","Lagkamp","Stigespill","Dugnad","Vedlikehold","Sosialt","Annet"];function Q(t,n){n(a=>a.includes(t)?a.filter(i=>i!==t):[...a,t])}function Ge(){const{baner:t,tilgjengeligeTidspunkter:n,forhandsvisning:a,forhandsvis:i,clearForhandsvisning:r,opprett:l,isLoading:o,isLoadingForhandsvisning:h}=Ve(),[u,f]=c.useState(new Date),[p,x]=c.useState(new Date),[b,j]=c.useState([]),[m,v]=c.useState([]),[w,g]=c.useState([]),[k,D]=c.useState(!1),[T,U]=c.useState(!1),[F,V]=c.useState(!1),[A,I]=c.useState("Annet"),[B,E]=c.useState(""),[R,N]=c.useState(!1),y=c.useMemo(()=>We(u,p),[u,p]);c.useEffect(()=>{k&&j(t.map(d=>d.id))},[k,t]),c.useEffect(()=>{T&&v(y)},[T,y]),c.useEffect(()=>{F&&g(n)},[F,n]),c.useEffect(()=>{v(d=>d.filter(ee=>y.includes(ee)))},[y]);const s=()=>Qe({datoFra:u,datoTil:p,valgteBaner:b,valgteUkedager:m,valgteTidspunkter:w,kategori:A,beskrivelse:B,onWarning:d=>z.warning(d)}),Y=async()=>{const d=s();d&&(N(!0),await i(d))},Z=async()=>{const d=s();d&&(await l(d),r(),N(!1))};return o?e.jsx(ue,{}):e.jsx($e,{kategorier:ze,kategori:A,beskrivelse:B,datoFra:u,datoTil:p,baner:t,tilgjengeligeUkedager:y,tilgjengeligeTidspunkter:n,valgteBaner:b,valgteUkedager:m,valgteTidspunkter:w,alleBaner:k,alleUkedager:T,alleTidspunkter:F,dialogOpen:R,forhandsvisning:a,isLoadingForhandsvisning:h,onChangeKategori:I,onChangeBeskrivelse:E,onChangeDatoFra:f,onChangeDatoTil:x,onToggleAlleBaner:D,onToggleAlleUkedager:U,onToggleAlleTidspunkter:V,onToggleBane:d=>Q(d,j),onToggleUkedag:d=>Q(d,v),onToggleTidspunkt:d=>Q(d,g),onOpenPreview:Y,onCreate:Z,onDialogOpenChange:d=>{N(d),d||r()}})}function it(){return e.jsx(te,{children:e.jsx(Ge,{})})}export{it as default};
