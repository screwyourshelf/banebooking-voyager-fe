import{j as e,r as g}from"./shadcn-BW0HktFr.js";import{u as C}from"./useSlug-Cz8CiGa-.js";import{P as L}from"./Page-B60DnEFg.js";import{S as E}from"./SimpleTabsLazy-BZ3XvqyC.js";import{a as $,b as S,t as f,e as M,L as A,B as D,d as B,f as K,u as R,F}from"./index-CzxoQ6zV.js";import{S as k,a as H}from"./SwitchRow-DtkuQg6j.js";import{F as I}from"./FormField-ko3_S3gj.js";import{A as O,a as U,b as q,c as Q,d as z,e as _,f as G,g as X,h as J}from"./alert-dialog-BmDoWmc7.js";import{f as P}from"./datoUtils-CMdMNzgI.js";import{B as W}from"./BookingActions-ro987vvC.js";import"./react-RGnvvjkK.js";import"./lucide-D2dOsrR-.js";import"./index-CVVkWozz.js";import"./index-CJjGIk76.js";import"./checkbox-BbFqfSU5.js";function y({children:n,className:t=""}){return e.jsx("div",{className:`rounded-md border bg-background divide-y divide-border/60 ${t}`,children:n})}function h({title:n,description:t,right:r,children:i,className:l=""}){return e.jsxs("div",{className:`p-3 ${l}`,children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"text-sm font-medium leading-5",children:n}),t?e.jsx("div",{className:"text-xs text-muted-foreground mt-1 leading-4",children:t}):null]}),r?e.jsx("div",{className:"shrink-0",children:r}):null]}),i?e.jsx("div",{className:"mt-2 min-w-0 text-sm text-foreground",children:i}):null]})}function w({label:n,value:t,description:r,className:i=""}){return e.jsx(h,{title:n,description:r,className:i,children:t})}function V(n){const t=$(["meg",n],`/klubb/${n}/bruker/meg`,{requireAuth:!0,enabled:!!n,staleTime:6e4}),r=S("patch",`/klubb/${n}/bruker/meg`,{onSuccess:()=>{f.success("Visningsnavn oppdatert"),t.refetch()},onError:d=>{f.error(d.message??"Kunne ikke oppdatere visningsnavn")}}),i=S("delete",`/klubb/${n}/bruker/meg`,{onSuccess:()=>f.success("Brukeren er slettet"),onError:d=>f.error(d.message??"Kunne ikke slette bruker")}),l=async()=>{if(!n)return;const d=await M.get(`/klubb/${n}/bruker/meg/egen-data`,{requireAuth:!0,responseType:"blob"}),a=d.data,u=d.headers?.["content-disposition"]?.match(/filename\*=UTF-8''([^;]+)|filename="?([^"]+)"?/i),x=decodeURIComponent(u?.[1]??u?.[2]??"")||`banebooking-data-${new Date().toISOString().slice(0,10)}.json`,s=URL.createObjectURL(a),o=document.createElement("a");o.href=s,o.download=x,document.body.appendChild(o),o.click(),o.remove(),URL.revokeObjectURL(s)};return{bruker:t.data,laster:t.isLoading,error:t.error,refetch:t.refetch,lastNedEgenData:l,oppdaterVisningsnavn:r,slettMeg:i}}const j=50,Y=/^[\p{L}\d\s.@'_%+-]{2,}$/u;function Z({slug:n}){const{bruker:t,laster:r,oppdaterVisningsnavn:i}=V(n),{mutateAsync:l,isPending:d}=i,[a,c]=g.useState("epost"),[u,v]=g.useState(""),[x,s]=g.useState(null);g.useEffect(()=>{if(!t)return;const m=t.visningsnavn?.trim();!m||m===t.epost?(c("epost"),v("")):(c("navn"),v(m)),s(null)},[t]);const o=g.useMemo(()=>t?a==="epost"?t.epost:u.trim():"",[t,a,u]),p=g.useMemo(()=>{if(!t)return"Ukjent feil.";if(a==="epost")return null;const m=u.trim();return m.length===0?"Visningsnavn kan ikke være tomt.":m.length<3?"Visningsnavn må være minst 3 tegn.":Y.test(m)?m.length>j?`Visningsnavn kan ikke være lengre enn ${j} tegn.`:null:"Visningsnavn inneholder ugyldige tegn."},[t,a,u]),T=g.useMemo(()=>{if(!t)return!1;const m=o,N=(t.visningsnavn??"").trim();return m.length===0||m===N?!1:a==="navn"?!p:!0},[t,o,a,p]);async function b(){t&&(s(p),!p&&await l({visningsnavn:o}))}return r||!t?e.jsx(A,{}):e.jsxs("div",{className:"space-y-4",children:[e.jsx(k,{title:"Min profil",description:"Velg hva som vises som navnet ditt i appen.",children:e.jsxs(y,{children:[e.jsx(h,{title:"Visningsnavn",description:"Velg e-post eller et eget navn.",children:e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"flex items-center gap-2 text-sm cursor-pointer select-none",children:[e.jsx("input",{type:"radio",name:"visningsnavn-mode",checked:a==="epost",onChange:()=>{c("epost"),s(null)}}),e.jsxs("span",{children:["E-post (",t.epost,")"]})]}),e.jsxs("label",{className:"flex items-center gap-2 text-sm cursor-pointer select-none",children:[e.jsx("input",{type:"radio",name:"visningsnavn-mode",checked:a==="navn",onChange:()=>{c("navn"),s(null)}}),e.jsx("span",{children:"Eget navn"})]})]})}),a==="navn"?e.jsx(h,{title:"Eget navn",description:`Maks ${j} tegn.`,children:e.jsx(I,{id:"visningsnavn",label:"Eget navn",hideLabel:!0,value:u,error:x,onChange:m=>{v(m.target.value),x&&s(null)},inputProps:{placeholder:"f.eks. Ola Nordmann",maxLength:j}})}):null,e.jsx(h,{title:"Dette vil lagres",description:"Slik vil navnet ditt vises.",right:e.jsx(D,{type:"button",size:"sm",disabled:!T||d,onClick:()=>void b(),children:d?"Lagrer...":"Lagre"}),children:e.jsx("div",{className:"text-sm text-foreground break-words",children:o})})]})}),e.jsx(k,{title:"Konto",description:"Denne informasjonen kan bare endres av klubbadministrator.",children:e.jsxs(y,{children:[e.jsx(w,{label:"Brukernavn / ID",value:t.epost}),e.jsx(w,{label:"Tilgang",value:t.roller.join(", ")})]})})]})}function ee({slettMeg:n}){const{signOut:t}=B(),[r,i]=g.useState(!1),l=async()=>{try{await n.mutateAsync(),i(!1),await t()}catch{}};return e.jsxs(O,{open:r,onOpenChange:i,children:[e.jsx(U,{asChild:!0,children:e.jsx(D,{variant:"destructive",disabled:n.isPending,children:n.isPending?"Sletter...":"Slett min bruker"})}),e.jsxs(q,{children:[e.jsxs(Q,{children:[e.jsx(z,{children:"Er du sikker?"}),e.jsx(_,{children:"Dette vil slette din bruker og all tilknytning permanent. Denne handlingen kan ikke angres."})]}),e.jsxs(G,{children:[e.jsx(X,{disabled:n.isPending,children:"Avbryt"}),e.jsx(J,{variant:"destructive",onClick:l,disabled:n.isPending,children:n.isPending?"Sletter...":"Slett bruker"})]})]})]})}function ne({slug:n}){const{bruker:t,laster:r,lastNedEgenData:i,slettMeg:l}=V(n),{isPending:d}=l;if(r||!t)return e.jsx(A,{});const a=t.vilkaarAkseptertDato?`Akseptert ${P(t.vilkaarAkseptertDato)}${t.vilkaarVersjon?` (versjon ${t.vilkaarVersjon})`:""}`:"Ikke registrert";return e.jsxs("div",{className:"space-y-4",children:[e.jsx(k,{title:"Persondata",description:"Her kan du se vilkår og laste ned egne data.",children:e.jsxs(y,{children:[e.jsx(w,{label:"Vilkår",description:"Vilkårene aksepteres automatisk ved første innlogging.",value:a}),e.jsx(h,{title:"Les vilkårene",description:"Åpnes i ny fane.",right:e.jsx(K,{to:`/${n}/vilkaar`,className:"text-sm underline text-primary hover:text-primary/80",target:"_blank",rel:"noopener noreferrer",children:"Åpne"})}),e.jsx(h,{title:"Last ned dine data",description:"JSON med registrerte opplysninger og bookinger.",right:e.jsx(D,{onClick:i,size:"sm",variant:"outline",disabled:d,children:d?"Laster...":"Last ned"})})]})}),e.jsx(k,{title:"Slett bruker",description:"Sletter bruker og all tilknyttet data permanent.",children:e.jsx(y,{children:e.jsx(h,{title:"",description:"Dette kan ikke angres.",right:e.jsx(ee,{slettMeg:l})})})})]})}function te(n,t=!1){const r=$(["mineBookinger",n,t],`/klubb/${n}/bookinger/mine${t?"?inkluderHistoriske=true":""}`,{requireAuth:!0,enabled:!!n,staleTime:6e4}),i=g.useRef(!1);return g.useEffect(()=>{if(!r.error){i.current=!1;return}i.current||(f.error(r.error.message??"Ukjent feil ved henting av bookinger"),i.current=!0)},[r.error]),r}function se(n){const t=R(),r=n??"",i=()=>{t.invalidateQueries({queryKey:["mineBookinger",r]}),t.invalidateQueries({queryKey:["bookinger",r]})},l=S("delete",`/klubb/${n}/bookinger`,{onError:c=>{f.error(c.message??"Kunne ikke avbestille.")},onSuccess:()=>{f.info("Bookingen er avbestilt.")},onSettled:()=>{i()}});return{avbestill:c=>{if(!n){f.error("Mangler klubb (slug).");return}l.mutate(c)},avbestillAsync:async c=>{if(!n){f.error("Mangler klubb (slug).");return}return l.mutateAsync(c)},isPending:l.isPending}}function re({slug:n}){const[t,r]=g.useState(!1),{data:i=[],isLoading:l}=te(n,t),{avbestillAsync:d,isPending:a}=se(n),[c,u]=g.useState(null),v=g.useMemo(()=>[...i].sort((s,o)=>{const p=new Date(o.dato).getTime()-new Date(s.dato).getTime();return p!==0?p:o.startTid.localeCompare(s.startTid)}),[i]);async function x(s){a||(await d({baneId:s.baneId,dato:s.dato,startTid:s.startTid,sluttTid:s.sluttTid}),u(null))}return l?e.jsx(A,{}):e.jsx("div",{className:"space-y-4",children:e.jsx(k,{title:"Bookinger",description:"Se kommende bookinger og velg om du vil inkludere tidligere.",children:e.jsxs("div",{className:"space-y-3",children:[e.jsx(H,{title:"Vis også tidligere bookinger",description:"Inkluder bookinger som allerede er gjennomført.",checked:t,onCheckedChange:s=>{r(s),u(null)}}),v.length===0?e.jsx("div",{className:"text-sm text-muted-foreground italic",children:t?"Du har ingen registrerte bookinger.":"Du har ingen kommende bookinger."}):e.jsx("div",{children:v.map(s=>{const o=`${s.baneId}-${s.dato}-${s.startTid}-${s.sluttTid}`,p=c===o,b=s.kanAvbestille&&!s.erPassert,m=()=>{b&&u(N=>N===o?null:o)};return e.jsx(ie,{slot:s,isOpen:p,erInteraktiv:b,onToggle:m,onCancel:()=>void x(s),isPending:a},o)})})]})})})}function ie({slot:n,isOpen:t,erInteraktiv:r,onToggle:i,onCancel:l,isPending:d}){const a=`${n.startTid.slice(0,2)}-${n.sluttTid.slice(0,2)}`,c=typeof n.temperatur=="number",u=typeof n.vind=="number",v=!!n.værSymbol||c||u,x=["border rounded shadow-sm p-2 mb-2","transition-colors duration-300 ease-in-out",n.erPassert?"bg-gray-100 text-gray-400":"",n.erPassert?"":"bg-white text-gray-900"].join(" ");return e.jsxs("div",{className:x,style:{cursor:r?"pointer":"default",opacity:n.erPassert?.5:1},onClick:s=>{s.target.closest("button, input, label")||i()},role:r?"button":void 0,tabIndex:r?0:void 0,onKeyDown:s=>{r&&(s.key==="Enter"||s.key===" ")&&(s.preventDefault(),i())},children:[e.jsx("div",{className:"flex items-center",children:e.jsxs("div",{className:"flex flex-1 items-center justify-between min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-1 text-xs text-muted-foreground whitespace-nowrap",children:[e.jsx("span",{children:P(n.dato)}),v?e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"w-[18px] h-[18px] flex items-center justify-center",children:n.værSymbol?e.jsx("img",{src:`/banebooking-voyager-fe/weather-symbols/svg/${n.værSymbol}.svg`,alt:n.værSymbol,width:14,height:14,className:"select-none",draggable:!1}):e.jsx("span",{className:"invisible",children:"."})}),c||u?e.jsxs("span",{className:"text-[11px] text-muted-foreground",children:[c?`${n.temperatur}°`:null,c&&u?" / ":null,u?`${n.vind} m/s`:null]}):null]}):null]}),e.jsx("div",{className:"whitespace-nowrap font-semibold text-sm text-right",children:a}),e.jsx("div",{className:"min-w-0 text-sm whitespace-nowrap truncate",title:n.baneNavn,children:n.baneNavn})]}),r?e.jsx("div",{className:"p-1 shrink-0",children:e.jsx(F,{size:12,style:{transform:t?"rotate(180deg)":"rotate(0deg)",transition:"transform 0.2s"},"aria-hidden":"true"})}):e.jsx("div",{className:"p-1 shrink-0"})]})}),t&&!n.erPassert&&e.jsx("div",{className:"mt-1",children:e.jsx("div",{className:"bg-inherit flex justify-end",children:e.jsx("div",{className:d?"pointer-events-none opacity-60":"",children:e.jsx(W,{slot:n,onCancel:()=>l(),reset:()=>{}})})})})]})}function je(){const[n,t]=g.useState("bookinger"),r=C();return e.jsx(L,{children:e.jsx(E,{items:[{value:"bookinger",label:"Mine bookinger",content:e.jsx(re,{slug:r})},{value:"profil",label:"Min profil",content:e.jsx(Z,{slug:r})},{value:"persondata",label:"Persondata",content:e.jsx(ne,{slug:r})}],value:n,onValueChange:t})})}export{je as default};
