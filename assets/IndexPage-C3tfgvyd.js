import{j as s,r as m}from"./shadcn-mOdBhBu9.js";import{f as j,D as S}from"./DatoVelger-BcD7jgms.js";import{B}from"./BookingSlotItem-BGmTwMsy.js";import{L as D,u as Q,a as M,b as A,t as p,c as T,d as E,e as $,B as L}from"./index-hr9clJP0.js";import{u as I}from"./useBaner-CvlJ00nH.js";import{P as C}from"./Page-35IgWQlu.js";import{S as N}from"./SimpleTabsLazy-B3CEy7cV.js";import{D as K,a as w,b as O,c as R,d as V,e as q}from"./dialog-ChqOtoyS.js";import{a as P}from"./lucide-ByENZzyU.js";import"./react-RGnvvjkK.js";import"./checkbox-LQEeYbeR.js";import"./index-Bb2dXpgu.js";import"./index-BRMy6Ggk.js";function _({slots:n,currentUser:l,onBook:a,onCancel:t,onDelete:c,apenSlotTid:f,setApenSlotTid:r,isLoading:b=!1}){return b?s.jsx(D,{}):n.length===0?s.jsx("div",{className:"text-muted text-sm italic py-4 text-center",children:"Ingen bookinger eller slots � vise."}):s.jsx("div",{className:"space-y-2",children:n.map(u=>{const g=`${u.dato}-${u.startTid}-${u.baneId}`;return s.jsx(B,{slot:u,currentUser:l,onBook:a,onCancel:t,onDelete:c,isOpen:f===g,onToggle:()=>r?.(f===g?null:g)},g)})})}function z(n,l){const a=Q(),t=M(),[c,f]=m.useState(null),r=["bookinger",a,l,n],b=!!l&&!!n,u=A(r,`/klubb/${a}/bookinger?baneId=${l}&dato=${n}`,{requireAuth:!0,enabled:b,staleTime:0,refetchInterval:3e4,refetchOnWindowFocus:!0,refetchIntervalInBackground:!1,placeholderData:[]}),g=m.useRef(!1);m.useEffect(()=>{if(!u.error){g.current=!1;return}g.current||(p.error(u.error.message??"Kunne ikke hente bookinger"),g.current=!0)},[u.error]);const k=()=>{t.invalidateQueries({queryKey:r}),t.invalidateQueries({queryKey:["mineBookinger",a]})},v=(e,i)=>e.startTid===i.startTid&&e.sluttTid===i.sluttTid,h=T("post",`/klubb/${a}/bookinger`,{onMutate:async e=>{await t.cancelQueries({queryKey:r});const i=t.getQueryData(r);return t.setQueryData(r,(o=[])=>o.map(d=>v(d,e)?{...d,booketAv:"Du",erEier:!0,kanBookes:!1,kanAvbestille:!0}:d)),{previous:i}},onError:(e,i,o)=>{o?.previous&&t.setQueryData(r,o.previous),p.error(e.message??"Kunne ikke booke.")},onSuccess:(e,i)=>{const o=`${i.startTid.slice(0,2)}-${i.sluttTid.slice(0,2)}`;p.success(`Booket ${o}`)},onSettled:()=>{k()}}),x=T("delete",`/klubb/${a}/bookinger`,{onMutate:async e=>{await t.cancelQueries({queryKey:r});const i=t.getQueryData(r);return t.setQueryData(r,(o=[])=>o.map(d=>v(d,e)?{...d,booketAv:null,erEier:!1,kanBookes:!0,kanAvbestille:!1,kanSlette:!1}:d)),{previous:i}},onError:(e,i,o)=>{o?.previous&&t.setQueryData(r,o.previous),p.error(e.message??"Kunne ikke avbestille.")},onSuccess:()=>{p.info("Bookingen er avbestilt.")},onSettled:()=>{k()}}),y=T("delete",`/klubb/${a}/bookinger/admin`,{onMutate:async e=>{await t.cancelQueries({queryKey:r});const i=t.getQueryData(r);return t.setQueryData(r,(o=[])=>o.map(d=>v(d,e)?{...d,booketAv:null,erEier:!1,kanBookes:!0,kanAvbestille:!1,kanSlette:!1}:d)),{previous:i}},onError:(e,i,o)=>{o?.previous&&t.setQueryData(r,o.previous),p.error(e.message??"Kunne ikke slette booking.")},onSuccess:()=>{p.success("Booking slettet"),f(null)},onSettled:()=>{k()}});return{slots:u.data??[],isLoading:u.isLoading,apenSlotTid:c,setApenSlotTid:f,onBook:e=>h.mutate({baneId:l,dato:n,startTid:e.startTid,sluttTid:e.sluttTid}),onCancel:e=>x.mutate({baneId:l,dato:n,startTid:e.startTid,sluttTid:e.sluttTid}),onDelete:e=>y.mutate({baneId:e.baneId??l,dato:e.dato??n,startTid:e.startTid,sluttTid:e.sluttTid}),hentBookinger:u.refetch}}function F({children:n}){const{data:l,isLoading:a}=E();if(a||!l)return null;const{bookingRegel:t}=l;return s.jsxs(K,{children:[s.jsx(w,{asChild:!0,children:n}),s.jsxs(O,{children:[s.jsxs(R,{children:[s.jsx(V,{children:"Bookingregler"}),s.jsx(q,{className:"sr-only",children:"Oversikt over bookingreglene i klubben"})]}),s.jsx("div",{className:"space-y-4",children:s.jsxs("ul",{className:"list-disc list-inside text-sm",children:[s.jsxs("li",{children:["Maks ",t.maksPerDag," bookinger per dag"]}),s.jsxs("li",{children:["Maks ",t.maksTotalt," aktive bookinger totalt"]}),s.jsxs("li",{children:["Opptil ",t.dagerFremITid," dager frem i tid"]}),s.jsxs("li",{children:[t.slotLengdeMinutter," minutter per booking"]}),s.jsxs("li",{children:["Tillatt mellom ",t.aapningstid,"–",t.stengetid]})]})})]})]})}function ne(){const{baner:n,isLoading:l}=I(!1),[a,t]=m.useState(""),[c,f]=m.useState(new Date),{currentUser:r}=$(),b=m.useMemo(()=>c?j(c,"yyyy-MM-dd"):"",[c]),{slots:u,apenSlotTid:g,setApenSlotTid:k,onBook:v,onCancel:h,onDelete:x,isLoading:y}=z(b,a);return m.useEffect(()=>{!a&&n.length>0&&t(n[0].id)},[n,a]),m.useEffect(()=>{k(null)},[c,a,k]),m.useEffect(()=>{r||k(null)},[r,k]),m.useEffect(()=>{c&&localStorage.setItem("valgtDato",c.toISOString())},[c]),l||!a?s.jsx(D,{}):s.jsxs(C,{children:[s.jsxs("div",{className:"flex justify-between items-center mb-2",children:[s.jsx(F,{children:s.jsx(L,{variant:"ghost",size:"icon",className:"rounded-full",title:"Vis banereglement",children:s.jsx(P,{className:"w-5 h-5"})})}),s.jsx(S,{value:c,onChange:e=>f(e??null),visNavigering:!0})]}),s.jsx(N,{items:n.map(e=>({value:e.id,label:e.navn,content:s.jsx(_,{slots:u,currentUser:r?{epost:r.email??""}:null,apenSlotTid:g,setApenSlotTid:k,onBook:v,onCancel:h,onDelete:x,isLoading:y})})),value:a,onValueChange:t})]})}export{ne as default};
